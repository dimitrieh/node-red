/**
 * Mobile Workflow Enhancements for Node-RED
 * Optimizes node editing, connections, and flow creation for mobile/tablet
 */

(function() {
    'use strict';

    let workflowState = {
        dragMode: 'none', // 'none', 'node', 'connection', 'selection'
        selectedNode: null,
        connectionMode: false,
        connectionSource: null,
        touchStartTime: 0,
        touchStartPos: { x: 0, y: 0 },
        lastTouchPos: { x: 0, y: 0 },
        workspaceScale: 1,
        workspaceOffset: { x: 0, y: 0 }
    };

    function initializeMobileWorkflow() {
        if (document.querySelector('.red-ui-mobile, .red-ui-tablet')) {
            setupEnhancedNodeInteractions();
            setupConnectionAssist();
            setupMobileContextMenu();
            setupWorkspaceNavigation();
            
            console.log('Mobile workflow enhancements initialized');
        }
    }

    // Enhanced node interactions for touch
    function setupEnhancedNodeInteractions() {
        const workspace = document.getElementById('red-ui-workspace-chart');
        if (!workspace) return;

        // Long press for node selection/context menu
        let longPressTimer = null;
        let isDragging = false;
        
        workspace.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            workflowState.touchStartTime = Date.now();
            workflowState.touchStartPos = { x: touch.clientX, y: touch.clientY };
            workflowState.lastTouchPos = { x: touch.clientX, y: touch.clientY };
            isDragging = false;

            const node = findNodeAtPosition(touch.clientX, touch.clientY);
            if (node) {
                workflowState.selectedNode = node;
                
                // Start long press timer for context menu
                longPressTimer = setTimeout(() => {
                    if (!isDragging) {
                        showMobileNodeMenu(node, touch.clientX, touch.clientY);
                        if ('vibrate' in navigator) {
                            navigator.vibrate(50);
                        }
                    }
                }, 500);
            }
        }, { passive: false });

        workspace.addEventListener('touchmove', (e) => {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }

            const touch = e.touches[0];
            const deltaX = touch.clientX - workflowState.touchStartPos.x;
            const deltaY = touch.clientY - workflowState.touchStartPos.y;
            
            if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                isDragging = true;
            }

            workflowState.lastTouchPos = { x: touch.clientX, y: touch.clientY };
        });

        workspace.addEventListener('touchend', (e) => {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }

            const touchDuration = Date.now() - workflowState.touchStartTime;
            
            // Short tap for selection
            if (touchDuration < 200 && !isDragging) {
                const node = findNodeAtPosition(
                    workflowState.touchStartPos.x,
                    workflowState.touchStartPos.y
                );
                
                if (node) {
                    selectNode(node);
                } else {
                    // Tap on empty space - deselect all
                    deselectAllNodes();
                }
            }

            isDragging = false;
            workflowState.selectedNode = null;
        });
    }

    // Connection assistance for touch devices
    function setupConnectionAssist() {
        // Enhanced port visibility
        const style = document.createElement('style');
        style.textContent = `
            .red-ui-mobile .red-ui-flow-port,
            .red-ui-tablet .red-ui-flow-port {
                min-width: 16px !important;
                min-height: 16px !important;
                border: 2px solid var(--red-ui-port-border, #999) !important;
                border-radius: 50% !important;
                background: var(--red-ui-port-background, #fff) !important;
            }
            
            .red-ui-mobile .red-ui-flow-port:hover,
            .red-ui-tablet .red-ui-flow-port:hover,
            .red-ui-touch .red-ui-flow-port.port-highlighted {
                border-color: var(--red-ui-port-selected, #ff7f0e) !important;
                border-width: 3px !important;
                transform: scale(1.2) !important;
                box-shadow: 0 0 8px rgba(255, 127, 14, 0.5) !important;
            }
            
            .red-ui-mobile .connection-guide,
            .red-ui-tablet .connection-guide {
                position: absolute;
                pointer-events: none;
                z-index: 1000;
                background: var(--red-ui-port-selected, #ff7f0e);
                opacity: 0.7;
                border-radius: 2px;
            }
        `;
        document.head.appendChild(style);

        // Connection mode toggle
        createConnectionModeToggle();
    }

    function createConnectionModeToggle() {
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'mobile-connection-toggle';
        toggleBtn.innerHTML = 'ðŸ”—';
        toggleBtn.title = 'Toggle Connection Mode';
        toggleBtn.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 50%;
            background: var(--red-ui-primary-background, #fff);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1001;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: none;
        `;

        // Show only on mobile/tablet
        if (document.body.classList.contains('red-ui-mobile') || 
            document.body.classList.contains('red-ui-tablet')) {
            toggleBtn.style.display = 'flex';
            toggleBtn.style.alignItems = 'center';
            toggleBtn.style.justifyContent = 'center';
        }

        toggleBtn.addEventListener('click', () => {
            workflowState.connectionMode = !workflowState.connectionMode;
            toggleBtn.style.background = workflowState.connectionMode 
                ? 'var(--red-ui-deploy-button-color, #8f0000)' 
                : 'var(--red-ui-primary-background, #fff)';
            toggleBtn.style.color = workflowState.connectionMode ? 'white' : 'inherit';
            
            document.body.classList.toggle('connection-mode', workflowState.connectionMode);
            
            if (workflowState.connectionMode) {
                highlightAllPorts();
            } else {
                hideAllPortHighlights();
            }
        });

        document.body.appendChild(toggleBtn);
    }

    // Mobile context menu
    function setupMobileContextMenu() {
        let currentMenu = null;

        window.showMobileNodeMenu = function(node, x, y) {
            hideMobileMenu();

            currentMenu = document.createElement('div');
            currentMenu.className = 'mobile-context-menu';
            currentMenu.style.cssText = `
                position: fixed;
                top: ${y + 10}px;
                left: ${x + 10}px;
                background: var(--red-ui-primary-background, #fff);
                border: 1px solid var(--red-ui-primary-border-color, #ccc);
                border-radius: 8px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                z-index: 2000;
                padding: 8px 0;
                min-width: 150px;
                max-width: 200px;
            `;

            const actions = [
                { icon: 'âœï¸', text: 'Edit', action: () => editNode(node) },
                { icon: 'ðŸ“‹', text: 'Copy', action: () => copyNode(node) },
                { icon: 'ðŸ”—', text: 'Connect', action: () => startConnection(node) },
                { icon: 'âŒ', text: 'Delete', action: () => deleteNode(node) }
            ];

            actions.forEach(actionItem => {
                const item = document.createElement('div');
                item.className = 'menu-item';
                item.style.cssText = `
                    padding: 12px 16px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-size: 16px;
                    transition: background 0.2s;
                `;
                
                item.innerHTML = `<span>${actionItem.icon}</span><span>${actionItem.text}</span>`;
                
                item.addEventListener('mouseenter', () => {
                    item.style.background = 'var(--red-ui-node-selected-color, rgba(0,123,255,0.1))';
                });
                
                item.addEventListener('mouseleave', () => {
                    item.style.background = 'none';
                });
                
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    actionItem.action();
                    hideMobileMenu();
                });

                currentMenu.appendChild(item);
            });

            document.body.appendChild(currentMenu);

            // Close menu on outside click
            setTimeout(() => {
                document.addEventListener('click', hideMobileMenu);
                document.addEventListener('touchstart', hideMobileMenu);
            }, 100);
        };

        function hideMobileMenu() {
            if (currentMenu) {
                currentMenu.remove();
                currentMenu = null;
                document.removeEventListener('click', hideMobileMenu);
                document.removeEventListener('touchstart', hideMobileMenu);
            }
        }

        window.hideMobileMenu = hideMobileMenu;
    }

    // Workspace navigation for mobile
    function setupWorkspaceNavigation() {
        // Enhanced zoom controls for mobile
        createMobileZoomControls();
        setupTouchGestures();
    }

    function createMobileZoomControls() {
        const zoomControls = document.createElement('div');
        zoomControls.className = 'mobile-zoom-controls';
        zoomControls.style.cssText = `
            position: fixed;
            bottom: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1001;
        `;

        const zoomIn = createZoomButton('+', 'Zoom In', () => {
            if (window.RED && RED.view) {
                RED.view.scale(RED.view.scale() * 1.2, [0, 0]);
            }
        });

        const zoomOut = createZoomButton('âˆ’', 'Zoom Out', () => {
            if (window.RED && RED.view) {
                RED.view.scale(RED.view.scale() * 0.8, [0, 0]);
            }
        });

        const zoomFit = createZoomButton('â—Ž', 'Fit to View', () => {
            if (window.RED && RED.view) {
                RED.view.focus();
            }
        });

        [zoomIn, zoomOut, zoomFit].forEach(btn => zoomControls.appendChild(btn));
        
        // Show only on mobile/tablet
        if (document.body.classList.contains('red-ui-mobile') || 
            document.body.classList.contains('red-ui-tablet')) {
            document.body.appendChild(zoomControls);
        }
    }

    function createZoomButton(text, title, onClick) {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.title = title;
        btn.style.cssText = `
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: var(--red-ui-primary-background, #fff);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

        btn.addEventListener('click', onClick);
        return btn;
    }

    function setupTouchGestures() {
        const workspace = document.getElementById('red-ui-workspace-chart');
        if (!workspace || !window.RED) return;

        let initialDistance = 0;
        let initialScale = 1;
        
        workspace.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                // Two finger gesture - prepare for pinch zoom
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                initialDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                if (RED.view) {
                    initialScale = RED.view.scale();
                }
            }
        });

        workspace.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2 && RED.view) {
                e.preventDefault();
                
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                const scale = initialScale * (currentDistance / initialDistance);
                const center = [
                    (touch1.clientX + touch2.clientX) / 2,
                    (touch1.clientY + touch2.clientY) / 2
                ];
                
                RED.view.scale(Math.max(0.1, Math.min(3, scale)), center);
            }
        }, { passive: false });
    }

    // Utility functions
    function findNodeAtPosition(x, y) {
        const elements = document.elementsFromPoint(x, y);
        for (let element of elements) {
            if (element.classList.contains('red_ui_flow_node') ||
                element.closest('.red_ui_flow_node')) {
                return element.closest('.red_ui_flow_node') || element;
            }
        }
        return null;
    }

    function selectNode(node) {
        // Remove previous selections
        document.querySelectorAll('.red_ui_flow_node_selected')
                .forEach(n => n.classList.remove('red_ui_flow_node_selected'));
        
        // Select the node
        node.classList.add('red_ui_flow_node_selected');
        
        // Visual feedback for mobile
        if ('vibrate' in navigator) {
            navigator.vibrate(10);
        }
    }

    function deselectAllNodes() {
        document.querySelectorAll('.red_ui_flow_node_selected')
                .forEach(n => n.classList.remove('red_ui_flow_node_selected'));
    }

    function editNode(node) {
        if (window.RED && RED.editor) {
            const nodeData = RED.nodes.get(node.id);
            if (nodeData) {
                RED.editor.showEditDialog(nodeData);
            }
        }
    }

    function copyNode(node) {
        if (window.RED && RED.clipboard) {
            const nodeData = RED.nodes.get(node.id);
            if (nodeData) {
                RED.clipboard.copyText(JSON.stringify([nodeData]));
            }
        }
    }

    function deleteNode(node) {
        if (window.RED && RED.nodes) {
            const nodeData = RED.nodes.get(node.id);
            if (nodeData) {
                RED.nodes.remove(nodeData);
                RED.view.redraw();
            }
        }
    }

    function startConnection(node) {
        workflowState.connectionMode = true;
        workflowState.connectionSource = node;
        highlightAllPorts();
    }

    function highlightAllPorts() {
        document.querySelectorAll('.red-ui-flow-port').forEach(port => {
            port.classList.add('port-highlighted');
        });
    }

    function hideAllPortHighlights() {
        document.querySelectorAll('.red-ui-flow-port').forEach(port => {
            port.classList.remove('port-highlighted');
        });
    }

    // Initialize when DOM is ready
    function initialize() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeMobileWorkflow);
        } else {
            // Add delay to ensure other components are ready
            setTimeout(initializeMobileWorkflow, 1000);
        }
    }

    // Public API
    window.RED = window.RED || {};
    window.RED.mobileWorkflow = {
        init: initialize,
        getState: () => ({ ...workflowState }),
        toggleConnectionMode: () => {
            const toggle = document.querySelector('.mobile-connection-toggle');
            if (toggle) toggle.click();
        }
    };

    initialize();

})();