/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindows = (function() {
    
    var activeWindow = null;
    var windowStack = [];
    var windowDefaults = {
        draggable: true,
        resizable: true,
        closable: true,
        minimizable: true
    };

    function createFloatingWindow(content, title, options) {
        options = $.extend({}, windowDefaults, options);
        
        var windowElement = $('<div class="red-ui-floating-window">');
        if (options.className) {
            windowElement.addClass(options.className);
        }
        
        // Create header
        var header = $('<div class="red-ui-floating-window-header">');
        var titleElement = $('<span class="red-ui-floating-window-title">').text(title);
        var controls = $('<div class="red-ui-floating-window-controls">');
        
        if (options.minimizable) {
            var minimizeBtn = $('<button type="button">').html('–');
            minimizeBtn.on('click', function() {
                minimizeWindow(windowElement);
            });
            controls.append(minimizeBtn);
        }
        
        if (options.closable) {
            var closeBtn = $('<button type="button">').html('×');
            closeBtn.on('click', function() {
                closeWindow(windowElement);
            });
            controls.append(closeBtn);
        }
        
        header.append(titleElement, controls);
        
        // Create content area
        var contentArea = $('<div class="red-ui-floating-window-content">');
        if (typeof content === 'string') {
            contentArea.html(content);
        } else {
            contentArea.append(content);
        }
        
        // Create resize handle
        var resizeHandle = $('<div class="red-ui-floating-window-resize red-ui-floating-window-resize-se">');
        
        windowElement.append(header, contentArea, resizeHandle);
        
        // Set initial position and size
        if (options.left !== undefined) windowElement.css('left', options.left);
        if (options.top !== undefined) windowElement.css('top', options.top);
        if (options.width !== undefined) windowElement.css('width', options.width);
        if (options.height !== undefined) windowElement.css('height', options.height);
        
        // Add to main container
        $("#red-ui-main-container").append(windowElement);
        
        // Make draggable
        if (options.draggable) {
            makeDraggable(windowElement);
        }
        
        // Make resizable
        if (options.resizable) {
            makeResizable(windowElement);
        }
        
        // Handle focus
        windowElement.on('mousedown', function() {
            bringToFront(windowElement);
        });
        
        // Add to window stack
        windowStack.push(windowElement);
        bringToFront(windowElement);
        
        return windowElement;
    }
    
    function makeDraggable(windowElement) {
        var header = windowElement.find('.red-ui-floating-window-header');
        var isDragging = false;
        var startX, startY, startLeft, startTop;
        
        header.on('mousedown', function(e) {
            if (e.target.tagName === 'BUTTON') return; // Don't drag on button clicks
            
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(windowElement.css('left'));
            startTop = parseInt(windowElement.css('top'));
            
            $('body').addClass('red-ui-dragging');
            e.preventDefault();
        });
        
        $(document).on('mousemove', function(e) {
            if (!isDragging) return;
            
            var deltaX = e.clientX - startX;
            var deltaY = e.clientY - startY;
            
            var newLeft = startLeft + deltaX;
            var newTop = startTop + deltaY;
            
            // Keep window within bounds
            var container = $("#red-ui-main-container");
            var containerWidth = container.width();
            var containerHeight = container.height();
            var windowWidth = windowElement.outerWidth();
            var windowHeight = windowElement.outerHeight();
            
            newLeft = Math.max(0, Math.min(newLeft, containerWidth - windowWidth));
            newTop = Math.max(0, Math.min(newTop, containerHeight - windowHeight));
            
            windowElement.css({
                left: newLeft,
                top: newTop
            });
        });
        
        $(document).on('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                $('body').removeClass('red-ui-dragging');
            }
        });
    }
    
    function makeResizable(windowElement) {
        var resizeHandle = windowElement.find('.red-ui-floating-window-resize-se');
        var isResizing = false;
        var startX, startY, startWidth, startHeight;
        
        resizeHandle.on('mousedown', function(e) {
            isResizing = true;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = windowElement.outerWidth();
            startHeight = windowElement.outerHeight();
            
            $('body').addClass('red-ui-resizing');
            e.preventDefault();
            e.stopPropagation();
        });
        
        $(document).on('mousemove', function(e) {
            if (!isResizing) return;
            
            var deltaX = e.clientX - startX;
            var deltaY = e.clientY - startY;
            
            var newWidth = Math.max(180, startWidth + deltaX);
            var newHeight = Math.max(200, startHeight + deltaY);
            
            windowElement.css({
                width: newWidth,
                height: newHeight
            });
        });
        
        $(document).on('mouseup', function() {
            if (isResizing) {
                isResizing = false;
                $('body').removeClass('red-ui-resizing');
            }
        });
    }
    
    function bringToFront(windowElement) {
        if (activeWindow) {
            activeWindow.removeClass('red-ui-floating-window-active');
        }
        
        windowElement.addClass('red-ui-floating-window-active');
        activeWindow = windowElement;
        
        // Update z-index
        var maxZ = 1000;
        windowStack.forEach(function(win) {
            if (win[0] !== windowElement[0]) {
                var currentZ = parseInt(win.css('z-index')) || 1000;
                if (currentZ > maxZ) maxZ = currentZ;
            }
        });
        
        windowElement.css('z-index', maxZ + 1);
    }
    
    function minimizeWindow(windowElement) {
        windowElement.toggleClass('red-ui-floating-window-minimized');
        if (windowElement.hasClass('red-ui-floating-window-minimized')) {
            windowElement.find('.red-ui-floating-window-content').hide();
            windowElement.css('height', '30px');
        } else {
            windowElement.find('.red-ui-floating-window-content').show();
            windowElement.css('height', '');
        }
    }
    
    function closeWindow(windowElement) {
        var index = windowStack.indexOf(windowElement);
        if (index > -1) {
            windowStack.splice(index, 1);
        }
        
        if (activeWindow && activeWindow[0] === windowElement[0]) {
            activeWindow = null;
        }
        
        windowElement.remove();
    }
    
    function saveWindowStates() {
        var states = {};
        windowStack.forEach(function(windowElement, index) {
            var id = windowElement.attr('data-window-id');
            if (id) {
                states[id] = {
                    left: parseInt(windowElement.css('left')),
                    top: parseInt(windowElement.css('top')),
                    width: windowElement.outerWidth(),
                    height: windowElement.outerHeight(),
                    minimized: windowElement.hasClass('red-ui-floating-window-minimized')
                };
            }
        });
        localStorage.setItem('node-red-floating-windows', JSON.stringify(states));
    }
    
    function loadWindowStates() {
        try {
            var states = JSON.parse(localStorage.getItem('node-red-floating-windows') || '{}');
            return states;
        } catch(e) {
            return {};
        }
    }
    
    function resetLayout() {
        localStorage.removeItem('node-red-floating-windows');
        // Close all floating windows and recreate with defaults
        windowStack.slice().forEach(function(windowElement) {
            closeWindow(windowElement);
        });
    }
    
    return {
        createFloatingWindow: createFloatingWindow,
        makeDraggable: makeDraggable,
        makeResizable: makeResizable,
        bringToFront: bringToFront,
        minimizeWindow: minimizeWindow,
        closeWindow: closeWindow,
        saveWindowStates: saveWindowStates,
        loadWindowStates: loadWindowStates,
        resetLayout: resetLayout
    };
})();