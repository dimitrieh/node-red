/**
 * Floating Windows Framework for Node-RED
 * Provides draggable/resizable floating windows functionality
 */

RED.floatingWindows = (function() {
    let activeWindow = null;
    let windowCounter = 0;
    const windows = {};
    
    /**
     * Creates a new floating window
     * @param {Object} options - Window configuration
     * @returns {Object} Window API
     */
    function createWindow(options) {
        const windowId = `floating-window-${++windowCounter}`;
        const defaults = {
            title: 'Floating Window',
            width: 300,
            height: 400,
            x: 100,
            y: 100,
            minWidth: 200,
            minHeight: 200,
            resizable: true,
            minimizable: true,
            className: ''
        };
        
        const config = Object.assign({}, defaults, options);
        
        // Create window container
        const $window = $(`
            <div id="${windowId}" class="red-ui-floating-window ${config.className}">
                <div class="red-ui-floating-window-header">
                    <span class="red-ui-floating-window-title">${config.title}</span>
                    <div class="red-ui-floating-window-controls">
                        ${config.minimizable ? '<button class="minimize-btn" title="Minimize"><i class="fa fa-minus"></i></button>' : ''}
                    </div>
                </div>
                <div class="red-ui-floating-window-content"></div>
                ${config.resizable ? '<div class="red-ui-floating-window-resize-handle"></div>' : ''}
            </div>
        `);
        
        // Append to main container
        $window.appendTo('#red-ui-main-container');
        
        // Set initial position and size
        $window.css({
            left: config.x + 'px',
            top: config.y + 'px',
            width: config.width + 'px',
            height: config.height + 'px'
        });
        
        // Add content
        if (config.content) {
            $window.find('.red-ui-floating-window-content').append(config.content);
        }
        
        // Make draggable
        $window.draggable({
            handle: '.red-ui-floating-window-header',
            containment: '#red-ui-main-container',
            start: function() {
                setActiveWindow(windowId);
            }
        });
        
        // Make resizable
        if (config.resizable) {
            $window.resizable({
                handles: 'se',
                minWidth: config.minWidth,
                minHeight: config.minHeight,
                start: function() {
                    setActiveWindow(windowId);
                }
            });
        }
        
        // Window focus handling
        $window.on('mousedown', function() {
            setActiveWindow(windowId);
        });
        
        // Minimize functionality
        $window.find('.minimize-btn').on('click', function(e) {
            e.stopPropagation();
            toggleMinimize(windowId);
        });
        
        // Create window API
        const windowAPI = {
            id: windowId,
            $element: $window,
            isMinimized: false,
            
            setTitle: function(title) {
                $window.find('.red-ui-floating-window-title').text(title);
            },
            
            setContent: function(content) {
                $window.find('.red-ui-floating-window-content').empty().append(content);
            },
            
            setPosition: function(x, y) {
                $window.css({ left: x + 'px', top: y + 'px' });
            },
            
            setSize: function(width, height) {
                $window.css({ width: width + 'px', height: height + 'px' });
            },
            
            minimize: function() {
                if (!this.isMinimized) {
                    toggleMinimize(windowId);
                }
            },
            
            restore: function() {
                if (this.isMinimized) {
                    toggleMinimize(windowId);
                }
            },
            
            destroy: function() {
                $window.remove();
                delete windows[windowId];
                if (activeWindow === windowId) {
                    activeWindow = null;
                }
            },
            
            focus: function() {
                setActiveWindow(windowId);
            }
        };
        
        windows[windowId] = windowAPI;
        setActiveWindow(windowId);
        
        return windowAPI;
    }
    
    function setActiveWindow(windowId) {
        if (activeWindow) {
            windows[activeWindow]?.$element.removeClass('floating-window-active');
        }
        
        activeWindow = windowId;
        if (windows[windowId]) {
            windows[windowId].$element.addClass('floating-window-active');
        }
    }
    
    function toggleMinimize(windowId) {
        const window = windows[windowId];
        if (!window) return;
        
        const $window = window.$element;
        
        if (window.isMinimized) {
            // Restore
            $window.removeClass('floating-window-minimized');
            window.isMinimized = false;
            $window.find('.minimize-btn i').removeClass('fa-plus').addClass('fa-minus');
        } else {
            // Minimize
            $window.addClass('floating-window-minimized');
            window.isMinimized = true;
            $window.find('.minimize-btn i').removeClass('fa-minus').addClass('fa-plus');
        }
    }
    
    /**
     * Initialize floating windows mode
     */
    function init() {
        // Add floating mode class to enable CSS overrides
        $('#red-ui-main-container').addClass('red-ui-floating-mode');
        
        // Initialize palette as floating window
        initPaletteFloating();
        
        // Initialize sidebar as floating window
        initSidebarFloating();
        
        // Initialize debug panel as separate floating window
        initDebugFloating();
    }
    
    function initPaletteFloating() {
        // Clone the palette content
        const $originalPalette = $('#red-ui-palette');
        const $paletteContent = $originalPalette.children().clone();
        
        // Create floating palette window
        const paletteWindow = createWindow({
            title: 'Node Palette',
            width: 200,
            height: Math.min(window.innerHeight * 0.9, 800),
            x: 20,
            y: 20,
            className: 'red-ui-floating-palette'
        });
        
        // Move cloned content to floating window
        paletteWindow.setContent($paletteContent);
        
        // Re-initialize palette functionality in the new location
        RED.palette.refresh();
    }
    
    function initSidebarFloating() {
        // Clone the entire sidebar content
        const $originalSidebar = $('#red-ui-sidebar');
        const $sidebarContent = $originalSidebar.children().clone();
        
        // Create floating sidebar window
        const sidebarWindow = createWindow({
            title: 'Sidebar',
            width: 320,
            height: Math.min(window.innerHeight * 0.9, 600),
            x: window.innerWidth - 340,
            y: 20,
            className: 'red-ui-floating-sidebar'
        });
        
        // Move cloned content to floating window but exclude debug content
        const $filteredContent = $sidebarContent.filter(function() {
            // Keep everything except debug-specific content
            return !$(this).attr('id') || !$(this).attr('id').includes('debug');
        });
        
        sidebarWindow.setContent($filteredContent);
    }
    
    function initDebugFloating() {
        // Find debug content in the original sidebar
        const $debugContent = $('#red-ui-sidebar-content').find('[id*="debug"]');
        if ($debugContent.length === 0) return;
        
        // Create floating debug window
        const debugWindow = createWindow({
            title: 'Debug',
            width: 360,
            height: Math.min(window.innerHeight * 0.6, 400),
            x: Math.max(220, window.innerWidth / 2 - 180),
            y: Math.max(20, window.innerHeight - 440),
            className: 'red-ui-floating-debug'
        });
        
        // Clone debug content
        const $clonedDebugContent = $debugContent.clone();
        debugWindow.setContent($clonedDebugContent);
    }
    
    /**
     * Disable floating windows mode and restore original layout
     */
    function disable() {
        // Remove floating mode class
        $('#red-ui-main-container').removeClass('red-ui-floating-mode');
        
        // Close all floating windows
        Object.values(windows).forEach(window => {
            window.destroy();
        });
    }
    
    // Public API
    return {
        init: init,
        disable: disable,
        createWindow: createWindow,
        getWindows: () => Object.values(windows),
        getActiveWindow: () => windows[activeWindow]
    };
})();