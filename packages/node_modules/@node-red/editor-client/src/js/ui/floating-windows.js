/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindows = (function() {
    var activeWindow = null;
    var windows = {};
    var zIndexCounter = 1000;

    function createFloatingWindow(options) {
        var windowId = options.id || 'floating-' + Date.now();
        var windowEl = $('<div class="red-ui-floating-window ' + (options.className || '') + '" id="' + windowId + '">');
        
        // Create header
        var header = $('<div class="red-ui-floating-window-header">');
        var title = $('<span class="red-ui-floating-window-title">').text(options.title || 'Window');
        var controls = $('<div class="red-ui-floating-window-controls">');
        
        var minimizeBtn = $('<button title="Minimize">âˆ’</button>');
        minimizeBtn.on('click', function() {
            toggleMinimize(windowEl);
        });
        
        controls.append(minimizeBtn);
        header.append(title, controls);
        
        // Create content area
        var content = $('<div class="red-ui-floating-window-content">');
        if (options.content) {
            content.append(options.content);
        }
        
        windowEl.append(header, content);
        
        // Set initial position and size
        windowEl.css({
            left: options.x || 20,
            top: options.y || 60,
            width: options.width || 300,
            height: options.height || 400
        });
        
        // Add to workspace
        $('#red-ui-workspace').append(windowEl);
        
        // Make draggable
        makeDraggable(windowEl, header);
        
        // Make resizable
        makeResizable(windowEl);
        
        // Window focus handling
        windowEl.on('mousedown', function() {
            setActiveWindow(windowEl);
        });
        
        // Store window reference
        windows[windowId] = {
            element: windowEl,
            options: options,
            minimized: false
        };
        
        setActiveWindow(windowEl);
        
        return {
            id: windowId,
            element: windowEl,
            content: content,
            setTitle: function(title) {
                windowEl.find('.red-ui-floating-window-title').text(title);
            },
            setSize: function(width, height) {
                windowEl.css({ width: width, height: height });
            },
            setPosition: function(x, y) {
                windowEl.css({ left: x, top: y });
            },
            minimize: function() {
                toggleMinimize(windowEl);
            },
            destroy: function() {
                windowEl.remove();
                delete windows[windowId];
            }
        };
    }
    
    function makeDraggable(windowEl, handle) {
        var isDragging = false;
        var currentX, currentY, initialX, initialY;
        
        handle.on('mousedown', function(e) {
            if (e.target.tagName === 'BUTTON') return; // Don't drag if clicking controls
            
            isDragging = true;
            initialX = e.clientX - parseInt(windowEl.css('left'), 10);
            initialY = e.clientY - parseInt(windowEl.css('top'), 10);
            
            $(document).on('mousemove.floating-drag', function(e) {
                if (isDragging) {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    // Keep within workspace bounds
                    var workspace = $('#red-ui-workspace');
                    var workspaceRect = workspace[0].getBoundingClientRect();
                    var windowRect = windowEl[0].getBoundingClientRect();
                    
                    currentX = Math.max(0, Math.min(currentX, workspaceRect.width - windowRect.width));
                    currentY = Math.max(0, Math.min(currentY, workspaceRect.height - 32)); // Keep header visible
                    
                    windowEl.css({ left: currentX + 'px', top: currentY + 'px' });
                }
            });
            
            $(document).on('mouseup.floating-drag', function() {
                isDragging = false;
                $(document).off('.floating-drag');
            });
            
            e.preventDefault();
        });
    }
    
    function makeResizable(windowEl) {
        var isResizing = false;
        var startX, startY, startWidth, startHeight;
        
        windowEl.on('mousedown', function(e) {
            var rect = windowEl[0].getBoundingClientRect();
            var offsetX = e.clientX - rect.left;
            var offsetY = e.clientY - rect.top;
            
            // Check if click is in resize handle area (bottom-right 12px)
            if (offsetX > rect.width - 12 && offsetY > rect.height - 12) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = rect.width;
                startHeight = rect.height;
                
                $(document).on('mousemove.floating-resize', function(e) {
                    if (isResizing) {
                        var newWidth = startWidth + (e.clientX - startX);
                        var newHeight = startHeight + (e.clientY - startY);
                        
                        newWidth = Math.max(200, newWidth);
                        newHeight = Math.max(150, newHeight);
                        
                        windowEl.css({ width: newWidth + 'px', height: newHeight + 'px' });
                    }
                });
                
                $(document).on('mouseup.floating-resize', function() {
                    isResizing = false;
                    $(document).off('.floating-resize');
                });
                
                e.preventDefault();
                e.stopPropagation();
            }
        });
    }
    
    function setActiveWindow(windowEl) {
        $('.red-ui-floating-window').removeClass('active');
        windowEl.addClass('active');
        windowEl.css('z-index', ++zIndexCounter);
        activeWindow = windowEl;
    }
    
    function toggleMinimize(windowEl) {
        var windowData = windows[windowEl.attr('id')];
        if (windowData.minimized) {
            // Restore
            windowEl.removeClass('minimized');
            windowEl.css('height', windowData.originalHeight || '400px');
            windowData.minimized = false;
        } else {
            // Minimize
            windowData.originalHeight = windowEl.css('height');
            windowEl.addClass('minimized');
            windowData.minimized = true;
        }
    }
    
    function enableFloatingMode() {
        $('body').addClass('red-ui-floating-mode');
    }
    
    function disableFloatingMode() {
        $('body').removeClass('red-ui-floating-mode');
    }
    
    return {
        create: createFloatingWindow,
        enableFloatingMode: enableFloatingMode,
        disableFloatingMode: disableFloatingMode,
        getActiveWindow: function() { return activeWindow; },
        getAllWindows: function() { return windows; }
    };
})();