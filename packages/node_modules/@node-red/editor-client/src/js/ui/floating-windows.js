/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindows = (function() {
    
    var windows = {};
    var isDragging = false;
    var isResizing = false;
    var dragTarget = null;
    var resizeTarget = null;
    var startX, startY, startLeft, startTop, startWidth, startHeight;
    var zIndex = 1000;
    
    function makeWindowDraggable(windowElement, titleBarElement) {
        var $window = $(windowElement);
        var $titleBar = $(titleBarElement);
        
        $titleBar.on('mousedown', function(e) {
            if ($(e.target).hasClass('control-button')) {
                return; // Don't drag when clicking control buttons
            }
            
            isDragging = true;
            dragTarget = $window[0];
            startX = e.clientX;
            startY = e.clientY;
            
            var rect = dragTarget.getBoundingClientRect();
            startLeft = rect.left;
            startTop = rect.top;
            
            // Bring to front
            $window.css('z-index', ++zIndex);
            
            e.preventDefault();
        });
    }
    
    function makeWindowResizable(windowElement) {
        var $window = $(windowElement);
        
        // Add resize handles
        var handles = ['n', 'ne', 'e', 'se', 's', 'sw', 'w', 'nw'];
        handles.forEach(function(handle) {
            var $handle = $('<div class="resize-handle resize-' + handle + '"></div>');
            $window.append($handle);
            
            $handle.on('mousedown', function(e) {
                isResizing = true;
                resizeTarget = $window[0];
                startX = e.clientX;
                startY = e.clientY;
                
                var rect = resizeTarget.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                startWidth = rect.width;
                startHeight = rect.height;
                
                resizeTarget.setAttribute('data-resize-direction', handle);
                e.preventDefault();
                e.stopPropagation();
            });
        });
    }
    
    function setupGlobalMouseEvents() {
        $(document).on('mousemove', function(e) {
            if (isDragging && dragTarget) {
                var deltaX = e.clientX - startX;
                var deltaY = e.clientY - startY;
                
                var newLeft = startLeft + deltaX;
                var newTop = startTop + deltaY;
                
                // Keep window within viewport bounds
                var viewport = {
                    width: window.innerWidth,
                    height: window.innerHeight
                };
                var rect = dragTarget.getBoundingClientRect();
                
                newLeft = Math.max(0, Math.min(newLeft, viewport.width - rect.width));
                newTop = Math.max(0, Math.min(newTop, viewport.height - rect.height));
                
                dragTarget.style.left = newLeft + 'px';
                dragTarget.style.top = newTop + 'px';
                dragTarget.style.right = 'auto';
                dragTarget.style.bottom = 'auto';
            }
            
            if (isResizing && resizeTarget) {
                var deltaX = e.clientX - startX;
                var deltaY = e.clientY - startY;
                var direction = resizeTarget.getAttribute('data-resize-direction');
                
                var newLeft = startLeft;
                var newTop = startTop;
                var newWidth = startWidth;
                var newHeight = startHeight;
                
                if (direction.includes('e')) {
                    newWidth = startWidth + deltaX;
                }
                if (direction.includes('w')) {
                    newWidth = startWidth - deltaX;
                    newLeft = startLeft + deltaX;
                }
                if (direction.includes('s')) {
                    newHeight = startHeight + deltaY;
                }
                if (direction.includes('n')) {
                    newHeight = startHeight - deltaY;
                    newTop = startTop + deltaY;
                }
                
                // Enforce minimum size
                newWidth = Math.max(200, newWidth);
                newHeight = Math.max(150, newHeight);
                
                resizeTarget.style.left = newLeft + 'px';
                resizeTarget.style.top = newTop + 'px';
                resizeTarget.style.width = newWidth + 'px';
                resizeTarget.style.height = newHeight + 'px';
                resizeTarget.style.right = 'auto';
                resizeTarget.style.bottom = 'auto';
            }
        });
        
        $(document).on('mouseup', function(e) {
            if (isDragging) {
                isDragging = false;
                dragTarget = null;
            }
            if (isResizing) {
                isResizing = false;
                if (resizeTarget) {
                    resizeTarget.removeAttribute('data-resize-direction');
                    resizeTarget = null;
                }
            }
        });
    }
    
    function initializeWindow(windowId, windowElement, titleBarElement) {
        var $window = $(windowElement);
        var $titleBar = $(titleBarElement);
        
        // Set up dragging
        makeWindowDraggable(windowElement, titleBarElement);
        
        // Set up resizing
        makeWindowResizable(windowElement);
        
        // Set up control buttons
        $titleBar.find('.control-button').on('click', function(e) {
            var $button = $(this);
            if ($button.attr('id').includes('minimize')) {
                toggleMinimize(windowId);
            } else if ($button.attr('id').includes('close')) {
                toggleVisibility(windowId);
            }
            e.stopPropagation();
        });
        
        // Store window info
        windows[windowId] = {
            element: $window,
            titleBar: $titleBar,
            isMinimized: false,
            isVisible: true,
            originalHeight: $window.height()
        };
        
        return windows[windowId];
    }
    
    function toggleMinimize(windowId) {
        var window = windows[windowId];
        if (!window) return;
        
        var $window = window.element;
        var $content = $window.find('.red-ui-palette-content-wrapper, #red-ui-sidebar-content');
        
        if (window.isMinimized) {
            // Restore
            $window.height(window.originalHeight);
            $content.show();
            window.isMinimized = false;
            window.titleBar.find('.control-button[id*="minimize"]').text('âˆ’');
        } else {
            // Minimize
            window.originalHeight = $window.height();
            $window.height(window.titleBar.outerHeight());
            $content.hide();
            window.isMinimized = true;
            window.titleBar.find('.control-button[id*="minimize"]').text('+');
        }
    }
    
    function toggleVisibility(windowId) {
        var window = windows[windowId];
        if (!window) return;
        
        var $window = window.element;
        
        if (window.isVisible) {
            $window.hide();
            window.isVisible = false;
        } else {
            $window.show();
            window.isVisible = true;
        }
    }
    
    function init() {
        // Set up global mouse events
        setupGlobalMouseEvents();
        
        // Initialize palette window
        setTimeout(function() {
            if ($('#red-ui-palette').length && $('.red-ui-palette-title-bar').length) {
                initializeWindow('palette', '#red-ui-palette', '.red-ui-palette-title-bar');
            }
            
            // Initialize sidebar window
            if ($('#red-ui-sidebar').length && $('.red-ui-sidebar-title-bar').length) {
                initializeWindow('sidebar', '#red-ui-sidebar', '.red-ui-sidebar-title-bar');
            }
        }, 100);
    }
    
    return {
        init: init,
        initializeWindow: initializeWindow,
        toggleMinimize: toggleMinimize,
        toggleVisibility: toggleVisibility,
        getWindows: function() { return windows; }
    };
    
})();