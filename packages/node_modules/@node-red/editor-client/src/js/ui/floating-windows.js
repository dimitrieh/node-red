/**
 * Floating Windows Manager for Node-RED
 * Provides draggable and resizable floating window functionality
 */

RED.floatingWindows = (function() {
    
    let activeWindow = null;
    let windows = {};
    
    function makeWindowDraggable(windowElement, headerElement) {
        let isDragging = false;
        let startX, startY, startLeft, startTop;
        
        headerElement.addEventListener('mousedown', function(e) {
            if (e.target.tagName === 'BUTTON') return; // Don't drag on buttons
            
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = parseInt(window.getComputedStyle(windowElement).left, 10);
            startTop = parseInt(window.getComputedStyle(windowElement).top, 10);
            
            // Bring window to front
            setActiveWindow(windowElement);
            
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            let newLeft = startLeft + deltaX;
            let newTop = startTop + deltaY;
            
            // Keep window within bounds
            const containerRect = document.getElementById('red-ui-main-container').getBoundingClientRect();
            const windowRect = windowElement.getBoundingClientRect();
            
            newLeft = Math.max(0, Math.min(newLeft, containerRect.width - windowRect.width));
            newTop = Math.max(0, Math.min(newTop, containerRect.height - windowRect.height));
            
            windowElement.style.left = newLeft + 'px';
            windowElement.style.top = newTop + 'px';
        });
        
        document.addEventListener('mouseup', function() {
            isDragging = false;
        });
    }
    
    function makeWindowResizable(windowElement) {
        const resizeHandles = [
            { class: 'nw', cursor: 'nw-resize' },
            { class: 'ne', cursor: 'ne-resize' },
            { class: 'sw', cursor: 'sw-resize' },
            { class: 'se', cursor: 'se-resize' },
            { class: 'n', cursor: 'n-resize' },
            { class: 's', cursor: 's-resize' },
            { class: 'e', cursor: 'e-resize' },
            { class: 'w', cursor: 'w-resize' }
        ];
        
        resizeHandles.forEach(handle => {
            const resizeHandle = document.createElement('div');
            resizeHandle.className = `floating-window-resize ${handle.class}`;
            windowElement.appendChild(resizeHandle);
            
            let isResizing = false;
            let startX, startY, startWidth, startHeight, startLeft, startTop;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(window.getComputedStyle(windowElement).width, 10);
                startHeight = parseInt(window.getComputedStyle(windowElement).height, 10);
                startLeft = parseInt(window.getComputedStyle(windowElement).left, 10);
                startTop = parseInt(window.getComputedStyle(windowElement).top, 10);
                
                setActiveWindow(windowElement);
                e.preventDefault();
                e.stopPropagation();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;
                
                if (handle.class.includes('e')) newWidth += deltaX;
                if (handle.class.includes('w')) { newWidth -= deltaX; newLeft += deltaX; }
                if (handle.class.includes('s')) newHeight += deltaY;
                if (handle.class.includes('n')) { newHeight -= deltaY; newTop += deltaY; }
                
                // Apply minimum dimensions
                newWidth = Math.max(200, newWidth);
                newHeight = Math.max(150, newHeight);
                
                windowElement.style.width = newWidth + 'px';
                windowElement.style.height = newHeight + 'px';
                windowElement.style.left = newLeft + 'px';
                windowElement.style.top = newTop + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                isResizing = false;
            });
        });
    }
    
    function setActiveWindow(windowElement) {
        // Remove active class from all windows
        document.querySelectorAll('.floating-window').forEach(win => {
            win.classList.remove('active');
        });
        
        // Add active class to current window
        windowElement.classList.add('active');
        activeWindow = windowElement;
    }
    
    function createFloatingWindow(id, title, content, options = {}) {
        const windowElement = document.createElement('div');
        windowElement.id = id;
        windowElement.className = 'floating-window';
        
        // Set default dimensions and position
        const defaults = {
            width: 300,
            height: 400,
            left: 100,
            top: 100,
            minimizable: true,
            resizable: true
        };
        
        const config = { ...defaults, ...options };
        
        windowElement.style.width = config.width + 'px';
        windowElement.style.height = config.height + 'px';
        windowElement.style.left = config.left + 'px';
        windowElement.style.top = config.top + 'px';
        
        // Create header
        const header = document.createElement('div');
        header.className = 'floating-window-header';
        
        const titleElement = document.createElement('div');
        titleElement.className = 'floating-window-title';
        titleElement.textContent = title;
        
        const controls = document.createElement('div');
        controls.className = 'floating-window-controls';
        
        if (config.minimizable) {
            const minimizeBtn = document.createElement('button');
            minimizeBtn.textContent = 'âˆ’';
            minimizeBtn.title = 'Minimize';
            minimizeBtn.addEventListener('click', () => toggleMinimize(windowElement));
            controls.appendChild(minimizeBtn);
        }
        
        header.appendChild(titleElement);
        header.appendChild(controls);
        windowElement.appendChild(header);
        
        // Create content area
        const contentArea = document.createElement('div');
        contentArea.className = 'floating-window-content';
        if (content instanceof HTMLElement) {
            contentArea.appendChild(content);
        } else {
            contentArea.innerHTML = content;
        }
        windowElement.appendChild(contentArea);
        
        // Make draggable and resizable
        makeWindowDraggable(windowElement, header);
        if (config.resizable) {
            makeWindowResizable(windowElement);
        }
        
        // Add click handler to bring to front
        windowElement.addEventListener('mousedown', () => setActiveWindow(windowElement));
        
        // Add to container
        document.getElementById('red-ui-main-container').appendChild(windowElement);
        
        // Store window reference
        windows[id] = windowElement;
        
        // Set as active
        setActiveWindow(windowElement);
        
        return windowElement;
    }
    
    function toggleMinimize(windowElement) {
        windowElement.classList.toggle('minimized');
    }
    
    function getWindow(id) {
        return windows[id];
    }
    
    function closeWindow(id) {
        const windowElement = windows[id];
        if (windowElement) {
            windowElement.remove();
            delete windows[id];
        }
    }
    
    function init() {
        // Add floating mode class to body
        document.body.classList.add('floating-mode');
    }
    
    return {
        init: init,
        create: createFloatingWindow,
        get: getWindow,
        close: closeWindow,
        minimize: toggleMinimize
    };
    
})();