/**
* Copyright JS Foundation and other contributors, http://js.foundation
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
**/

RED.floating = (function() {
    
    let activeWindow = null;
    let dragData = null;
    let resizeData = null;
    let windows = new Map();
    let zIndexCounter = 1000;

    function createWindow(options) {
        const windowId = options.id || 'window-' + Date.now();
        
        // Create window structure
        const windowElement = $(`
            <div class="red-ui-floating-window ${options.className || ''}" id="${windowId}">
                <div class="floating-window-header">
                    <span class="floating-window-title">${options.title || 'Window'}</span>
                    <div class="floating-window-controls">
                        <button class="minimize-btn" title="Minimize">−</button>
                        <button class="close-btn" title="Close">×</button>
                    </div>
                </div>
                <div class="floating-window-content"></div>
                <!-- Resize handles -->
                <div class="resize-handle resize-n"></div>
                <div class="resize-handle resize-s"></div>
                <div class="resize-handle resize-e"></div>
                <div class="resize-handle resize-w"></div>
                <div class="resize-handle resize-ne"></div>
                <div class="resize-handle resize-nw"></div>
                <div class="resize-handle resize-se"></div>
                <div class="resize-handle resize-sw"></div>
            </div>
        `);

        // Set initial position and size
        const position = options.position || { x: 50, y: 50 };
        const size = options.size || { width: 300, height: 400 };
        
        windowElement.css({
            left: position.x + 'px',
            top: position.y + 'px',
            width: size.width + 'px',
            height: size.height + 'px'
        });

        // Add to DOM
        $(document.body).append(windowElement);

        // Store window data
        const windowData = {
            id: windowId,
            element: windowElement,
            options: options,
            position: position,
            size: size,
            minimized: false
        };
        
        windows.set(windowId, windowData);

        // Initialize event handlers
        initializeWindowEvents(windowData);

        // Load saved position if available
        loadWindowPosition(windowData);

        // Make window active
        setActiveWindow(windowData);

        return windowData;
    }

    function initializeWindowEvents(windowData) {
        const windowElement = windowData.element;
        const header = windowElement.find('.floating-window-header');

        // Window activation on click
        windowElement.on('mousedown', function() {
            setActiveWindow(windowData);
        });

        // Dragging functionality
        header.on('mousedown', function(e) {
            if ($(e.target).closest('.floating-window-controls').length > 0) {
                return; // Don't drag when clicking controls
            }
            
            startDrag(windowData, e);
        });

        // Control buttons
        windowElement.find('.minimize-btn').on('click', function() {
            toggleMinimize(windowData);
        });

        windowElement.find('.close-btn').on('click', function() {
            closeWindow(windowData);
        });

        // Resize handles
        windowElement.find('.resize-handle').on('mousedown', function(e) {
            startResize(windowData, e, $(this).attr('class').split(' ')[1]);
        });

        // Prevent default drag behavior on window content
        windowElement.find('.floating-window-content').on('dragstart', function(e) {
            e.preventDefault();
        });
    }

    function startDrag(windowData, event) {
        const windowElement = windowData.element;
        
        dragData = {
            window: windowData,
            startX: event.clientX,
            startY: event.clientY,
            startLeft: parseInt(windowElement.css('left')),
            startTop: parseInt(windowElement.css('top'))
        };

        windowElement.addClass('floating-window-dragging');
        
        $(document).on('mousemove.floating-drag', handleDragMove);
        $(document).on('mouseup.floating-drag', handleDragEnd);
        
        event.preventDefault();
    }

    function handleDragMove(event) {
        if (!dragData) return;

        const deltaX = event.clientX - dragData.startX;
        const deltaY = event.clientY - dragData.startY;
        
        const newLeft = Math.max(0, dragData.startLeft + deltaX);
        const newTop = Math.max(0, dragData.startTop + deltaY);

        dragData.window.element.css({
            left: newLeft + 'px',
            top: newTop + 'px'
        });

        dragData.window.position = { x: newLeft, y: newTop };
    }

    function handleDragEnd() {
        if (!dragData) return;

        dragData.window.element.removeClass('floating-window-dragging');
        saveWindowPosition(dragData.window);
        
        $(document).off('.floating-drag');
        dragData = null;
    }

    function startResize(windowData, event, direction) {
        const windowElement = windowData.element;
        const rect = windowElement[0].getBoundingClientRect();
        
        resizeData = {
            window: windowData,
            direction: direction,
            startX: event.clientX,
            startY: event.clientY,
            startWidth: rect.width,
            startHeight: rect.height,
            startLeft: rect.left,
            startTop: rect.top
        };

        $(document).on('mousemove.floating-resize', handleResizeMove);
        $(document).on('mouseup.floating-resize', handleResizeEnd);
        
        event.preventDefault();
        event.stopPropagation();
    }

    function handleResizeMove(event) {
        if (!resizeData) return;

        const deltaX = event.clientX - resizeData.startX;
        const deltaY = event.clientY - resizeData.startY;
        const direction = resizeData.direction;
        
        let newWidth = resizeData.startWidth;
        let newHeight = resizeData.startHeight;
        let newLeft = resizeData.startLeft;
        let newTop = resizeData.startTop;

        // Handle horizontal resizing
        if (direction.includes('e')) {
            newWidth = Math.max(200, resizeData.startWidth + deltaX);
        } else if (direction.includes('w')) {
            newWidth = Math.max(200, resizeData.startWidth - deltaX);
            newLeft = resizeData.startLeft + deltaX;
        }

        // Handle vertical resizing
        if (direction.includes('s')) {
            newHeight = Math.max(150, resizeData.startHeight + deltaY);
        } else if (direction.includes('n')) {
            newHeight = Math.max(150, resizeData.startHeight - deltaY);
            newTop = resizeData.startTop + deltaY;
        }

        // Apply constraints
        newLeft = Math.max(0, newLeft);
        newTop = Math.max(0, newTop);

        resizeData.window.element.css({
            width: newWidth + 'px',
            height: newHeight + 'px',
            left: newLeft + 'px',
            top: newTop + 'px'
        });

        resizeData.window.size = { width: newWidth, height: newHeight };
        resizeData.window.position = { x: newLeft, y: newTop };
    }

    function handleResizeEnd() {
        if (!resizeData) return;

        saveWindowPosition(resizeData.window);
        
        $(document).off('.floating-resize');
        resizeData = null;
    }

    function setActiveWindow(windowData) {
        // Remove active class from all windows
        $('.red-ui-floating-window').removeClass('floating-window-active');
        
        // Set new active window
        if (windowData) {
            windowData.element.addClass('floating-window-active');
            windowData.element.css('z-index', ++zIndexCounter);
            activeWindow = windowData;
        }
    }

    function toggleMinimize(windowData) {
        const windowElement = windowData.element;
        const content = windowElement.find('.floating-window-content');
        
        if (windowData.minimized) {
            // Restore
            content.show();
            windowElement.css('height', windowData.size.height + 'px');
            windowData.minimized = false;
        } else {
            // Minimize
            content.hide();
            windowElement.css('height', '32px');
            windowData.minimized = true;
        }
        
        saveWindowPosition(windowData);
    }

    function closeWindow(windowData) {
        windowData.element.remove();
        windows.delete(windowData.id);
        
        if (activeWindow === windowData) {
            activeWindow = null;
        }
    }

    function saveWindowPosition(windowData) {
        const key = 'floating-window-' + windowData.id;
        const data = {
            position: windowData.position,
            size: windowData.size,
            minimized: windowData.minimized
        };
        
        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
            // Ignore localStorage errors
        }
    }

    function loadWindowPosition(windowData) {
        const key = 'floating-window-' + windowData.id;
        
        try {
            const saved = localStorage.getItem(key);
            if (saved) {
                const data = JSON.parse(saved);
                
                windowData.element.css({
                    left: data.position.x + 'px',
                    top: data.position.y + 'px',
                    width: data.size.width + 'px',
                    height: data.size.height + 'px'
                });
                
                windowData.position = data.position;
                windowData.size = data.size;
                
                if (data.minimized) {
                    toggleMinimize(windowData);
                }
            }
        } catch (e) {
            // Ignore localStorage errors
        }
    }

    function moveWindowContent(windowData, contentElement) {
        const contentContainer = windowData.element.find('.floating-window-content');
        contentContainer.empty().append(contentElement);
    }

    function init() {
        // Create floating palette window
        const paletteWindow = createWindow({
            id: 'floating-palette',
            title: 'Node Palette',
            className: 'red-ui-floating-palette',
            position: { x: 20, y: 80 },
            size: { width: 200, height: 400 }
        });

        // Move palette content to floating window
        const paletteElement = $('#red-ui-palette');
        paletteElement.addClass('floating-mode');
        moveWindowContent(paletteWindow, paletteElement);

        // Create floating sidebar window
        const sidebarWindow = createWindow({
            id: 'floating-sidebar',
            title: 'Sidebar',
            className: 'red-ui-floating-sidebar',
            position: { x: window.innerWidth - 370, y: 80 },
            size: { width: 350, height: 500 }
        });

        // Move sidebar content to floating window
        const sidebarElement = $('#red-ui-sidebar');
        sidebarElement.addClass('floating-mode');
        moveWindowContent(sidebarWindow, sidebarElement);

        // Enable full-width workspace
        $('#red-ui-workspace').addClass('floating-windows-enabled');
        
        // Hide the sidebar separator since we don't need it
        $('#red-ui-sidebar-separator').hide();
    }

    // Public API
    return {
        init: init,
        createWindow: createWindow,
        closeWindow: closeWindow,
        setActiveWindow: setActiveWindow,
        moveWindowContent: moveWindowContent,
        getWindow: function(id) {
            return windows.get(id);
        },
        getAllWindows: function() {
            return Array.from(windows.values());
        }
    };

})();