/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindows = (function() {
    
    var windows = {};
    var zIndexCounter = 1000;
    var activeWindow = null;

    function createWindow(options) {
        var windowId = options.id || "window-" + Date.now();
        var title = options.title || "Window";
        var width = options.width || 300;
        var height = options.height || 400;
        var x = options.x || 50;
        var y = options.y || 50;
        var minWidth = options.minWidth || 200;
        var minHeight = options.minHeight || 150;
        var resizable = options.resizable !== false;
        
        // Create window structure
        var windowElement = $('<div/>', {
            class: 'floating-window',
            'data-window-id': windowId
        }).css({
            position: 'absolute',
            left: x + 'px',
            top: y + 'px',
            width: width + 'px',
            height: height + 'px',
            zIndex: zIndexCounter++,
            display: options.visible === false ? 'none' : 'block'
        });

        // Window header
        var headerElement = $('<div/>', {
            class: 'floating-window-header'
        }).appendTo(windowElement);

        // Drag handle
        var dragHandle = $('<div/>', {
            class: 'floating-window-drag-handle'
        }).appendTo(headerElement);

        var titleSpan = $('<span/>', {
            class: 'floating-window-title',
            text: title
        }).appendTo(dragHandle);

        // Window controls
        var controlsDiv = $('<div/>', {
            class: 'floating-window-controls'
        }).appendTo(headerElement);

        var minimizeBtn = $('<button/>', {
            type: 'button',
            class: 'floating-window-minimize',
            html: '−'
        }).appendTo(controlsDiv);

        var restoreBtn = $('<button/>', {
            type: 'button',
            class: 'floating-window-restore hide',
            html: '↔'
        }).appendTo(controlsDiv);

        var closeBtn = $('<button/>', {
            type: 'button',
            class: 'floating-window-close',
            html: '✕'
        }).appendTo(controlsDiv);

        // Window content container
        var contentElement = $('<div/>', {
            class: 'floating-window-content'
        }).appendTo(windowElement);

        if (options.content) {
            contentElement.append(options.content);
        }

        // Add to DOM
        $('#red-ui-workspace').append(windowElement);

        // Window object
        var windowObj = {
            id: windowId,
            element: windowElement,
            header: headerElement,
            content: contentElement,
            title: title,
            visible: options.visible !== false,
            minimized: false,
            x: x,
            y: y,
            width: width,
            height: height,
            minWidth: minWidth,
            minHeight: minHeight,
            resizable: resizable
        };

        windows[windowId] = windowObj;

        // Setup dragging
        setupDragging(windowObj);
        
        // Setup resizing if enabled
        if (resizable) {
            setupResizing(windowObj);
        }

        // Setup window controls
        setupControls(windowObj);

        // Setup focus handling
        setupFocus(windowObj);

        return windowObj;
    }

    function setupDragging(windowObj) {
        var isDragging = false;
        var dragOffset = { x: 0, y: 0 };

        windowObj.header.on('mousedown', function(e) {
            if (e.target.tagName === 'BUTTON') return; // Don't drag when clicking buttons
            
            isDragging = true;
            focusWindow(windowObj.id);
            
            var rect = windowObj.element[0].getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            windowObj.element.addClass('dragging');
            
            $(document).on('mousemove.floating-window', function(e) {
                if (!isDragging) return;
                
                var workspace = $('#red-ui-workspace');
                var workspaceOffset = workspace.offset();
                var workspaceWidth = workspace.width();
                var workspaceHeight = workspace.height();
                
                var newX = e.clientX - workspaceOffset.left - dragOffset.x;
                var newY = e.clientY - workspaceOffset.top - dragOffset.y;
                
                // Keep within bounds
                newX = Math.max(0, Math.min(newX, workspaceWidth - windowObj.width));
                newY = Math.max(0, Math.min(newY, workspaceHeight - windowObj.height));
                
                windowObj.element.css({
                    left: newX + 'px',
                    top: newY + 'px'
                });
                
                windowObj.x = newX;
                windowObj.y = newY;
            });
            
            $(document).on('mouseup.floating-window', function() {
                isDragging = false;
                windowObj.element.removeClass('dragging');
                $(document).off('.floating-window');
            });
        });
    }

    function setupResizing(windowObj) {
        // Add resize handle
        var resizeHandle = $('<div/>', {
            class: 'floating-window-resize-handle'
        }).appendTo(windowObj.element);

        var isResizing = false;

        resizeHandle.on('mousedown', function(e) {
            e.stopPropagation();
            isResizing = true;
            focusWindow(windowObj.id);

            var startX = e.clientX;
            var startY = e.clientY;
            var startWidth = windowObj.width;
            var startHeight = windowObj.height;

            $(document).on('mousemove.resize', function(e) {
                if (!isResizing) return;

                var deltaX = e.clientX - startX;
                var deltaY = e.clientY - startY;

                var newWidth = Math.max(windowObj.minWidth, startWidth + deltaX);
                var newHeight = Math.max(windowObj.minHeight, startHeight + deltaY);

                windowObj.element.css({
                    width: newWidth + 'px',
                    height: newHeight + 'px'
                });

                windowObj.width = newWidth;
                windowObj.height = newHeight;
            });

            $(document).on('mouseup.resize', function() {
                isResizing = false;
                $(document).off('.resize');
            });
        });
    }

    function setupControls(windowObj) {
        // Minimize button
        windowObj.element.find('.floating-window-minimize').on('click', function() {
            minimizeWindow(windowObj.id);
        });

        // Restore button
        windowObj.element.find('.floating-window-restore').on('click', function() {
            restoreWindow(windowObj.id);
        });

        // Close button
        windowObj.element.find('.floating-window-close').on('click', function() {
            hideWindow(windowObj.id);
        });

        // Double-click header to minimize/restore
        windowObj.header.on('dblclick', function() {
            if (windowObj.minimized) {
                restoreWindow(windowObj.id);
            } else {
                minimizeWindow(windowObj.id);
            }
        });
    }

    function setupFocus(windowObj) {
        windowObj.element.on('mousedown', function() {
            focusWindow(windowObj.id);
        });
    }

    function focusWindow(windowId) {
        if (activeWindow) {
            windows[activeWindow].element.removeClass('active');
        }
        
        var windowObj = windows[windowId];
        if (windowObj) {
            windowObj.element.css('zIndex', zIndexCounter++);
            windowObj.element.addClass('active');
            activeWindow = windowId;
        }
    }

    function minimizeWindow(windowId) {
        var windowObj = windows[windowId];
        if (!windowObj || windowObj.minimized) return;

        windowObj.minimized = true;
        windowObj.element.addClass('minimized');
        windowObj.element.find('.floating-window-content').hide();
        windowObj.element.find('.floating-window-minimize').hide();
        windowObj.element.find('.floating-window-restore').show();
        
        // Shrink to header height
        windowObj.element.css('height', 'auto');
    }

    function restoreWindow(windowId) {
        var windowObj = windows[windowId];
        if (!windowObj || !windowObj.minimized) return;

        windowObj.minimized = false;
        windowObj.element.removeClass('minimized');
        windowObj.element.find('.floating-window-content').show();
        windowObj.element.find('.floating-window-minimize').show();
        windowObj.element.find('.floating-window-restore').hide();
        
        // Restore original height
        windowObj.element.css('height', windowObj.height + 'px');
        focusWindow(windowId);
    }

    function showWindow(windowId) {
        var windowObj = windows[windowId];
        if (!windowObj) return;

        windowObj.element.show();
        windowObj.visible = true;
        focusWindow(windowId);
    }

    function hideWindow(windowId) {
        var windowObj = windows[windowId];
        if (!windowObj) return;

        windowObj.element.hide();
        windowObj.visible = false;
        
        if (activeWindow === windowId) {
            activeWindow = null;
        }
    }

    function toggleWindow(windowId) {
        var windowObj = windows[windowId];
        if (!windowObj) return;

        if (windowObj.visible) {
            hideWindow(windowId);
        } else {
            showWindow(windowId);
        }
    }

    function setWindowTitle(windowId, title) {
        var windowObj = windows[windowId];
        if (!windowObj) return;

        windowObj.title = title;
        windowObj.element.find('.floating-window-title').text(title);
    }

    function getWindow(windowId) {
        return windows[windowId];
    }

    function getAllWindows() {
        return Object.keys(windows).map(id => windows[id]);
    }

    function destroyWindow(windowId) {
        var windowObj = windows[windowId];
        if (!windowObj) return;

        windowObj.element.remove();
        delete windows[windowId];

        if (activeWindow === windowId) {
            activeWindow = null;
        }
    }

    return {
        create: createWindow,
        focus: focusWindow,
        minimize: minimizeWindow,
        restore: restoreWindow,
        show: showWindow,
        hide: hideWindow,
        toggle: toggleWindow,
        setTitle: setWindowTitle,
        get: getWindow,
        getAll: getAllWindows,
        destroy: destroyWindow
    };
})();