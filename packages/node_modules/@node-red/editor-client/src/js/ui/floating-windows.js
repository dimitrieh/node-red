/**
 * Floating Windows Framework for Node-RED
 * Provides draggable/resizable floating window functionality
 */
RED.floatingWindows = (function() {
    
    var windows = {};
    var activeWindow = null;
    var zIndex = 1000;
    
    function createWindow(options) {
        var windowId = options.id;
        var windowElement = $('<div class="red-ui-floating-window ' + (options.className || '') + '" id="' + windowId + '">');
        
        // Create header
        var header = $('<div class="red-ui-floating-window-header">');
        var title = $('<div class="red-ui-floating-window-title">' + options.title + '</div>');
        var controls = $('<div class="red-ui-floating-window-controls">');
        var minimizeBtn = $('<button title="Minimize">−</button>');
        
        controls.append(minimizeBtn);
        header.append(title).append(controls);
        
        // Create content container
        var content = $('<div class="red-ui-floating-window-content">');
        if (options.content) {
            content.append(options.content);
        }
        
        // Create resize handle
        var resizeHandle = $('<div class="red-ui-floating-window-resize red-ui-floating-window-resize-se">');
        
        windowElement.append(header).append(content).append(resizeHandle);
        
        // Apply initial positioning and sizing
        windowElement.css({
            left: options.left || 20,
            top: options.top || 60,
            width: options.width || 200,
            height: options.height || 400
        });
        
        // Append to main container
        $('#red-ui-main-container').append(windowElement);
        
        // Make draggable
        windowElement.draggable({
            handle: '.red-ui-floating-window-header',
            containment: '#red-ui-main-container',
            start: function() {
                setActiveWindow(windowId);
            }
        });
        
        // Make resizable
        windowElement.resizable({
            handles: 'se',
            minWidth: options.minWidth || 180,
            minHeight: options.minHeight || 200,
            containment: '#red-ui-main-container'
        });
        
        // Handle window focus
        windowElement.on('mousedown', function() {
            setActiveWindow(windowId);
        });
        
        // Handle minimize
        minimizeBtn.on('click', function(e) {
            e.stopPropagation();
            toggleMinimize(windowId);
        });
        
        // Store window reference
        windows[windowId] = {
            element: windowElement,
            options: options,
            minimized: false,
            originalHeight: options.height || 400
        };
        
        setActiveWindow(windowId);
        
        return windowElement;
    }
    
    function setActiveWindow(windowId) {
        // Remove active class from all windows
        $('.red-ui-floating-window').removeClass('red-ui-floating-window-active');
        
        if (windows[windowId]) {
            windows[windowId].element.addClass('red-ui-floating-window-active');
            windows[windowId].element.css('z-index', ++zIndex);
            activeWindow = windowId;
        }
    }
    
    function toggleMinimize(windowId) {
        var window = windows[windowId];
        if (!window) return;
        
        if (window.minimized) {
            // Restore
            window.element.animate({ height: window.originalHeight }, 200);
            window.element.find('.red-ui-floating-window-controls button').text('−');
            window.minimized = false;
        } else {
            // Minimize  
            window.originalHeight = window.element.height();
            window.element.animate({ height: 30 }, 200);
            window.element.find('.red-ui-floating-window-controls button').text('+');
            window.minimized = true;
        }
    }
    
    function destroyWindow(windowId) {
        if (windows[windowId]) {
            windows[windowId].element.remove();
            delete windows[windowId];
            
            if (activeWindow === windowId) {
                activeWindow = null;
            }
        }
    }
    
    function getWindow(windowId) {
        return windows[windowId];
    }
    
    return {
        create: createWindow,
        destroy: destroyWindow,
        setActive: setActiveWindow,
        toggleMinimize: toggleMinimize,
        get: getWindow
    };
})();