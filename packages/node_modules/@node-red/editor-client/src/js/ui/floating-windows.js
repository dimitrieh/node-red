/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindows = (function() {

    var zIndexCounter = 1000;

    function init() {
        // Create title bars for palette and sidebar
        createPaletteTitleBar();
        createSidebarTitleBar();
        
        // Initialize dragging functionality
        initializeDragging();
        
        // Initialize window management
        initializeWindowManagement();
        
        // Load saved window positions
        loadWindowPositions();
    }

    function createPaletteTitleBar() {
        const palette = $("#red-ui-palette");
        if (palette.length && !palette.find(".red-ui-palette-title-bar").length) {
            const titleBar = $('<div class="red-ui-palette-title-bar">' +
                '<div class="red-ui-palette-title">Node Palette</div>' +
                '<div class="red-ui-palette-controls">' +
                    '<button class="red-ui-palette-control-btn" data-action="minimize" title="Minimize">−</button>' +
                    '<button class="red-ui-palette-control-btn" data-action="close" title="Close">×</button>' +
                '</div>' +
                '</div>');
            palette.prepend(titleBar);
            
            // Add click handlers for control buttons
            titleBar.find('[data-action="minimize"]').click(function(e) {
                e.preventDefault();
                toggleMinimize(palette);
            });
            
            titleBar.find('[data-action="close"]').click(function(e) {
                e.preventDefault();
                palette.hide();
                saveWindowState();
            });
        }
    }

    function createSidebarTitleBar() {
        const sidebar = $("#red-ui-sidebar");
        if (sidebar.length && !sidebar.find(".red-ui-sidebar-title-bar").length) {
            const titleBar = $('<div class="red-ui-sidebar-title-bar">' +
                '<div class="red-ui-sidebar-title">Sidebar</div>' +
                '<div class="red-ui-sidebar-controls">' +
                    '<button class="red-ui-sidebar-control-btn" data-action="minimize" title="Minimize">−</button>' +
                    '<button class="red-ui-sidebar-control-btn" data-action="close" title="Close">×</button>' +
                '</div>' +
                '</div>');
            sidebar.prepend(titleBar);
            
            // Add click handlers for control buttons
            titleBar.find('[data-action="minimize"]').click(function(e) {
                e.preventDefault();
                toggleMinimize(sidebar);
            });
            
            titleBar.find('[data-action="close"]').click(function(e) {
                e.preventDefault();
                sidebar.hide();
                saveWindowState();
            });
        }
    }

    function initializeDragging() {
        // Make palette draggable
        $("#red-ui-palette").draggable({
            handle: ".red-ui-palette-title-bar",
            containment: "#red-ui-editor",
            stack: ".floating-window",
            drag: function() {
                saveWindowPositions();
            },
            start: function() {
                bringToFront($(this));
            }
        });

        // Make sidebar draggable
        $("#red-ui-sidebar").draggable({
            handle: ".red-ui-sidebar-title-bar",
            containment: "#red-ui-editor",
            stack: ".floating-window",
            drag: function() {
                saveWindowPositions();
            },
            start: function() {
                bringToFront($(this));
            }
        });
    }

    function initializeWindowManagement() {
        // Add click handlers to bring windows to front
        $("#red-ui-palette, #red-ui-sidebar").on('mousedown', function() {
            bringToFront($(this));
        });
        
        // Add floating-window class for stacking
        $("#red-ui-palette, #red-ui-sidebar").addClass("floating-window");
    }

    function bringToFront(window) {
        zIndexCounter++;
        window.css('z-index', zIndexCounter);
    }

    function toggleMinimize(window) {
        const content = window.find(".red-ui-palette-scroll, #red-ui-sidebar-content");
        const search = window.find(".red-ui-palette-search");
        const header = window.find(".red-ui-sidebar-header");
        
        if (window.hasClass('minimized')) {
            // Restore window
            window.removeClass('minimized');
            content.show();
            search.show();
            header.show();
            window.resizable('enable');
        } else {
            // Minimize window
            window.addClass('minimized');
            content.hide();
            search.hide();
            header.hide();
            window.resizable('disable');
        }
        saveWindowState();
    }

    function saveWindowPositions() {
        const positions = {
            palette: {
                left: $("#red-ui-palette").css('left'),
                top: $("#red-ui-palette").css('top'),
                width: $("#red-ui-palette").width(),
                height: $("#red-ui-palette").height()
            },
            sidebar: {
                left: $("#red-ui-sidebar").css('left'),
                top: $("#red-ui-sidebar").css('top'),
                width: $("#red-ui-sidebar").width(),
                height: $("#red-ui-sidebar").height()
            }
        };
        localStorage.setItem('red-ui-floating-window-positions', JSON.stringify(positions));
    }

    function saveWindowState() {
        const state = {
            palette: {
                visible: $("#red-ui-palette").is(':visible'),
                minimized: $("#red-ui-palette").hasClass('minimized')
            },
            sidebar: {
                visible: $("#red-ui-sidebar").is(':visible'),
                minimized: $("#red-ui-sidebar").hasClass('minimized')
            }
        };
        localStorage.setItem('red-ui-floating-window-state', JSON.stringify(state));
    }

    function loadWindowPositions() {
        try {
            const positions = JSON.parse(localStorage.getItem('red-ui-floating-window-positions') || '{}');
            const state = JSON.parse(localStorage.getItem('red-ui-floating-window-state') || '{}');
            
            // Restore palette position and state
            if (positions.palette) {
                $("#red-ui-palette").css({
                    left: positions.palette.left || '50px',
                    top: positions.palette.top || '100px'
                });
                if (positions.palette.width) $("#red-ui-palette").width(positions.palette.width);
                if (positions.palette.height) $("#red-ui-palette").height(positions.palette.height);
            }
            
            // Restore sidebar position and state
            if (positions.sidebar) {
                $("#red-ui-sidebar").css({
                    left: positions.sidebar.left || 'auto',
                    top: positions.sidebar.top || '120px'
                });
                if (positions.sidebar.width) $("#red-ui-sidebar").width(positions.sidebar.width);
                if (positions.sidebar.height) $("#red-ui-sidebar").height(positions.sidebar.height);
            }
            
            // Restore visibility and minimization state
            if (state.palette) {
                if (!state.palette.visible) $("#red-ui-palette").hide();
                if (state.palette.minimized) toggleMinimize($("#red-ui-palette"));
            }
            
            if (state.sidebar) {
                if (!state.sidebar.visible) $("#red-ui-sidebar").hide();
                if (state.sidebar.minimized) toggleMinimize($("#red-ui-sidebar"));
            }
            
        } catch(e) {
            console.warn("Could not restore floating window positions:", e);
        }
    }

    function resetWindowPositions() {
        $("#red-ui-palette").css({
            left: '50px',
            top: '100px',
            width: '200px',
            height: '400px'
        }).show().removeClass('minimized');
        
        $("#red-ui-sidebar").css({
            left: 'auto',
            right: '50px',
            top: '120px',
            width: '320px',
            height: '450px'
        }).show().removeClass('minimized');
        
        // Show all content
        $("#red-ui-palette .red-ui-palette-scroll, #red-ui-palette .red-ui-palette-search").show();
        $("#red-ui-sidebar #red-ui-sidebar-content, #red-ui-sidebar .red-ui-sidebar-header").show();
        
        // Re-enable resizing
        $("#red-ui-palette, #red-ui-sidebar").resizable('enable');
        
        saveWindowPositions();
        saveWindowState();
    }

    function showPalette() {
        $("#red-ui-palette").show();
        bringToFront($("#red-ui-palette"));
        saveWindowState();
    }

    function showSidebar() {
        $("#red-ui-sidebar").show();
        bringToFront($("#red-ui-sidebar"));
        saveWindowState();
    }

    return {
        init: init,
        resetWindowPositions: resetWindowPositions,
        showPalette: showPalette,
        showSidebar: showSidebar
    };
})();