/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindows = (function() {

    var activeWindow = null;
    var windows = {};
    var windowCounter = 0;
    
    function createFloatingWindow(options) {
        var windowId = "red-ui-floating-window-" + (++windowCounter);
        var defaultOptions = {
            id: windowId,
            title: "Window",
            content: null,
            x: 50,
            y: 50,
            width: 300,
            height: 400,
            minWidth: 200,
            minHeight: 100,
            maximizable: true,
            minimizable: true,
            resizable: true
        };
        
        options = $.extend(defaultOptions, options);
        
        var windowEl = $('<div>', {
            id: windowId,
            class: 'red-ui-floating-window'
        }).css({
            left: options.x + 'px',
            top: options.y + 'px',
            width: options.width + 'px',
            height: options.height + 'px'
        });
        
        // Create title bar
        var titleBar = $('<div class="red-ui-floating-window-titlebar">').appendTo(windowEl);
        var title = $('<div class="red-ui-floating-window-title">').text(options.title).appendTo(titleBar);
        var controls = $('<div class="red-ui-floating-window-controls">').appendTo(titleBar);
        
        if (options.minimizable) {
            $('<button class="red-ui-floating-window-control minimize" title="Minimize">').appendTo(controls);
        }
        
        if (options.maximizable) {
            $('<button class="red-ui-floating-window-control maximize" title="Maximize">').appendTo(controls);
        }
        
        // Create content area
        var content = $('<div class="red-ui-floating-window-content">').appendTo(windowEl);
        
        if (options.content) {
            if (typeof options.content === 'string') {
                // Move existing element into window
                var existingEl = $(options.content);
                existingEl.appendTo(content);
            } else {
                // Append jQuery object or HTML
                content.append(options.content);
            }
        }
        
        // Add resize handles if resizable
        if (options.resizable) {
            ['n', 's', 'e', 'w', 'ne', 'nw', 'se', 'sw'].forEach(function(direction) {
                $('<div class="red-ui-floating-window-resize-handle ' + direction + '">').appendTo(windowEl);
            });
        }
        
        // Append to main container
        $('#red-ui-main-container').append(windowEl);
        
        // Initialize window behavior
        initializeWindow(windowEl, options);
        
        // Store window reference
        windows[windowId] = {
            element: windowEl,
            options: options,
            isMaximized: false,
            isMinimized: false,
            originalBounds: null
        };
        
        // Focus this window
        focusWindow(windowId);
        
        return windowId;
    }
    
    function initializeWindow(windowEl, options) {
        var windowId = windowEl.attr('id');
        var isDragging = false;
        var isResizing = false;
        var dragStart = null;
        var resizeStart = null;
        var resizeDirection = null;
        
        // Make title bar draggable
        windowEl.find('.red-ui-floating-window-titlebar').on('mousedown', function(e) {
            e.preventDefault();
            if (e.target.tagName === 'BUTTON') return;
            
            isDragging = true;
            dragStart = {
                x: e.pageX,
                y: e.pageY,
                winX: windowEl.position().left,
                winY: windowEl.position().top
            };
            
            windowEl.addClass('red-ui-floating-window-dragging');
            focusWindow(windowId);
            
            $(document).on('mousemove.floatingWindow', function(e) {
                if (!isDragging) return;
                
                var newX = dragStart.winX + (e.pageX - dragStart.x);
                var newY = dragStart.winY + (e.pageY - dragStart.y);
                
                // Keep window within bounds
                var container = $('#red-ui-main-container');
                var maxX = container.width() - windowEl.width();
                var maxY = container.height() - windowEl.height();
                
                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));
                
                windowEl.css({
                    left: newX + 'px',
                    top: newY + 'px'
                });
            });
            
            $(document).on('mouseup.floatingWindow', function() {
                isDragging = false;
                windowEl.removeClass('red-ui-floating-window-dragging');
                $(document).off('mousemove.floatingWindow mouseup.floatingWindow');
            });
        });
        
        // Handle resize
        if (options.resizable) {
            windowEl.find('.red-ui-floating-window-resize-handle').on('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                isResizing = true;
                resizeDirection = $(this).attr('class').split(' ')[1];
                
                resizeStart = {
                    x: e.pageX,
                    y: e.pageY,
                    width: windowEl.width(),
                    height: windowEl.height(),
                    left: windowEl.position().left,
                    top: windowEl.position().top
                };
                
                windowEl.addClass('red-ui-floating-window-resizing');
                
                $(document).on('mousemove.floatingResize', function(e) {
                    if (!isResizing) return;
                    
                    var deltaX = e.pageX - resizeStart.x;
                    var deltaY = e.pageY - resizeStart.y;
                    var newBounds = calculateResize(resizeStart, deltaX, deltaY, resizeDirection, options);
                    
                    windowEl.css(newBounds);
                });
                
                $(document).on('mouseup.floatingResize', function() {
                    isResizing = false;
                    windowEl.removeClass('red-ui-floating-window-resizing');
                    $(document).off('mousemove.floatingResize mouseup.floatingResize');
                });
            });
        }
        
        // Handle window controls
        windowEl.find('.red-ui-floating-window-control.minimize').on('click', function(e) {
            e.preventDefault();
            toggleMinimize(windowId);
        });
        
        windowEl.find('.red-ui-floating-window-control.maximize').on('click', function(e) {
            e.preventDefault();
            toggleMaximize(windowId);
        });
        
        // Focus on click
        windowEl.on('mousedown', function() {
            focusWindow(windowId);
        });
    }
    
    function calculateResize(start, deltaX, deltaY, direction, options) {
        var newBounds = {
            left: start.left,
            top: start.top,
            width: start.width,
            height: start.height
        };
        
        switch (direction) {
            case 'n':
                newBounds.top = start.top + deltaY;
                newBounds.height = start.height - deltaY;
                break;
            case 's':
                newBounds.height = start.height + deltaY;
                break;
            case 'e':
                newBounds.width = start.width + deltaX;
                break;
            case 'w':
                newBounds.left = start.left + deltaX;
                newBounds.width = start.width - deltaX;
                break;
            case 'ne':
                newBounds.top = start.top + deltaY;
                newBounds.height = start.height - deltaY;
                newBounds.width = start.width + deltaX;
                break;
            case 'nw':
                newBounds.top = start.top + deltaY;
                newBounds.height = start.height - deltaY;
                newBounds.left = start.left + deltaX;
                newBounds.width = start.width - deltaX;
                break;
            case 'se':
                newBounds.height = start.height + deltaY;
                newBounds.width = start.width + deltaX;
                break;
            case 'sw':
                newBounds.height = start.height + deltaY;
                newBounds.left = start.left + deltaX;
                newBounds.width = start.width - deltaX;
                break;
        }
        
        // Enforce minimum dimensions
        if (newBounds.width < options.minWidth) {
            if (direction.includes('w')) {
                newBounds.left = start.left + start.width - options.minWidth;
            }
            newBounds.width = options.minWidth;
        }
        
        if (newBounds.height < options.minHeight) {
            if (direction.includes('n')) {
                newBounds.top = start.top + start.height - options.minHeight;
            }
            newBounds.height = options.minHeight;
        }
        
        // Keep within container bounds
        var container = $('#red-ui-main-container');
        newBounds.left = Math.max(0, Math.min(newBounds.left, container.width() - newBounds.width));
        newBounds.top = Math.max(0, Math.min(newBounds.top, container.height() - newBounds.height));
        
        return newBounds;
    }
    
    function focusWindow(windowId) {
        if (activeWindow === windowId) return;
        
        // Remove active class from all windows
        $('.red-ui-floating-window').removeClass('active');
        
        // Add active class to focused window
        $('#' + windowId).addClass('active');
        
        activeWindow = windowId;
    }
    
    function toggleMinimize(windowId) {
        var window = windows[windowId];
        if (!window) return;
        
        if (window.isMinimized) {
            // Restore
            window.element.removeClass('minimized');
            window.isMinimized = false;
            window.element.find('.maximize').removeClass('restore');
        } else {
            // Minimize
            window.element.addClass('minimized');
            window.isMinimized = true;
        }
    }
    
    function toggleMaximize(windowId) {
        var window = windows[windowId];
        if (!window) return;
        
        var maximizeBtn = window.element.find('.maximize');
        
        if (window.isMaximized) {
            // Restore
            window.element.removeClass('maximized');
            if (window.originalBounds) {
                window.element.css(window.originalBounds);
            }
            window.isMaximized = false;
            maximizeBtn.removeClass('restore');
        } else {
            // Maximize
            window.originalBounds = {
                left: window.element.position().left + 'px',
                top: window.element.position().top + 'px',
                width: window.element.width() + 'px',
                height: window.element.height() + 'px'
            };
            window.element.addClass('maximized');
            window.isMaximized = true;
            maximizeBtn.addClass('restore');
        }
    }
    
    function enableFloatingMode() {
        $('body').addClass('red-ui-workspace-floating');
        
        // Convert palette to floating window
        createFloatingWindow({
            id: 'red-ui-floating-palette',
            title: 'Node Palette',
            content: '#red-ui-palette',
            x: 20,
            y: 50,
            width: 200,
            height: 500,
            minWidth: 180,
            minHeight: 200
        });
        
        // Convert sidebar to floating window
        createFloatingWindow({
            id: 'red-ui-floating-sidebar',
            title: 'Sidebar',
            content: '#red-ui-sidebar',
            x: window.innerWidth - 350,
            y: 50,
            width: 330,
            height: 500,
            minWidth: 250,
            minHeight: 200
        });
    }
    
    function disableFloatingMode() {
        $('body').removeClass('red-ui-workspace-floating');
        
        // Move palette back
        var paletteWindow = windows['red-ui-floating-palette'];
        if (paletteWindow) {
            $('#red-ui-palette').appendTo('#red-ui-main-container');
            paletteWindow.element.remove();
            delete windows['red-ui-floating-palette'];
        }
        
        // Move sidebar back  
        var sidebarWindow = windows['red-ui-floating-sidebar'];
        if (sidebarWindow) {
            $('#red-ui-sidebar').appendTo('#red-ui-main-container');
            sidebarWindow.element.remove();
            delete windows['red-ui-floating-sidebar'];
        }
    }
    
    return {
        init: function() {
            // Auto-enable floating mode on initialization
            setTimeout(enableFloatingMode, 1000);
        },
        createWindow: createFloatingWindow,
        enableFloatingMode: enableFloatingMode,
        disableFloatingMode: disableFloatingMode,
        focusWindow: focusWindow
    };
})();