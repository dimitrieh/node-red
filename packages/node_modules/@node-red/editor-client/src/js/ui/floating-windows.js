/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindows = (function() {
    var windows = {};
    var activeWindow = null;
    var zIndexCounter = 1000;
    var isDragging = false;
    var dragStartPos = { x: 0, y: 0 };
    var windowStartPos = { x: 0, y: 0 };
    
    function createWindow(options) {
        options = options || {};
        var windowId = options.id || ('window-' + Date.now());
        
        var windowElement = $('<div>', {
            class: 'floating-window',
            'data-window-id': windowId,
            'data-window-type': options.type || 'generic'
        });
        
        // Create header
        var header = $('<div>', { class: 'floating-window-header' });
        var dragHandle = $('<div>', { 
            class: 'floating-window-drag-handle',
            title: 'Drag to move window'
        });
        var title = $('<span>', { 
            class: 'floating-window-title',
            text: options.title || 'Window'
        });
        
        dragHandle.append(title);
        
        // Create controls
        var controls = $('<div>', { class: 'floating-window-controls' });
        var minimizeBtn = $('<button>', {
            class: 'floating-window-minimize',
            title: 'Minimize',
            html: '−'
        });
        var closeBtn = $('<button>', {
            class: 'floating-window-close', 
            title: 'Close',
            html: '×'
        });
        
        controls.append(minimizeBtn, closeBtn);
        header.append(dragHandle, controls);
        
        // Create content area
        var content = $('<div>', { class: 'floating-window-content' });
        if (options.content) {
            content.append(options.content);
        }
        
        windowElement.append(header, content);
        
        // Set initial position and size
        windowElement.css({
            position: 'absolute',
            left: options.x || 20,
            top: options.y || 20,
            width: options.width || 300,
            height: options.height || 400,
            zIndex: ++zIndexCounter
        });
        
        // Add to container
        var container = $('#red-ui-workspace');
        container.append(windowElement);
        
        // Set up event handlers
        setupWindowEvents(windowElement, windowId);
        
        // Store window reference
        windows[windowId] = {
            element: windowElement,
            options: options,
            isMinimized: false,
            originalHeight: options.height || 400
        };
        
        return windowId;
    }
    
    function setupWindowEvents(windowElement, windowId) {
        var header = windowElement.find('.floating-window-header');
        var dragHandle = windowElement.find('.floating-window-drag-handle');
        var minimizeBtn = windowElement.find('.floating-window-minimize');
        var closeBtn = windowElement.find('.floating-window-close');
        var content = windowElement.find('.floating-window-content');
        
        // Focus handling
        windowElement.on('mousedown', function() {
            focusWindow(windowId);
        });
        
        // Drag functionality
        dragHandle.on('mousedown', function(e) {
            e.preventDefault();
            isDragging = true;
            dragStartPos = { x: e.clientX, y: e.clientY };
            var pos = windowElement.position();
            windowStartPos = { x: pos.left, y: pos.top };
            
            windowElement.addClass('floating-window-dragging');
            focusWindow(windowId);
            
            $(document).on('mousemove.floating-window', function(e) {
                if (!isDragging) return;
                
                var deltaX = e.clientX - dragStartPos.x;
                var deltaY = e.clientY - dragStartPos.y;
                
                var newX = windowStartPos.x + deltaX;
                var newY = windowStartPos.y + deltaY;
                
                // Constrain to workspace bounds
                var workspace = $('#red-ui-workspace');
                var workspaceOffset = workspace.offset();
                var workspaceWidth = workspace.width();
                var workspaceHeight = workspace.height();
                var windowWidth = windowElement.outerWidth();
                var windowHeight = windowElement.outerHeight();
                
                newX = Math.max(0, Math.min(newX, workspaceWidth - windowWidth));
                newY = Math.max(0, Math.min(newY, workspaceHeight - 30)); // Keep title bar visible
                
                windowElement.css({
                    left: newX,
                    top: newY
                });
            });
            
            $(document).on('mouseup.floating-window', function() {
                isDragging = false;
                windowElement.removeClass('floating-window-dragging');
                $(document).off('mousemove.floating-window mouseup.floating-window');
            });
        });
        
        // Minimize/restore functionality
        minimizeBtn.on('click', function(e) {
            e.stopPropagation();
            toggleMinimize(windowId);
        });
        
        // Close functionality
        closeBtn.on('click', function(e) {
            e.stopPropagation();
            closeWindow(windowId);
        });
        
        // Double-click to minimize/restore
        dragHandle.on('dblclick', function() {
            toggleMinimize(windowId);
        });
        
        // Resize functionality (basic)
        if (windowElement.hasClass('resizable')) {
            setupResizeHandlers(windowElement, windowId);
        }
    }
    
    function setupResizeHandlers(windowElement, windowId) {
        var resizeHandle = $('<div>', { class: 'floating-window-resize-handle' });
        windowElement.append(resizeHandle);
        
        resizeHandle.on('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var startX = e.clientX;
            var startY = e.clientY;
            var startWidth = windowElement.width();
            var startHeight = windowElement.height();
            
            $(document).on('mousemove.resize', function(e) {
                var newWidth = startWidth + (e.clientX - startX);
                var newHeight = startHeight + (e.clientY - startY);
                
                // Minimum size constraints
                newWidth = Math.max(200, newWidth);
                newHeight = Math.max(150, newHeight);
                
                windowElement.css({
                    width: newWidth,
                    height: newHeight
                });
            });
            
            $(document).on('mouseup.resize', function() {
                $(document).off('mousemove.resize mouseup.resize');
            });
        });
    }
    
    function focusWindow(windowId) {
        if (activeWindow === windowId) return;
        
        // Remove focus from other windows
        $('.floating-window').removeClass('floating-window-active');
        
        // Focus this window
        var window = windows[windowId];
        if (window) {
            window.element.addClass('floating-window-active');
            window.element.css('zIndex', ++zIndexCounter);
            activeWindow = windowId;
        }
    }
    
    function toggleMinimize(windowId) {
        var window = windows[windowId];
        if (!window) return;
        
        var content = window.element.find('.floating-window-content');
        var minimizeBtn = window.element.find('.floating-window-minimize');
        
        if (window.isMinimized) {
            // Restore
            content.show();
            window.element.css('height', window.originalHeight);
            minimizeBtn.html('−');
            minimizeBtn.attr('title', 'Minimize');
            window.isMinimized = false;
        } else {
            // Minimize
            window.originalHeight = window.element.height();
            content.hide();
            window.element.css('height', 'auto');
            minimizeBtn.html('□');
            minimizeBtn.attr('title', 'Restore');
            window.isMinimized = true;
        }
    }
    
    function closeWindow(windowId) {
        var window = windows[windowId];
        if (!window) return;
        
        // Trigger close event
        window.element.trigger('window-close', [windowId]);
        
        // Remove from DOM
        window.element.remove();
        
        // Clean up
        delete windows[windowId];
        
        if (activeWindow === windowId) {
            activeWindow = null;
        }
    }
    
    function getWindow(windowId) {
        return windows[windowId];
    }
    
    function getAllWindows() {
        return Object.keys(windows);
    }
    
    function positionWindow(windowId, x, y) {
        var window = windows[windowId];
        if (window) {
            window.element.css({ left: x, top: y });
        }
    }
    
    function resizeWindow(windowId, width, height) {
        var window = windows[windowId];
        if (window) {
            window.element.css({ width: width, height: height });
            if (!window.isMinimized) {
                window.originalHeight = height;
            }
        }
    }
    
    return {
        create: createWindow,
        close: closeWindow,
        focus: focusWindow,
        minimize: toggleMinimize,
        position: positionWindow,
        resize: resizeWindow,
        get: getWindow,
        getAll: getAllWindows
    };
})();