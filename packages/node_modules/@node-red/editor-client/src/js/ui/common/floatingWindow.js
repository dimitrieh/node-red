/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindow = (function() {

    let windows = {};
    let nextZIndex = 1000;
    let activeWindow = null;

    function create(options) {
        const config = Object.assign({
            id: 'floating-window-' + Date.now(),
            title: 'Floating Window',
            position: { x: 100, y: 100 },
            size: { width: 300, height: 400 },
            minimized: false,
            visible: true,
            resizable: true,
            draggable: true,
            minimizable: true,
            closeable: false
        }, options);

        // Create window container
        const windowElement = $(`
            <div id="${config.id}" class="red-ui-floating-window" style="
                position: absolute;
                left: ${config.position.x}px;
                top: ${config.position.y}px;
                width: ${config.size.width}px;
                height: ${config.size.height}px;
                z-index: ${nextZIndex++};
                background: #fff;
                border: 1px solid #999;
                border-radius: 4px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.3);
                display: ${config.visible ? 'flex' : 'none'};
                flex-direction: column;
                min-width: 200px;
                min-height: 100px;
            ">
                <div class="red-ui-floating-window-header" style="
                    background: #8f0000;
                    color: white;
                    padding: 8px 12px;
                    border-radius: 3px 3px 0 0;
                    cursor: move;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    user-select: none;
                    -webkit-user-select: none;
                    -moz-user-select: none;
                    font-size: 13px;
                    font-weight: 600;
                ">
                    <span class="red-ui-floating-window-title">${config.title}</span>
                    <div class="red-ui-floating-window-controls" style="display: flex; gap: 4px;">
                        ${config.minimizable ? '<button class="red-ui-floating-window-minimize" style="background: none; border: none; color: white; cursor: pointer; padding: 2px 6px; border-radius: 2px; font-size: 12px;" title="Minimize">−</button>' : ''}
                        ${config.closeable ? '<button class="red-ui-floating-window-close" style="background: none; border: none; color: white; cursor: pointer; padding: 2px 6px; border-radius: 2px; font-size: 12px;" title="Close">×</button>' : ''}
                    </div>
                </div>
                <div class="red-ui-floating-window-content" style="
                    flex: 1;
                    overflow: auto;
                    position: relative;
                "></div>
                ${config.resizable ? '<div class="red-ui-floating-window-resize-handle" style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; cursor: se-resize; background: linear-gradient(-45deg, transparent 0%, transparent 40%, #ccc 40%, #ccc 50%, transparent 50%, transparent 90%, #ccc 90%);"></div>' : ''}
            </div>
        `);

        // Append to main container
        windowElement.appendTo('#red-ui-main-container');

        const window = {
            id: config.id,
            element: windowElement,
            config: config,
            minimized: config.minimized,
            visible: config.visible,

            show: function() {
                this.element.show();
                this.visible = true;
                this.focus();
            },

            hide: function() {
                this.element.hide();
                this.visible = false;
            },

            minimize: function() {
                if (!this.minimized) {
                    this.element.find('.red-ui-floating-window-content').hide();
                    this.element.css('height', 'auto');
                    this.minimized = true;
                    this.saveState();
                }
            },

            restore: function() {
                if (this.minimized) {
                    this.element.find('.red-ui-floating-window-content').show();
                    this.element.css('height', this.config.size.height + 'px');
                    this.minimized = false;
                    this.saveState();
                }
            },

            focus: function() {
                // Bring window to front
                const currentZ = parseInt(this.element.css('z-index'));
                if (currentZ < nextZIndex - 1) {
                    this.element.css('z-index', nextZIndex++);
                }

                // Remove active class from other windows
                $('.red-ui-floating-window').removeClass('red-ui-floating-window-active').css('opacity', 0.9);
                
                // Add active class to this window
                this.element.addClass('red-ui-floating-window-active').css('opacity', 1);
                activeWindow = this;
            },

            setContent: function(content) {
                this.element.find('.red-ui-floating-window-content').empty().append(content);
            },

            setTitle: function(title) {
                this.element.find('.red-ui-floating-window-title').text(title);
            },

            setPosition: function(x, y) {
                this.config.position = { x, y };
                this.element.css({ left: x + 'px', top: y + 'px' });
                this.saveState();
            },

            setSize: function(width, height) {
                this.config.size = { width, height };
                this.element.css({ width: width + 'px', height: height + 'px' });
                this.saveState();
            },

            saveState: function() {
                const state = {
                    position: this.config.position,
                    size: this.config.size,
                    minimized: this.minimized,
                    visible: this.visible
                };
                try {
                    RED.settings.setLocal('floating-window-' + this.id, JSON.stringify(state));
                } catch (e) {
                    console.warn('Failed to save window state:', e);
                }
            },

            loadState: function() {
                try {
                    const saved = RED.settings.getLocal('floating-window-' + this.id);
                    if (saved) {
                        const state = JSON.parse(saved);
                        this.config.position = state.position || this.config.position;
                        this.config.size = state.size || this.config.size;
                        this.minimized = state.minimized || false;
                        this.visible = state.visible !== undefined ? state.visible : true;

                        // Apply loaded state
                        this.element.css({
                            left: this.config.position.x + 'px',
                            top: this.config.position.y + 'px',
                            width: this.config.size.width + 'px',
                            height: this.config.size.height + 'px',
                            display: this.visible ? 'flex' : 'none'
                        });

                        if (this.minimized) {
                            this.element.find('.red-ui-floating-window-content').hide();
                            this.element.css('height', 'auto');
                        }
                    }
                } catch (e) {
                    console.warn('Failed to load window state:', e);
                }
            },

            destroy: function() {
                this.element.remove();
                delete windows[this.id];
                if (activeWindow === this) {
                    activeWindow = null;
                }
            }
        };

        // Make window draggable
        if (config.draggable) {
            windowElement.find('.red-ui-floating-window-header').on('mousedown', function(e) {
                if ($(e.target).is('button')) { return; } // Don't drag when clicking buttons

                window.focus();
                
                const startX = e.pageX - window.config.position.x;
                const startY = e.pageY - window.config.position.y;

                function onMouseMove(e) {
                    const newX = Math.max(0, Math.min(e.pageX - startX, $(window).width() - 200));
                    const newY = Math.max(0, Math.min(e.pageY - startY, $(window).height() - 50));
                    window.setPosition(newX, newY);
                }

                function onMouseUp() {
                    $(document).off('mousemove', onMouseMove);
                    $(document).off('mouseup', onMouseUp);
                }

                $(document).on('mousemove', onMouseMove);
                $(document).on('mouseup', onMouseUp);
                
                e.preventDefault();
            });
        }

        // Make window resizable
        if (config.resizable) {
            windowElement.find('.red-ui-floating-window-resize-handle').on('mousedown', function(e) {
                window.focus();
                
                const startX = e.pageX;
                const startY = e.pageY;
                const startWidth = window.config.size.width;
                const startHeight = window.config.size.height;

                function onMouseMove(e) {
                    const newWidth = Math.max(200, startWidth + (e.pageX - startX));
                    const newHeight = Math.max(100, startHeight + (e.pageY - startY));
                    window.setSize(newWidth, newHeight);
                }

                function onMouseUp() {
                    $(document).off('mousemove', onMouseMove);
                    $(document).off('mouseup', onMouseUp);
                }

                $(document).on('mousemove', onMouseMove);
                $(document).on('mouseup', onMouseUp);
                
                e.preventDefault();
                e.stopPropagation();
            });
        }

        // Handle minimize button
        windowElement.find('.red-ui-floating-window-minimize').on('click', function(e) {
            e.stopPropagation();
            if (window.minimized) {
                window.restore();
            } else {
                window.minimize();
            }
        });

        // Handle close button
        windowElement.find('.red-ui-floating-window-close').on('click', function(e) {
            e.stopPropagation();
            window.hide();
        });

        // Handle window clicking for focus
        windowElement.on('mousedown', function() {
            window.focus();
        });

        // Load saved state
        window.loadState();

        // Store window reference
        windows[config.id] = window;

        return window;
    }

    function getWindow(id) {
        return windows[id];
    }

    function getAllWindows() {
        return Object.values(windows);
    }

    function closeAll() {
        Object.values(windows).forEach(window => window.hide());
    }

    function init() {
        // Add global styles for floating windows
        const style = $(`
            <style>
                .red-ui-floating-window {
                    font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
                    font-size: 13px;
                }
                .red-ui-floating-window-active {
                    box-shadow: 0 4px 20px rgba(0,0,0,0.4) !important;
                }
                .red-ui-floating-window-header button:hover {
                    background: rgba(255,255,255,0.2) !important;
                }
                .red-ui-floating-window-resize-handle:hover {
                    background: linear-gradient(-45deg, transparent 0%, transparent 40%, #999 40%, #999 50%, transparent 50%, transparent 90%, #999 90%) !important;
                }
            </style>
        `);
        style.appendTo('head');
    }

    return {
        init: init,
        create: create,
        getWindow: getWindow,
        getAllWindows: getAllWindows,
        closeAll: closeAll
    };
})();