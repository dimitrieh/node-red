/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindow = (function() {
    
    var windows = {};
    var highestZIndex = 1000;
    
    function createWindow(options) {
        var windowId = options.id;
        var title = options.title || 'Window';
        var content = options.content;
        var position = options.position || { x: 20, y: 80 };
        var size = options.size || { width: 300, height: 400 };
        var resizable = options.resizable !== false;
        var minimizable = options.minimizable !== false;
        
        // Create window container
        var windowContainer = $('<div>', {
            id: 'red-ui-floating-window-' + windowId,
            class: 'red-ui-floating-window'
        }).css({
            position: 'absolute',
            left: position.x + 'px',
            top: position.y + 'px',
            width: size.width + 'px',
            height: size.height + 'px',
            'z-index': ++highestZIndex,
            'background': '#fff',
            'border': '1px solid #ccc',
            'border-radius': '4px',
            'box-shadow': '0 4px 15px rgba(0,0,0,0.15)',
            'opacity': '1'
        });
        
        // Create title bar
        var titleBar = $('<div>', {
            class: 'red-ui-floating-window-titlebar'
        }).css({
            'background': '#8f0000',
            'color': 'white',
            'padding': '8px 12px',
            'border-radius': '4px 4px 0 0',
            'cursor': 'move',
            'user-select': 'none',
            'display': 'flex',
            'justify-content': 'space-between',
            'align-items': 'center',
            'font-weight': 'bold',
            'font-size': '12px'
        });
        
        var titleText = $('<span>').text(title);
        var titleControls = $('<div>').css({
            'display': 'flex',
            'gap': '4px'
        });
        
        // Minimize button
        if (minimizable) {
            var minimizeBtn = $('<button>', {
                class: 'red-ui-floating-window-minimize'
            }).css({
                'background': 'none',
                'border': 'none',
                'color': 'white',
                'cursor': 'pointer',
                'padding': '2px 6px',
                'border-radius': '2px',
                'font-size': '10px'
            }).html('&#x2212;'); // minus sign
            
            minimizeBtn.on('click', function(e) {
                e.stopPropagation();
                toggleMinimize(windowId);
            });
            
            titleControls.append(minimizeBtn);
        }
        
        titleBar.append(titleText, titleControls);
        
        // Create content area
        var contentArea = $('<div>', {
            class: 'red-ui-floating-window-content'
        }).css({
            'height': 'calc(100% - 32px)', // Adjust for title bar height
            'overflow': 'auto',
            'padding': '0'
        });
        
        if (content) {
            contentArea.append(content);
        }
        
        windowContainer.append(titleBar, contentArea);
        
        // Make draggable
        makeDraggable(windowContainer, titleBar);
        
        // Make resizable
        if (resizable) {
            makeResizable(windowContainer);
        }
        
        // Focus handling
        windowContainer.on('mousedown', function() {
            bringToFront(windowId);
        });
        
        // Store window reference
        windows[windowId] = {
            container: windowContainer,
            titleBar: titleBar,
            titleText: titleText,
            contentArea: contentArea,
            minimized: false,
            originalSize: { width: size.width, height: size.height },
            position: position,
            size: size
        };
        
        // Append to main container
        $('#red-ui-editor').append(windowContainer);
        
        // Load saved state
        loadWindowState(windowId);
        
        return {
            container: windowContainer,
            contentArea: contentArea,
            setTitle: function(newTitle) {
                titleText.text(newTitle);
            },
            minimize: function() {
                toggleMinimize(windowId);
            },
            bringToFront: function() {
                bringToFront(windowId);
            }
        };
    }
    
    function makeDraggable(windowContainer, titleBar) {
        var isDragging = false;
        var startX, startY;
        
        titleBar.on('mousedown', function(e) {
            if (e.target.tagName === 'BUTTON') return;
            
            isDragging = true;
            startX = e.clientX - parseInt(windowContainer.css('left'), 10);
            startY = e.clientY - parseInt(windowContainer.css('top'), 10);
            
            $(document).on('mousemove.floating-window', function(e) {
                if (!isDragging) return;
                
                var newX = e.clientX - startX;
                var newY = e.clientY - startY;
                
                // Keep window within screen bounds
                var maxX = $(window).width() - windowContainer.width();
                var maxY = $(window).height() - windowContainer.height();
                
                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));
                
                windowContainer.css({
                    left: newX + 'px',
                    top: newY + 'px'
                });
            });
            
            $(document).on('mouseup.floating-window', function() {
                isDragging = false;
                $(document).off('mousemove.floating-window mouseup.floating-window');
                
                // Save position
                var windowId = windowContainer.attr('id').replace('red-ui-floating-window-', '');
                saveWindowState(windowId);
            });
        });
    }
    
    function makeResizable(windowContainer) {
        // Add resize handle
        var resizeHandle = $('<div>', {
            class: 'red-ui-floating-window-resize'
        }).css({
            position: 'absolute',
            bottom: '0',
            right: '0',
            width: '12px',
            height: '12px',
            cursor: 'se-resize',
            'background': 'linear-gradient(-45deg, transparent 0%, transparent 46%, #ccc 46%, #ccc 50%, transparent 50%, transparent 96%, #ccc 96%)',
            'z-index': '1'
        });
        
        windowContainer.append(resizeHandle);
        
        resizeHandle.on('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var startWidth = windowContainer.width();
            var startHeight = windowContainer.height();
            var startX = e.clientX;
            var startY = e.clientY;
            
            $(document).on('mousemove.resize', function(e) {
                var newWidth = Math.max(200, startWidth + (e.clientX - startX));
                var newHeight = Math.max(150, startHeight + (e.clientY - startY));
                
                windowContainer.css({
                    width: newWidth + 'px',
                    height: newHeight + 'px'
                });
            });
            
            $(document).on('mouseup.resize', function() {
                $(document).off('mousemove.resize mouseup.resize');
                
                // Save size
                var windowId = windowContainer.attr('id').replace('red-ui-floating-window-', '');
                saveWindowState(windowId);
            });
        });
    }
    
    function toggleMinimize(windowId) {
        var window = windows[windowId];
        if (!window) return;
        
        if (window.minimized) {
            // Restore
            window.container.css({
                height: window.originalSize.height + 'px'
            });
            window.contentArea.show();
            window.minimized = false;
        } else {
            // Minimize
            window.originalSize = {
                width: window.container.width(),
                height: window.container.height()
            };
            window.container.css({
                height: '32px' // Just title bar height
            });
            window.contentArea.hide();
            window.minimized = true;
        }
        
        saveWindowState(windowId);
    }
    
    function bringToFront(windowId) {
        var window = windows[windowId];
        if (!window) return;
        
        window.container.css('z-index', ++highestZIndex);
        
        // Update opacity for all windows
        Object.keys(windows).forEach(function(id) {
            windows[id].container.css('opacity', id === windowId ? '1' : '0.9');
        });
    }
    
    function saveWindowState(windowId) {
        var window = windows[windowId];
        if (!window) return;
        
        var state = {
            position: {
                x: parseInt(window.container.css('left'), 10),
                y: parseInt(window.container.css('top'), 10)
            },
            size: {
                width: window.container.width(),
                height: window.container.height()
            },
            minimized: window.minimized
        };
        
        localStorage.setItem('red-ui-floating-window-' + windowId, JSON.stringify(state));
    }
    
    function loadWindowState(windowId) {
        var stored = localStorage.getItem('red-ui-floating-window-' + windowId);
        if (!stored) return;
        
        try {
            var state = JSON.parse(stored);
            var window = windows[windowId];
            
            if (state.position) {
                window.container.css({
                    left: state.position.x + 'px',
                    top: state.position.y + 'px'
                });
            }
            
            if (state.size) {
                window.container.css({
                    width: state.size.width + 'px',
                    height: state.size.height + 'px'
                });
            }
            
            if (state.minimized) {
                toggleMinimize(windowId);
            }
        } catch (e) {
            // Ignore invalid stored state
        }
    }
    
    return {
        create: createWindow,
        bringToFront: bringToFront,
        minimize: function(windowId) {
            toggleMinimize(windowId);
        }
    };
})();