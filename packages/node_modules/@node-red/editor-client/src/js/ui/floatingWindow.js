/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindow = (function() {
    
    function makeFloatingWindow(element, options) {
        options = options || {};
        const $element = $(element);
        
        // Set default options
        const config = {
            minWidth: options.minWidth || 200,
            minHeight: options.minHeight || 100,
            maxWidth: options.maxWidth || 800,
            maxHeight: options.maxHeight || 600,
            defaultWidth: options.defaultWidth || 300,
            defaultHeight: options.defaultHeight || 400,
            title: options.title || 'Window',
            resizable: options.resizable !== false,
            draggable: options.draggable !== false,
            collapsible: options.collapsible !== false,
            position: options.position || { top: 50, left: 50 }
        };
        
        // Get original content
        const originalContent = $element.html();
        const originalId = $element.attr('id');
        
        // Create floating window structure
        const windowId = originalId + '-floating';
        const windowHtml = `
            <div id="${windowId}" class="red-ui-floating-window" style="
                position: fixed;
                top: ${config.position.top}px;
                left: ${config.position.left}px;
                width: ${config.defaultWidth}px;
                height: ${config.defaultHeight}px;
                min-width: ${config.minWidth}px;
                min-height: ${config.minHeight}px;
                max-width: ${config.maxWidth}px;
                max-height: ${config.maxHeight}px;
                z-index: 1000;
                background: var(--red-ui-primary-background);
                border: 1px solid var(--red-ui-primary-border-color);
                border-radius: 4px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                display: flex;
                flex-direction: column;
            ">
                <div class="red-ui-floating-window-header" style="
                    background: var(--red-ui-palette-header-background);
                    color: var(--red-ui-palette-header-color);
                    padding: 8px 12px;
                    cursor: move;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid var(--red-ui-primary-border-color);
                    user-select: none;
                ">
                    <span class="red-ui-floating-window-title">${config.title}</span>
                    <div class="red-ui-floating-window-controls">
                        ${config.collapsible ? '<button class="red-ui-floating-window-collapse" style="background: none; border: none; color: inherit; cursor: pointer; padding: 2px 4px; margin-left: 4px;"><i class="fa fa-minus"></i></button>' : ''}
                    </div>
                </div>
                <div class="red-ui-floating-window-content" style="
                    flex: 1;
                    overflow: hidden;
                    position: relative;
                ">
                    ${originalContent}
                </div>
                ${config.resizable ? '<div class="red-ui-floating-window-resize" style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; cursor: nw-resize; background: linear-gradient(-45deg, transparent 40%, var(--red-ui-primary-border-color) 40%, var(--red-ui-primary-border-color) 50%, transparent 50%);"></div>' : ''}
            </div>
        `;
        
        // Replace original element with floating window
        $element.replaceWith(windowHtml);
        
        const $window = $('#' + windowId);
        const $header = $window.find('.red-ui-floating-window-header');
        const $content = $window.find('.red-ui-floating-window-content');
        const $resizer = $window.find('.red-ui-floating-window-resize');
        const $collapseBtn = $window.find('.red-ui-floating-window-collapse');
        
        let isCollapsed = false;
        let originalHeight = config.defaultHeight;
        
        // Make draggable
        if (config.draggable) {
            let isDragging = false;
            let dragOffset = { x: 0, y: 0 };
            
            $header.on('mousedown', function(e) {
                isDragging = true;
                const windowOffset = $window.offset();
                dragOffset.x = e.clientX - windowOffset.left;
                dragOffset.y = e.clientY - windowOffset.top;
                $window.css('z-index', 1001);
                
                $(document).on('mousemove.floating-drag', function(e) {
                    if (isDragging) {
                        $window.css({
                            left: e.clientX - dragOffset.x + 'px',
                            top: e.clientY - dragOffset.y + 'px'
                        });
                    }
                });
                
                $(document).on('mouseup.floating-drag', function() {
                    isDragging = false;
                    $(document).off('mousemove.floating-drag mouseup.floating-drag');
                    $window.css('z-index', 1000);
                });
                
                e.preventDefault();
            });
        }
        
        // Make resizable
        if (config.resizable) {
            let isResizing = false;
            
            $resizer.on('mousedown', function(e) {
                isResizing = true;
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = $window.width();
                const startHeight = $window.height();
                
                $(document).on('mousemove.floating-resize', function(e) {
                    if (isResizing) {
                        const newWidth = Math.min(config.maxWidth, Math.max(config.minWidth, startWidth + (e.clientX - startX)));
                        const newHeight = Math.min(config.maxHeight, Math.max(config.minHeight, startHeight + (e.clientY - startY)));
                        
                        $window.css({
                            width: newWidth + 'px',
                            height: newHeight + 'px'
                        });
                        
                        if (!isCollapsed) {
                            originalHeight = newHeight;
                        }
                    }
                });
                
                $(document).on('mouseup.floating-resize', function() {
                    isResizing = false;
                    $(document).off('mousemove.floating-resize mouseup.floating-resize');
                });
                
                e.preventDefault();
                e.stopPropagation();
            });
        }
        
        // Collapse functionality
        if (config.collapsible) {
            $collapseBtn.on('click', function(e) {
                if (isCollapsed) {
                    // Expand
                    $window.css('height', originalHeight + 'px');
                    $content.show();
                    $resizer.show();
                    $(this).find('i').removeClass('fa-plus').addClass('fa-minus');
                } else {
                    // Collapse
                    originalHeight = $window.height();
                    $window.css('height', '32px');
                    $content.hide();
                    $resizer.hide();
                    $(this).find('i').removeClass('fa-minus').addClass('fa-plus');
                }
                isCollapsed = !isCollapsed;
                e.stopPropagation();
            });
        }
        
        // Return window API
        return {
            element: $window,
            show: function() { $window.show(); },
            hide: function() { $window.hide(); },
            toggle: function() { $window.toggle(); },
            position: function(pos) {
                if (pos) {
                    $window.css({ top: pos.top + 'px', left: pos.left + 'px' });
                } else {
                    const offset = $window.offset();
                    return { top: offset.top, left: offset.left };
                }
            },
            size: function(size) {
                if (size) {
                    $window.css({ width: size.width + 'px', height: size.height + 'px' });
                } else {
                    return { width: $window.width(), height: $window.height() };
                }
            },
            content: function() { return $content; }
        };
    }
    
    return {
        create: makeFloatingWindow
    };
})();