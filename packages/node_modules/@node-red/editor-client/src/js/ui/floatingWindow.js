/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindow = (function() {

    var windows = {};
    var zIndexCounter = 1000;
    
    function createFloatingWindow(options) {
        var id = options.id;
        var title = options.title || 'Window';
        var content = options.content;
        var initialWidth = options.width || 300;
        var initialHeight = options.height || 400;
        var minWidth = options.minWidth || 200;
        var minHeight = options.minHeight || 150;
        var maxWidth = options.maxWidth || window.innerWidth;
        var maxHeight = options.maxHeight || window.innerHeight;
        var resizable = options.resizable !== false;
        var minimizable = options.minimizable !== false;
        
        // Load saved position or use defaults
        var savedState = getSavedWindowState(id);
        var initialX = savedState.x || 50;
        var initialY = savedState.y || 50;
        var width = savedState.width || initialWidth;
        var height = savedState.height || initialHeight;
        var minimized = savedState.minimized || false;
        
        // Create window container
        var windowEl = $('<div class="red-ui-floating-window" id="red-ui-floating-window-' + id + '"></div>');
        windowEl.css({
            position: 'absolute',
            left: initialX + 'px',
            top: initialY + 'px',
            width: width + 'px',
            height: height + 'px',
            zIndex: ++zIndexCounter,
            backgroundColor: '#f3f3f3',
            border: '1px solid #999',
            borderRadius: '4px',
            boxShadow: '0 4px 8px rgba(0,0,0,0.2)',
            display: minimized ? 'none' : 'block'
        });
        
        // Create title bar
        var titleBar = $('<div class="red-ui-floating-window-titlebar"></div>');
        titleBar.css({
            height: '32px',
            backgroundColor: '#e3e3e3',
            borderBottom: '1px solid #999',
            borderRadius: '3px 3px 0 0',
            cursor: 'move',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '0 8px'
        });
        
        // Title text
        var titleText = $('<span class="red-ui-floating-window-title"></span>').text(title);
        titleText.css({
            fontWeight: 'bold',
            fontSize: '13px',
            userSelect: 'none'
        });
        
        // Window controls
        var controls = $('<div class="red-ui-floating-window-controls"></div>');
        controls.css({
            display: 'flex',
            gap: '4px'
        });
        
        if (minimizable) {
            var minimizeBtn = $('<button class="red-ui-floating-window-minimize" title="Minimize">âˆ’</button>');
            minimizeBtn.css({
                width: '20px',
                height: '20px',
                border: '1px solid #999',
                backgroundColor: '#fff',
                cursor: 'pointer',
                fontSize: '12px',
                borderRadius: '2px'
            });
            minimizeBtn.on('click', function() {
                toggleMinimize(id);
            });
            controls.append(minimizeBtn);
        }
        
        titleBar.append(titleText).append(controls);
        
        // Create content area
        var contentArea = $('<div class="red-ui-floating-window-content"></div>');
        contentArea.css({
            position: 'absolute',
            top: '33px',
            left: '0',
            right: '0',
            bottom: '0',
            overflow: 'hidden'
        });
        
        // Move content into content area
        if (content) {
            content.appendTo(contentArea);
            content.css({
                width: '100%',
                height: '100%',
                overflow: 'auto'
            });
        }
        
        windowEl.append(titleBar).append(contentArea);
        
        // Add to DOM
        windowEl.appendTo('#red-ui-main-container');
        
        // Make draggable
        titleBar.on('mousedown', function(e) {
            if (e.target.tagName === 'BUTTON') return; // Don't drag on buttons
            bringToFront(id);
            startDragging(e, windowEl);
        });
        
        // Make resizable if enabled
        if (resizable) {
            addResizeHandles(windowEl, minWidth, minHeight, maxWidth, maxHeight);
        }
        
        // Click to bring to front
        windowEl.on('mousedown', function() {
            bringToFront(id);
        });
        
        // Store window reference
        windows[id] = {
            element: windowEl,
            titleBar: titleBar,
            contentArea: contentArea,
            minimized: minimized,
            options: options
        };
        
        return {
            element: windowEl,
            show: function() { showWindow(id); },
            hide: function() { hideWindow(id); },
            minimize: function() { minimizeWindow(id); },
            restore: function() { restoreWindow(id); },
            bringToFront: function() { bringToFront(id); },
            destroy: function() { destroyWindow(id); }
        };
    }
    
    function startDragging(e, windowEl) {
        var startX = e.pageX - parseInt(windowEl.css('left'));
        var startY = e.pageY - parseInt(windowEl.css('top'));
        
        function onMouseMove(e) {
            var newX = e.pageX - startX;
            var newY = e.pageY - startY;
            
            // Constrain to viewport
            newX = Math.max(0, Math.min(newX, window.innerWidth - 100)); // Keep at least 100px visible
            newY = Math.max(0, Math.min(newY, window.innerHeight - 32)); // Keep title bar visible
            
            windowEl.css({
                left: newX + 'px',
                top: newY + 'px'
            });
        }
        
        function onMouseUp() {
            $(document).off('mousemove', onMouseMove);
            $(document).off('mouseup', onMouseUp);
            
            // Save position
            var id = windowEl.attr('id').replace('red-ui-floating-window-', '');
            saveWindowState(id, {
                x: parseInt(windowEl.css('left')),
                y: parseInt(windowEl.css('top')),
                width: parseInt(windowEl.css('width')),
                height: parseInt(windowEl.css('height'))
            });
        }
        
        $(document).on('mousemove', onMouseMove);
        $(document).on('mouseup', onMouseUp);
    }
    
    function addResizeHandles(windowEl, minWidth, minHeight, maxWidth, maxHeight) {
        var resizeHandle = $('<div class="red-ui-floating-window-resize-handle"></div>');
        resizeHandle.css({
            position: 'absolute',
            bottom: '0',
            right: '0',
            width: '12px',
            height: '12px',
            cursor: 'nw-resize',
            background: 'linear-gradient(-45deg, transparent 30%, #999 30%, #999 40%, transparent 40%)'
        });
        
        resizeHandle.on('mousedown', function(e) {
            e.preventDefault();
            var startWidth = parseInt(windowEl.css('width'));
            var startHeight = parseInt(windowEl.css('height'));
            var startX = e.pageX;
            var startY = e.pageY;
            
            function onMouseMove(e) {
                var newWidth = Math.max(minWidth, Math.min(maxWidth, startWidth + (e.pageX - startX)));
                var newHeight = Math.max(minHeight, Math.min(maxHeight, startHeight + (e.pageY - startY)));
                
                windowEl.css({
                    width: newWidth + 'px',
                    height: newHeight + 'px'
                });
                
                // Trigger resize event for content
                windowEl.trigger('windowResize');
            }
            
            function onMouseUp() {
                $(document).off('mousemove', onMouseMove);
                $(document).off('mouseup', onMouseUp);
                
                // Save size
                var id = windowEl.attr('id').replace('red-ui-floating-window-', '');
                saveWindowState(id, {
                    x: parseInt(windowEl.css('left')),
                    y: parseInt(windowEl.css('top')),
                    width: parseInt(windowEl.css('width')),
                    height: parseInt(windowEl.css('height'))
                });
            }
            
            $(document).on('mousemove', onMouseMove);
            $(document).on('mouseup', onMouseUp);
        });
        
        windowEl.append(resizeHandle);
    }
    
    function bringToFront(id) {
        var window = windows[id];
        if (window) {
            window.element.css('zIndex', ++zIndexCounter);
        }
    }
    
    function toggleMinimize(id) {
        var window = windows[id];
        if (window) {
            if (window.minimized) {
                restoreWindow(id);
            } else {
                minimizeWindow(id);
            }
        }
    }
    
    function minimizeWindow(id) {
        var window = windows[id];
        if (window) {
            window.element.fadeOut(200);
            window.minimized = true;
            saveWindowState(id, { minimized: true });
        }
    }
    
    function restoreWindow(id) {
        var window = windows[id];
        if (window) {
            window.element.fadeIn(200);
            window.minimized = false;
            bringToFront(id);
            saveWindowState(id, { minimized: false });
        }
    }
    
    function showWindow(id) {
        var window = windows[id];
        if (window) {
            window.element.show();
            bringToFront(id);
        }
    }
    
    function hideWindow(id) {
        var window = windows[id];
        if (window) {
            window.element.hide();
        }
    }
    
    function destroyWindow(id) {
        var window = windows[id];
        if (window) {
            window.element.remove();
            delete windows[id];
            localStorage.removeItem('red-ui-floating-window-' + id);
        }
    }
    
    function saveWindowState(id, state) {
        var currentState = getSavedWindowState(id);
        var newState = Object.assign(currentState, state);
        localStorage.setItem('red-ui-floating-window-' + id, JSON.stringify(newState));
    }
    
    function getSavedWindowState(id) {
        try {
            var saved = localStorage.getItem('red-ui-floating-window-' + id);
            return saved ? JSON.parse(saved) : {};
        } catch (e) {
            return {};
        }
    }
    
    return {
        create: createFloatingWindow,
        get: function(id) { return windows[id]; },
        show: showWindow,
        hide: hideWindow,
        minimize: minimizeWindow,
        restore: restoreWindow,
        destroy: destroyWindow,
        bringToFront: bringToFront
    };

})();