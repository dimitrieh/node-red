/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindow = (function() {
    var windows = {};
    var zIndexCounter = 1000;
    var dragData = null;
    var resizeData = null;
    var overlay = null;

    function init() {
        overlay = $('<div class="red-ui-floating-window-overlay"></div>').appendTo('body');
        
        $(document).on('mousedown', handleDocumentMouseDown);
        $(document).on('mousemove', handleDocumentMouseMove);
        $(document).on('mouseup', handleDocumentMouseUp);
        $(window).on('resize', handleWindowResize);
    }

    function handleDocumentMouseDown(e) {
        var windowEl = $(e.target).closest('.red-ui-floating-window');
        if (windowEl.length > 0) {
            activateWindow(windowEl.attr('data-window-id'));
        }
    }

    function handleDocumentMouseMove(e) {
        if (dragData) {
            handleDrag(e);
        } else if (resizeData) {
            handleResize(e);
        }
    }

    function handleDocumentMouseUp(e) {
        if (dragData || resizeData) {
            stopDragging();
            stopResizing();
        }
    }

    function handleWindowResize() {
        Object.keys(windows).forEach(function(windowId) {
            constrainToViewport(windowId);
        });
    }

    function create(options) {
        var windowId = options.id || generateId();
        
        if (windows[windowId]) {
            return windows[windowId];
        }

        var defaultOptions = {
            title: 'Window',
            width: 300,
            height: 400,
            x: 100,
            y: 100,
            minimizable: true,
            resizable: true,
            className: '',
            content: null
        };

        options = $.extend(defaultOptions, options);
        options.id = windowId;

        var windowEl = $('<div class="red-ui-floating-window ' + options.className + '" data-window-id="' + windowId + '"></div>');
        
        var header = $('<div class="red-ui-floating-window-header"></div>').appendTo(windowEl);
        var title = $('<div class="red-ui-floating-window-title">' + RED.utils.sanitize(options.title) + '</div>').appendTo(header);
        var controls = $('<div class="red-ui-floating-window-controls"></div>').appendTo(header);
        
        if (options.minimizable) {
            var minimizeBtn = $('<button class="red-ui-floating-window-control" title="Minimize"><i class="fa fa-minus"></i></button>').appendTo(controls);
            minimizeBtn.on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleMinimize(windowId);
            });
        }

        var content = $('<div class="red-ui-floating-window-content"></div>').appendTo(windowEl);
        
        if (options.resizable) {
            $('<div class="red-ui-floating-window-resize-handle red-ui-floating-window-resize-e"></div>').appendTo(windowEl);
            $('<div class="red-ui-floating-window-resize-handle red-ui-floating-window-resize-s"></div>').appendTo(windowEl);
            $('<div class="red-ui-floating-window-resize-handle red-ui-floating-window-resize-se"></div>').appendTo(windowEl);
        }

        if (options.content) {
            if (typeof options.content === 'string') {
                content.html(options.content);
            } else {
                content.append(options.content);
            }
        }

        windowEl.css({
            width: options.width + 'px',
            height: options.height + 'px',
            left: options.x + 'px',
            top: options.y + 'px',
            zIndex: ++zIndexCounter
        });

        $('body').append(windowEl);

        setupDragHandlers(windowEl, header);
        if (options.resizable) {
            setupResizeHandlers(windowEl);
        }

        var windowObj = {
            id: windowId,
            element: windowEl,
            options: options,
            isMinimized: false,
            originalHeight: options.height
        };

        windows[windowId] = windowObj;

        restorePosition(windowId);
        constrainToViewport(windowId);

        return windowObj;
    }

    function setupDragHandlers(windowEl, header) {
        header.on('mousedown', function(e) {
            if ($(e.target).closest('.red-ui-floating-window-controls').length > 0) {
                return;
            }
            
            startDragging(windowEl, e);
        });
    }

    function setupResizeHandlers(windowEl) {
        windowEl.find('.red-ui-floating-window-resize-handle').on('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var handle = $(this);
            var direction = '';
            
            if (handle.hasClass('red-ui-floating-window-resize-se')) {
                direction = 'se';
            } else if (handle.hasClass('red-ui-floating-window-resize-s')) {
                direction = 's';
            } else if (handle.hasClass('red-ui-floating-window-resize-e')) {
                direction = 'e';
            }
            
            startResizing(windowEl, e, direction);
        });
    }

    function startDragging(windowEl, e) {
        var windowId = windowEl.attr('data-window-id');
        var offset = windowEl.offset();
        
        dragData = {
            windowId: windowId,
            startX: e.clientX,
            startY: e.clientY,
            windowStartX: offset.left,
            windowStartY: offset.top
        };
        
        overlay.addClass('red-ui-floating-window-dragging').show();
        activateWindow(windowId);
    }

    function startResizing(windowEl, e, direction) {
        var windowId = windowEl.attr('data-window-id');
        var offset = windowEl.offset();
        var width = windowEl.outerWidth();
        var height = windowEl.outerHeight();
        
        resizeData = {
            windowId: windowId,
            direction: direction,
            startX: e.clientX,
            startY: e.clientY,
            windowStartX: offset.left,
            windowStartY: offset.top,
            windowStartWidth: width,
            windowStartHeight: height
        };
        
        overlay.addClass('red-ui-floating-window-resizing').show();
        activateWindow(windowId);
    }

    function handleDrag(e) {
        if (!dragData) return;
        
        var deltaX = e.clientX - dragData.startX;
        var deltaY = e.clientY - dragData.startY;
        
        var newX = dragData.windowStartX + deltaX;
        var newY = dragData.windowStartY + deltaY;
        
        var windowEl = $('#red-ui-floating-window-' + dragData.windowId);
        if (windowEl.length === 0) {
            windowEl = $('.red-ui-floating-window[data-window-id="' + dragData.windowId + '"]');
        }
        
        windowEl.css({
            left: newX + 'px',
            top: newY + 'px'
        });
    }

    function handleResize(e) {
        if (!resizeData) return;
        
        var deltaX = e.clientX - resizeData.startX;
        var deltaY = e.clientY - resizeData.startY;
        
        var windowEl = $('.red-ui-floating-window[data-window-id="' + resizeData.windowId + '"]');
        var newWidth = resizeData.windowStartWidth;
        var newHeight = resizeData.windowStartHeight;
        
        if (resizeData.direction.includes('e')) {
            newWidth = Math.max(200, resizeData.windowStartWidth + deltaX);
        }
        if (resizeData.direction.includes('s')) {
            newHeight = Math.max(150, resizeData.windowStartHeight + deltaY);
        }
        
        windowEl.css({
            width: newWidth + 'px',
            height: newHeight + 'px'
        });
        
        windows[resizeData.windowId].options.width = newWidth;
        windows[resizeData.windowId].options.height = newHeight;
    }

    function stopDragging() {
        if (dragData) {
            savePosition(dragData.windowId);
            constrainToViewport(dragData.windowId);
            dragData = null;
        }
        overlay.removeClass('red-ui-floating-window-dragging').hide();
    }

    function stopResizing() {
        if (resizeData) {
            savePosition(resizeData.windowId);
            resizeData = null;
        }
        overlay.removeClass('red-ui-floating-window-resizing').hide();
    }

    function activateWindow(windowId) {
        if (!windows[windowId]) return;
        
        $('.red-ui-floating-window').removeClass('red-ui-floating-window-active');
        windows[windowId].element.addClass('red-ui-floating-window-active');
        windows[windowId].element.css('z-index', ++zIndexCounter);
    }

    function toggleMinimize(windowId) {
        if (!windows[windowId]) return;
        
        var windowObj = windows[windowId];
        var windowEl = windowObj.element;
        
        if (windowObj.isMinimized) {
            windowEl.removeClass('red-ui-floating-window-minimized');
            windowEl.css('height', windowObj.originalHeight + 'px');
            windowObj.isMinimized = false;
        } else {
            windowObj.originalHeight = windowEl.outerHeight();
            windowEl.addClass('red-ui-floating-window-minimized');
            windowObj.isMinimized = true;
        }
        
        savePosition(windowId);
    }

    function show(windowId) {
        if (windows[windowId]) {
            windows[windowId].element.show();
            activateWindow(windowId);
        }
    }

    function hide(windowId) {
        if (windows[windowId]) {
            windows[windowId].element.hide();
        }
    }

    function destroy(windowId) {
        if (windows[windowId]) {
            windows[windowId].element.remove();
            delete windows[windowId];
        }
    }

    function constrainToViewport(windowId) {
        if (!windows[windowId]) return;
        
        var windowEl = windows[windowId].element;
        var windowWidth = windowEl.outerWidth();
        var windowHeight = windowEl.outerHeight();
        var viewportWidth = $(window).width();
        var viewportHeight = $(window).height();
        
        var currentLeft = parseInt(windowEl.css('left'), 10);
        var currentTop = parseInt(windowEl.css('top'), 10);
        
        var newLeft = Math.max(0, Math.min(currentLeft, viewportWidth - windowWidth));
        var newTop = Math.max(0, Math.min(currentTop, viewportHeight - windowHeight));
        
        if (newLeft !== currentLeft || newTop !== currentTop) {
            windowEl.css({
                left: newLeft + 'px',
                top: newTop + 'px'
            });
            windows[windowId].options.x = newLeft;
            windows[windowId].options.y = newTop;
        }
    }

    function savePosition(windowId) {
        if (!windows[windowId]) return;
        
        var windowEl = windows[windowId].element;
        var offset = windowEl.offset();
        
        var positions = JSON.parse(localStorage.getItem('red-ui-floating-windows') || '{}');
        positions[windowId] = {
            x: offset.left,
            y: offset.top,
            width: windowEl.outerWidth(),
            height: windowEl.outerHeight(),
            minimized: windows[windowId].isMinimized
        };
        localStorage.setItem('red-ui-floating-windows', JSON.stringify(positions));
    }

    function restorePosition(windowId) {
        if (!windows[windowId]) return;
        
        var positions = JSON.parse(localStorage.getItem('red-ui-floating-windows') || '{}');
        var saved = positions[windowId];
        
        if (saved) {
            var windowEl = windows[windowId].element;
            windowEl.css({
                left: saved.x + 'px',
                top: saved.y + 'px',
                width: saved.width + 'px',
                height: saved.height + 'px'
            });
            
            windows[windowId].options.x = saved.x;
            windows[windowId].options.y = saved.y;
            windows[windowId].options.width = saved.width;
            windows[windowId].options.height = saved.height;
            
            if (saved.minimized) {
                toggleMinimize(windowId);
            }
        }
    }

    function generateId() {
        return 'window-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    return {
        init: init,
        create: create,
        show: show,
        hide: hide,
        destroy: destroy,
        activate: activateWindow,
        minimize: toggleMinimize
    };
})();