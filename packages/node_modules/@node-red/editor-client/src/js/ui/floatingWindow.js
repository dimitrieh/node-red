/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindow = (function() {

    var windows = {};
    var maxZIndex = 1000;
    var dragState = null;
    var resizeState = null;

    function createFloatingWindow(options) {
        var windowId = options.id || 'floating-window-' + Date.now();
        var title = options.title || 'Window';
        var width = options.width || 300;
        var height = options.height || 400;
        var x = options.x !== undefined ? options.x : 100;
        var y = options.y !== undefined ? options.y : 100;
        var minWidth = options.minWidth || 200;
        var minHeight = options.minHeight || 150;
        var resizable = options.resizable !== false;
        var minimizable = options.minimizable !== false;

        // Load saved position and size from localStorage if available
        var saved = localStorage.getItem('floating-window-' + windowId);
        if (saved) {
            try {
                var savedState = JSON.parse(saved);
                x = savedState.x || x;
                y = savedState.y || y;
                width = savedState.width || width;
                height = savedState.height || height;
            } catch(e) {
                // Ignore invalid saved state
            }
        }

        var windowElement = $('<div>', {
            id: windowId,
            class: 'red-ui-floating-window',
            css: {
                position: 'absolute',
                left: x + 'px',
                top: y + 'px',
                width: width + 'px',
                height: height + 'px',
                zIndex: ++maxZIndex,
                border: '1px solid #ccc',
                borderRadius: '4px',
                backgroundColor: '#f9f9f9',
                boxShadow: '0 4px 8px rgba(0,0,0,0.1)',
                display: 'flex',
                flexDirection: 'column',
                overflow: 'hidden'
            }
        });

        // Title bar
        var titleBar = $('<div>', {
            class: 'red-ui-floating-window-titlebar',
            css: {
                backgroundColor: '#357abd',
                color: 'white',
                padding: '8px 12px',
                cursor: 'move',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                userSelect: 'none',
                fontSize: '14px',
                fontWeight: 'bold'
            }
        });

        var titleText = $('<span>').text(title);
        titleBar.append(titleText);

        // Title bar controls
        var controls = $('<div>', {
            class: 'red-ui-floating-window-controls',
            css: {
                display: 'flex',
                gap: '4px'
            }
        });

        if (minimizable) {
            var minimizeBtn = $('<button>', {
                class: 'red-ui-floating-window-minimize',
                text: 'âˆ’',
                css: {
                    border: 'none',
                    background: 'transparent',
                    color: 'white',
                    cursor: 'pointer',
                    padding: '2px 6px',
                    borderRadius: '2px'
                }
            }).on('click', function(e) {
                e.stopPropagation();
                toggleMinimize(windowId);
            }).on('mouseenter', function() {
                $(this).css('backgroundColor', 'rgba(255,255,255,0.2)');
            }).on('mouseleave', function() {
                $(this).css('backgroundColor', 'transparent');
            });
            controls.append(minimizeBtn);
        }

        titleBar.append(controls);
        windowElement.append(titleBar);

        // Content area
        var content = $('<div>', {
            class: 'red-ui-floating-window-content',
            css: {
                flex: '1',
                padding: '0',
                overflow: 'auto',
                backgroundColor: '#ffffff'
            }
        });

        if (options.content) {
            if (typeof options.content === 'string') {
                content.html(options.content);
            } else {
                content.append(options.content);
            }
        }

        windowElement.append(content);

        // Resize handle (if resizable)
        if (resizable) {
            var resizeHandle = $('<div>', {
                class: 'red-ui-floating-window-resize-handle',
                css: {
                    position: 'absolute',
                    bottom: '0',
                    right: '0',
                    width: '12px',
                    height: '12px',
                    cursor: 'se-resize',
                    backgroundColor: 'transparent'
                }
            });
            windowElement.append(resizeHandle);

            // Add resize functionality
            resizeHandle.on('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                startResize(windowId, e);
            });
        }

        // Add drag functionality to title bar
        titleBar.on('mousedown', function(e) {
            if (e.target.tagName === 'BUTTON') return;
            e.preventDefault();
            startDrag(windowId, e);
        });

        // Click to focus functionality
        windowElement.on('mousedown', function(e) {
            focusWindow(windowId);
        });

        // Add to DOM
        $('#red-ui-main-container').append(windowElement);

        // Store window reference
        windows[windowId] = {
            element: windowElement,
            titleBar: titleBar,
            content: content,
            isMinimized: false,
            originalHeight: height,
            minWidth: minWidth,
            minHeight: minHeight
        };

        // Ensure window is within viewport bounds
        constrainToViewport(windowId);

        return {
            id: windowId,
            element: windowElement,
            content: content,
            show: function() { showWindow(windowId); },
            hide: function() { hideWindow(windowId); },
            focus: function() { focusWindow(windowId); },
            destroy: function() { destroyWindow(windowId); },
            setTitle: function(newTitle) { titleText.text(newTitle); },
            getPosition: function() { 
                var pos = windowElement.position();
                return { x: pos.left, y: pos.top };
            },
            getSize: function() { 
                return { width: windowElement.width(), height: windowElement.height() };
            }
        };
    }

    function startDrag(windowId, e) {
        var window = windows[windowId];
        if (!window || window.isMinimized) return;

        var startX = e.clientX;
        var startY = e.clientY;
        var windowPos = window.element.position();

        dragState = {
            windowId: windowId,
            startX: startX,
            startY: startY,
            startWindowX: windowPos.left,
            startWindowY: windowPos.top
        };

        $(document).on('mousemove.floating-window-drag', handleDrag);
        $(document).on('mouseup.floating-window-drag', stopDrag);
        $('body').addClass('red-ui-dragging');
    }

    function handleDrag(e) {
        if (!dragState) return;

        var deltaX = e.clientX - dragState.startX;
        var deltaY = e.clientY - dragState.startY;
        var newX = dragState.startWindowX + deltaX;
        var newY = dragState.startWindowY + deltaY;

        var window = windows[dragState.windowId];
        window.element.css({
            left: newX + 'px',
            top: newY + 'px'
        });
    }

    function stopDrag() {
        if (!dragState) return;

        constrainToViewport(dragState.windowId);
        saveWindowState(dragState.windowId);
        
        dragState = null;
        $(document).off('.floating-window-drag');
        $('body').removeClass('red-ui-dragging');
    }

    function startResize(windowId, e) {
        var window = windows[windowId];
        if (!window || window.isMinimized) return;

        var startX = e.clientX;
        var startY = e.clientY;
        var startWidth = window.element.width();
        var startHeight = window.element.height();

        resizeState = {
            windowId: windowId,
            startX: startX,
            startY: startY,
            startWidth: startWidth,
            startHeight: startHeight
        };

        $(document).on('mousemove.floating-window-resize', handleResize);
        $(document).on('mouseup.floating-window-resize', stopResize);
        $('body').addClass('red-ui-resizing');
    }

    function handleResize(e) {
        if (!resizeState) return;

        var deltaX = e.clientX - resizeState.startX;
        var deltaY = e.clientY - resizeState.startY;
        var window = windows[resizeState.windowId];
        
        var newWidth = Math.max(resizeState.startWidth + deltaX, window.minWidth);
        var newHeight = Math.max(resizeState.startHeight + deltaY, window.minHeight);

        window.element.css({
            width: newWidth + 'px',
            height: newHeight + 'px'
        });
    }

    function stopResize() {
        if (!resizeState) return;

        constrainToViewport(resizeState.windowId);
        saveWindowState(resizeState.windowId);
        
        resizeState = null;
        $(document).off('.floating-window-resize');
        $('body').removeClass('red-ui-resizing');
    }

    function toggleMinimize(windowId) {
        var window = windows[windowId];
        if (!window) return;

        if (window.isMinimized) {
            // Restore
            window.element.css('height', window.originalHeight + 'px');
            window.content.show();
            window.element.find('.red-ui-floating-window-resize-handle').show();
            window.isMinimized = false;
        } else {
            // Minimize
            window.originalHeight = window.element.height();
            window.element.css('height', '32px');
            window.content.hide();
            window.element.find('.red-ui-floating-window-resize-handle').hide();
            window.isMinimized = true;
        }
        
        saveWindowState(windowId);
    }

    function focusWindow(windowId) {
        var window = windows[windowId];
        if (!window) return;

        window.element.css('zIndex', ++maxZIndex);
        
        // Update title bar appearance for focused state
        $('.red-ui-floating-window-titlebar').css('backgroundColor', '#357abd');
        window.titleBar.css('backgroundColor', '#4a90d9');
    }

    function showWindow(windowId) {
        var window = windows[windowId];
        if (window) {
            window.element.show();
            focusWindow(windowId);
        }
    }

    function hideWindow(windowId) {
        var window = windows[windowId];
        if (window) {
            window.element.hide();
        }
    }

    function destroyWindow(windowId) {
        var window = windows[windowId];
        if (window) {
            window.element.remove();
            delete windows[windowId];
            localStorage.removeItem('floating-window-' + windowId);
        }
    }

    function constrainToViewport(windowId) {
        var window = windows[windowId];
        if (!window) return;

        var container = $('#red-ui-main-container');
        var containerWidth = container.width();
        var containerHeight = container.height();
        
        var windowWidth = window.element.outerWidth();
        var windowHeight = window.element.outerHeight();
        var pos = window.element.position();

        var newX = Math.max(0, Math.min(pos.left, containerWidth - windowWidth));
        var newY = Math.max(0, Math.min(pos.top, containerHeight - 32)); // Keep title bar visible

        window.element.css({
            left: newX + 'px',
            top: newY + 'px'
        });
    }

    function saveWindowState(windowId) {
        var window = windows[windowId];
        if (!window) return;

        var pos = window.element.position();
        var state = {
            x: pos.left,
            y: pos.top,
            width: window.element.width(),
            height: window.isMinimized ? window.originalHeight : window.element.height(),
            isMinimized: window.isMinimized
        };

        localStorage.setItem('floating-window-' + windowId, JSON.stringify(state));
    }

    // Public API
    return {
        create: createFloatingWindow,
        show: showWindow,
        hide: hideWindow,
        focus: focusWindow,
        destroy: destroyWindow,
        getWindow: function(windowId) { return windows[windowId]; },
        getAllWindows: function() { return windows; }
    };

})();