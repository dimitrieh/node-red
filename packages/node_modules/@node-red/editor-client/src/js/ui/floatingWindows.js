/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindows = (function() {
    
    let windows = {};
    let activeWindow = null;
    let windowCounter = 0;
    let zIndexCounter = 1000;

    function createWindow(options) {
        const windowId = options.id || `floating-window-${++windowCounter}`;
        
        const defaultOptions = {
            title: 'Floating Window',
            width: 300,
            height: 400,
            x: 100,
            y: 100,
            minWidth: 200,
            minHeight: 150,
            resizable: true,
            draggable: true,
            minimizable: true,
            closable: true,
            content: null,
            onClose: null,
            onMinimize: null,
            onRestore: null,
            onResize: null,
            onMove: null
        };
        
        const config = Object.assign({}, defaultOptions, options, { id: windowId });
        
        // Create window structure
        const windowDiv = $(`
            <div id="${windowId}" class="red-ui-floating-window" style="
                position: absolute;
                left: ${config.x}px;
                top: ${config.y}px;
                width: ${config.width}px;
                height: ${config.height}px;
                z-index: ${++zIndexCounter};
                display: block;
            ">
                <div class="red-ui-floating-window-header">
                    <span class="red-ui-floating-window-title">${config.title}</span>
                    <div class="red-ui-floating-window-controls">
                        ${config.minimizable ? '<button class="red-ui-floating-window-minimize" title="Minimize"><i class="fa fa-minus"></i></button>' : ''}
                        ${config.closable ? '<button class="red-ui-floating-window-close" title="Close"><i class="fa fa-times"></i></button>' : ''}
                    </div>
                </div>
                <div class="red-ui-floating-window-content">
                    ${config.content || ''}
                </div>
                ${config.resizable ? '<div class="red-ui-floating-window-resize-handle"></div>' : ''}
            </div>
        `);
        
        // Append to main container
        $('#red-ui-main-container').append(windowDiv);
        
        // Store window configuration
        windows[windowId] = {
            config: config,
            element: windowDiv,
            isMinimized: false,
            originalHeight: config.height
        };
        
        // Setup event handlers
        setupWindowHandlers(windowId);
        
        // Load saved state if available
        loadWindowState(windowId);
        
        return windowId;
    }
    
    function setupWindowHandlers(windowId) {
        const window = windows[windowId];
        const windowDiv = window.element;
        const config = window.config;
        
        // Header click to bring to front
        windowDiv.find('.red-ui-floating-window-header').on('mousedown', function(e) {
            bringToFront(windowId);
            activeWindow = windowId;
        });
        
        // Draggable functionality
        if (config.draggable) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            windowDiv.find('.red-ui-floating-window-header').on('mousedown', function(e) {
                if ($(e.target).closest('.red-ui-floating-window-controls').length > 0) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = parseInt(windowDiv.css('left'), 10);
                initialY = parseInt(windowDiv.css('top'), 10);
                
                $(document).on('mousemove.floating-drag', function(e) {
                    if (!isDragging) return;
                    
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    const newX = Math.max(0, Math.min(initialX + deltaX, 
                        $(window).width() - windowDiv.outerWidth()));
                    const newY = Math.max(0, Math.min(initialY + deltaY, 
                        $(window).height() - windowDiv.find('.red-ui-floating-window-header').outerHeight()));
                    
                    windowDiv.css({
                        left: newX + 'px',
                        top: newY + 'px'
                    });
                    
                    if (config.onMove) config.onMove(newX, newY);
                });
                
                $(document).on('mouseup.floating-drag', function() {
                    isDragging = false;
                    $(document).off('.floating-drag');
                    saveWindowState(windowId);
                });
            });
        }
        
        // Resizable functionality
        if (config.resizable) {
            let isResizing = false;
            let startX, startY, startWidth, startHeight;
            
            windowDiv.find('.red-ui-floating-window-resize-handle').on('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = windowDiv.outerWidth();
                startHeight = windowDiv.outerHeight();
                
                $(document).on('mousemove.floating-resize', function(e) {
                    if (!isResizing) return;
                    
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    const newWidth = Math.max(config.minWidth, startWidth + deltaX);
                    const newHeight = Math.max(config.minHeight, startHeight + deltaY);
                    
                    windowDiv.css({
                        width: newWidth + 'px',
                        height: newHeight + 'px'
                    });
                    
                    if (config.onResize) config.onResize(newWidth, newHeight);
                });
                
                $(document).on('mouseup.floating-resize', function() {
                    isResizing = false;
                    $(document).off('.floating-resize');
                    saveWindowState(windowId);
                });
            });
        }
        
        // Minimize button
        windowDiv.find('.red-ui-floating-window-minimize').on('click', function(e) {
            e.stopPropagation();
            toggleMinimize(windowId);
        });
        
        // Close button
        windowDiv.find('.red-ui-floating-window-close').on('click', function(e) {
            e.stopPropagation();
            closeWindow(windowId);
        });
    }
    
    function bringToFront(windowId) {
        if (windows[windowId]) {
            windows[windowId].element.css('z-index', ++zIndexCounter);
        }
    }
    
    function toggleMinimize(windowId) {
        const window = windows[windowId];
        if (!window) return;
        
        if (window.isMinimized) {
            // Restore
            window.element.css('height', window.originalHeight + 'px');
            window.element.find('.red-ui-floating-window-content').show();
            window.element.find('.red-ui-floating-window-resize-handle').show();
            window.isMinimized = false;
            
            if (window.config.onRestore) window.config.onRestore();
        } else {
            // Minimize
            window.originalHeight = window.element.outerHeight();
            window.element.css('height', window.element.find('.red-ui-floating-window-header').outerHeight() + 'px');
            window.element.find('.red-ui-floating-window-content').hide();
            window.element.find('.red-ui-floating-window-resize-handle').hide();
            window.isMinimized = true;
            
            if (window.config.onMinimize) window.config.onMinimize();
        }
        
        saveWindowState(windowId);
    }
    
    function closeWindow(windowId) {
        const window = windows[windowId];
        if (!window) return;
        
        if (window.config.onClose && window.config.onClose() === false) {
            return; // Cancel close if handler returns false
        }
        
        window.element.remove();
        delete windows[windowId];
        
        // Clear from localStorage
        const settings = RED.settings.get('floating-windows') || {};
        delete settings[windowId];
        RED.settings.set('floating-windows', settings);
    }
    
    function showWindow(windowId) {
        if (windows[windowId]) {
            windows[windowId].element.show();
            bringToFront(windowId);
        }
    }
    
    function hideWindow(windowId) {
        if (windows[windowId]) {
            windows[windowId].element.hide();
        }
    }
    
    function saveWindowState(windowId) {
        const window = windows[windowId];
        if (!window) return;
        
        const element = window.element;
        const state = {
            x: parseInt(element.css('left'), 10),
            y: parseInt(element.css('top'), 10),
            width: element.outerWidth(),
            height: window.isMinimized ? window.originalHeight : element.outerHeight(),
            isMinimized: window.isMinimized,
            isVisible: element.is(':visible')
        };
        
        const settings = RED.settings.get('floating-windows') || {};
        settings[windowId] = state;
        RED.settings.set('floating-windows', settings);
    }
    
    function loadWindowState(windowId) {
        const settings = RED.settings.get('floating-windows') || {};
        const state = settings[windowId];
        
        if (state) {
            const window = windows[windowId];
            const element = window.element;
            
            element.css({
                left: state.x + 'px',
                top: state.y + 'px',
                width: state.width + 'px',
                height: (state.isMinimized ? element.find('.red-ui-floating-window-header').outerHeight() : state.height) + 'px'
            });
            
            if (state.isMinimized) {
                window.isMinimized = true;
                window.originalHeight = state.height;
                element.find('.red-ui-floating-window-content').hide();
                element.find('.red-ui-floating-window-resize-handle').hide();
            }
            
            if (!state.isVisible) {
                element.hide();
            }
        }
    }
    
    function updateWindowContent(windowId, content) {
        if (windows[windowId]) {
            windows[windowId].element.find('.red-ui-floating-window-content').html(content);
        }
    }
    
    function setWindowTitle(windowId, title) {
        if (windows[windowId]) {
            windows[windowId].element.find('.red-ui-floating-window-title').text(title);
            windows[windowId].config.title = title;
        }
    }
    
    // Public API
    return {
        create: createWindow,
        close: closeWindow,
        show: showWindow,
        hide: hideWindow,
        minimize: toggleMinimize,
        bringToFront: bringToFront,
        updateContent: updateWindowContent,
        setTitle: setWindowTitle,
        getWindow: function(windowId) {
            return windows[windowId];
        },
        getAllWindows: function() {
            return Object.keys(windows);
        }
    };
})();