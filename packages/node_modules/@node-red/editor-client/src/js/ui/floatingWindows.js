/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindows = (function() {
    var currentZIndex = 1000;
    var windowStates = {};
    
    function createWindow(options) {
        var windowId = options.id;
        var title = options.title || 'Window';
        var content = options.content || $('<div></div>');
        var defaultWidth = options.width || 300;
        var defaultHeight = options.height || 400;
        var defaultX = options.x || 50;
        var defaultY = options.y || 50;
        
        // Restore saved state if exists
        var savedState = getSavedWindowState(windowId);
        var width = savedState.width || defaultWidth;
        var height = savedState.height || defaultHeight;
        var x = savedState.x || defaultX;
        var y = savedState.y || defaultY;
        var minimized = savedState.minimized || false;
        
        // Create window structure
        var windowElement = $('<div class="red-ui-floating-window" id="' + windowId + '-window">')
            .css({
                position: 'absolute',
                width: width + 'px',
                height: height + 'px',
                left: x + 'px',
                top: y + 'px',
                zIndex: currentZIndex++,
                background: 'var(--red-ui-primary-background)',
                border: '1px solid var(--red-ui-primary-border-color)',
                borderRadius: '4px',
                boxShadow: '0 4px 8px rgba(0,0,0,0.2)',
                display: minimized ? 'none' : 'block'
            });
        
        // Create window header with title bar
        var headerElement = $('<div class="red-ui-floating-window-header">')
            .css({
                background: 'var(--red-ui-palette-header-background)',
                color: 'var(--red-ui-palette-header-color)',
                padding: '8px 12px',
                cursor: 'move',
                borderBottom: '1px solid var(--red-ui-secondary-border-color)',
                borderRadius: '4px 4px 0 0',
                userSelect: 'none',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                fontSize: '14px',
                fontWeight: 'bold'
            });
        
        var titleElement = $('<span class="red-ui-floating-window-title">')
            .text(title);
        
        // Create window controls
        var controlsElement = $('<div class="red-ui-floating-window-controls">')
            .css({
                display: 'flex',
                gap: '4px'
            });
        
        var minimizeBtn = $('<button class="red-ui-floating-window-minimize">')
            .css({
                background: 'transparent',
                border: 'none',
                color: 'var(--red-ui-palette-header-color)',
                cursor: 'pointer',
                padding: '2px 6px',
                borderRadius: '2px',
                fontSize: '14px'
            })
            .html('<i class="fa fa-minus"></i>')
            .on('click', function(e) {
                e.stopPropagation();
                minimizeWindow(windowId);
            });
        
        var maximizeBtn = $('<button class="red-ui-floating-window-maximize">')
            .css({
                background: 'transparent',
                border: 'none',
                color: 'var(--red-ui-palette-header-color)',
                cursor: 'pointer',
                padding: '2px 6px',
                borderRadius: '2px',
                fontSize: '14px'
            })
            .html('<i class="fa fa-expand"></i>')
            .on('click', function(e) {
                e.stopPropagation();
                maximizeWindow(windowId);
            });
        
        var closeBtn = $('<button class="red-ui-floating-window-close">')
            .css({
                background: 'transparent',
                border: 'none',
                color: 'var(--red-ui-palette-header-color)',
                cursor: 'pointer',
                padding: '2px 6px',
                borderRadius: '2px',
                fontSize: '14px'
            })
            .html('<i class="fa fa-times"></i>')
            .on('click', function(e) {
                e.stopPropagation();
                closeWindow(windowId);
            });
        
        controlsElement.append(minimizeBtn, maximizeBtn, closeBtn);
        headerElement.append(titleElement, controlsElement);
        
        // Create content area
        var contentElement = $('<div class="red-ui-floating-window-content">')
            .css({
                position: 'absolute',
                top: '37px',
                left: '0',
                right: '0',
                bottom: '0',
                overflow: 'hidden',
                borderRadius: '0 0 4px 4px'
            });
        
        // Move existing content into window
        if (content.length > 0) {
            contentElement.append(content);
        }
        
        // Create resize handle
        var resizerElement = $('<div class="red-ui-floating-window-resizer">')
            .css({
                position: 'absolute',
                bottom: '0',
                right: '0',
                width: '12px',
                height: '12px',
                cursor: 'se-resize',
                background: 'linear-gradient(-45deg, transparent 30%, var(--red-ui-secondary-border-color) 30%, var(--red-ui-secondary-border-color) 35%, transparent 35%, transparent 65%, var(--red-ui-secondary-border-color) 65%, var(--red-ui-secondary-border-color) 70%, transparent 70%)',
                zIndex: 10
            });
        
        // Assemble window
        windowElement.append(headerElement, contentElement, resizerElement);
        
        // Add to page
        $('body').append(windowElement);
        
        // Make draggable
        makeDraggable(windowElement, headerElement);
        
        // Make resizable
        makeResizable(windowElement, resizerElement);
        
        // Bring to front on click
        windowElement.on('mousedown', function() {
            bringToFront(windowElement);
        });
        
        // Store window reference
        windowStates[windowId] = {
            element: windowElement,
            minimized: minimized,
            maximized: false,
            x: x,
            y: y,
            width: width,
            height: height
        };
        
        return windowElement;
    }
    
    function makeDraggable(windowElement, handleElement) {
        var isDragging = false;
        var dragOffset = { x: 0, y: 0 };
        
        handleElement.on('mousedown', function(e) {
            if (e.target.tagName === 'BUTTON' || $(e.target).closest('button').length) {
                return;
            }
            
            isDragging = true;
            bringToFront(windowElement);
            
            var windowPos = windowElement.offset();
            dragOffset.x = e.pageX - windowPos.left;
            dragOffset.y = e.pageY - windowPos.top;
            
            $(document).on('mousemove.floating-window-drag', function(e) {
                if (!isDragging) return;
                
                var newX = e.pageX - dragOffset.x;
                var newY = e.pageY - dragOffset.y;
                
                // Constrain to window bounds
                newX = Math.max(0, Math.min(newX, $(window).width() - windowElement.outerWidth()));
                newY = Math.max(0, Math.min(newY, $(window).height() - windowElement.outerHeight()));
                
                windowElement.css({
                    left: newX + 'px',
                    top: newY + 'px'
                });
                
                // Update state
                var windowId = windowElement.attr('id').replace('-window', '');
                if (windowStates[windowId]) {
                    windowStates[windowId].x = newX;
                    windowStates[windowId].y = newY;
                }
            });
            
            $(document).on('mouseup.floating-window-drag', function() {
                isDragging = false;
                $(document).off('mousemove.floating-window-drag mouseup.floating-window-drag');
                
                // Save window state
                var windowId = windowElement.attr('id').replace('-window', '');
                saveWindowState(windowId);
            });
        });
    }
    
    function makeResizable(windowElement, resizerElement) {
        var isResizing = false;
        var startSize = { width: 0, height: 0 };
        var startMouse = { x: 0, y: 0 };
        
        resizerElement.on('mousedown', function(e) {
            isResizing = true;
            bringToFront(windowElement);
            
            startSize.width = windowElement.outerWidth();
            startSize.height = windowElement.outerHeight();
            startMouse.x = e.pageX;
            startMouse.y = e.pageY;
            
            $(document).on('mousemove.floating-window-resize', function(e) {
                if (!isResizing) return;
                
                var newWidth = startSize.width + (e.pageX - startMouse.x);
                var newHeight = startSize.height + (e.pageY - startMouse.y);
                
                // Minimum size constraints
                newWidth = Math.max(200, newWidth);
                newHeight = Math.max(150, newHeight);
                
                windowElement.css({
                    width: newWidth + 'px',
                    height: newHeight + 'px'
                });
                
                // Update state
                var windowId = windowElement.attr('id').replace('-window', '');
                if (windowStates[windowId]) {
                    windowStates[windowId].width = newWidth;
                    windowStates[windowId].height = newHeight;
                }
            });
            
            $(document).on('mouseup.floating-window-resize', function() {
                isResizing = false;
                $(document).off('mousemove.floating-window-resize mouseup.floating-window-resize');
                
                // Save window state
                var windowId = windowElement.attr('id').replace('-window', '');
                saveWindowState(windowId);
            });
        });
    }
    
    function bringToFront(windowElement) {
        windowElement.css('zIndex', currentZIndex++);
    }
    
    function minimizeWindow(windowId) {
        var state = windowStates[windowId];
        if (!state) return;
        
        state.element.hide();
        state.minimized = true;
        saveWindowState(windowId);
    }
    
    function maximizeWindow(windowId) {
        var state = windowStates[windowId];
        if (!state) return;
        
        if (state.maximized) {
            // Restore
            state.element.css({
                left: state.x + 'px',
                top: state.y + 'px',
                width: state.width + 'px',
                height: state.height + 'px'
            });
            state.maximized = false;
            state.element.find('.red-ui-floating-window-maximize i').removeClass('fa-compress').addClass('fa-expand');
        } else {
            // Maximize
            state.element.css({
                left: '0px',
                top: '0px',
                width: '100%',
                height: '100%'
            });
            state.maximized = true;
            state.element.find('.red-ui-floating-window-maximize i').removeClass('fa-expand').addClass('fa-compress');
        }
        saveWindowState(windowId);
    }
    
    function closeWindow(windowId) {
        var state = windowStates[windowId];
        if (!state) return;
        
        state.element.hide();
        saveWindowState(windowId);
    }
    
    function showWindow(windowId) {
        var state = windowStates[windowId];
        if (!state) return;
        
        state.element.show();
        state.minimized = false;
        bringToFront(state.element);
        saveWindowState(windowId);
    }
    
    function saveWindowState(windowId) {
        var state = windowStates[windowId];
        if (!state) return;
        
        var savedStates = JSON.parse(localStorage.getItem('red-ui-floating-windows') || '{}');
        savedStates[windowId] = {
            x: state.x,
            y: state.y,
            width: state.width,
            height: state.height,
            minimized: state.minimized,
            maximized: state.maximized
        };
        localStorage.setItem('red-ui-floating-windows', JSON.stringify(savedStates));
    }
    
    function getSavedWindowState(windowId) {
        var savedStates = JSON.parse(localStorage.getItem('red-ui-floating-windows') || '{}');
        return savedStates[windowId] || {};
    }
    
    function resetWindowPositions() {
        localStorage.removeItem('red-ui-floating-windows');
        
        // Reset all current windows to default positions
        Object.keys(windowStates).forEach(function(windowId) {
            var state = windowStates[windowId];
            if (state.element) {
                var defaultX = windowId === 'red-ui-palette' ? 50 : ($(window).width() - 350);
                var defaultY = 50;
                var defaultWidth = windowId === 'red-ui-palette' ? 200 : 330;
                var defaultHeight = windowId === 'red-ui-palette' ? 400 : 450;
                
                state.element.css({
                    left: defaultX + 'px',
                    top: defaultY + 'px',
                    width: defaultWidth + 'px',
                    height: defaultHeight + 'px'
                });
                
                state.x = defaultX;
                state.y = defaultY;
                state.width = defaultWidth;
                state.height = defaultHeight;
                state.minimized = false;
                state.maximized = false;
                
                state.element.show();
            }
        });
    }
    
    function updateWindowTitle(windowId, title) {
        var state = windowStates[windowId];
        if (state && state.element) {
            state.element.find('.red-ui-floating-window-title').text(title);
        }
    }
    
    return {
        createWindow: createWindow,
        bringToFront: bringToFront,
        minimizeWindow: minimizeWindow,
        maximizeWindow: maximizeWindow,
        closeWindow: closeWindow,
        showWindow: showWindow,
        saveWindowState: saveWindowState,
        resetWindowPositions: resetWindowPositions,
        updateWindowTitle: updateWindowTitle
    };
})();