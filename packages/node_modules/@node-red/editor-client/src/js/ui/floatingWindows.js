/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.floatingWindows = (function() {
    let activeWindow = null;
    
    function makeFloatingWindow(element, title, options) {
        options = options || {};
        
        // Wrap the element content
        const originalContent = element.children().detach();
        
        // Add title bar
        const titleBar = $('<div class="red-ui-floating-window-titlebar">' +
            '<div class="title">' + title + '</div>' +
            '<div class="controls">' +
                '<button class="control-btn minimize-btn" title="Minimize">−</button>' +
                '<button class="control-btn close-btn" title="Close">×</button>' +
            '</div>' +
        '</div>');
        
        // Add content wrapper
        const contentWrapper = $('<div class="red-ui-floating-window-content"></div>');
        
        // Rebuild structure
        element.empty();
        element.addClass('red-ui-floating-window');
        element.append(titleBar);
        element.append(contentWrapper);
        contentWrapper.append(originalContent);
        
        // Make draggable
        let isDragging = false;
        let startX, startY, startLeft, startTop;
        
        titleBar.on('mousedown', function(e) {
            if ($(e.target).hasClass('control-btn')) return; // Don't drag on buttons
            
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = element.offset().left;
            startTop = element.offset().top;
            
            // Bring to front
            setActiveWindow(element);
            
            $(document).on('mousemove.floatingWindow', function(e) {
                if (!isDragging) return;
                
                const newLeft = startLeft + (e.clientX - startX);
                const newTop = startTop + (e.clientY - startY);
                
                element.css({
                    left: newLeft + 'px',
                    top: newTop + 'px'
                });
            });
            
            $(document).on('mouseup.floatingWindow', function() {
                isDragging = false;
                $(document).off('mousemove.floatingWindow');
                $(document).off('mouseup.floatingWindow');
            });
        });
        
        // Handle window controls
        titleBar.find('.minimize-btn').on('click', function() {
            contentWrapper.toggle();
            const btn = $(this);
            if (contentWrapper.is(':visible')) {
                btn.text('−');
                btn.attr('title', 'Minimize');
            } else {
                btn.text('+');
                btn.attr('title', 'Restore');
            }
        });
        
        titleBar.find('.close-btn').on('click', function() {
            element.hide();
        });
        
        // Window focus handling
        element.on('mousedown', function() {
            setActiveWindow(element);
        });
        
        return element;
    }
    
    function setActiveWindow(window) {
        // Remove focused class from all windows
        $('.red-ui-floating-window').removeClass('focused');
        
        // Add focused class to active window
        window.addClass('focused');
        activeWindow = window;
    }
    
    return {
        makeFloatingWindow: makeFloatingWindow,
        setActiveWindow: setActiveWindow
    };
})();