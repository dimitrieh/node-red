/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

RED.mobile = (function() {

    let isMobile = false;
    let isTablet = false;
    let isTouchDevice = false;
    let currentOrientation = null;
    
    let sidebarOpen = false;
    let paletteOpen = false;
    
    let touchStartData = null;
    let touchTimeout = null;
    
    function detectDevice() {
        // Detect mobile, tablet, and touch capabilities
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        isMobile = width <= 767;
        isTablet = width >= 768 && width <= 1024;
        isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        currentOrientation = width > height ? 'landscape' : 'portrait';
        
        // Update body classes
        document.body.classList.toggle('red-ui-mobile', isMobile);
        document.body.classList.toggle('red-ui-tablet', isTablet);
        document.body.classList.toggle('red-ui-touch', isTouchDevice);
        document.body.classList.toggle('red-ui-landscape', currentOrientation === 'landscape');
        document.body.classList.toggle('red-ui-portrait', currentOrientation === 'portrait');
    }
    
    function createMobileNavigation() {
        if (!isMobile) return;
        
        // Remove existing mobile nav if present
        const existingNav = document.querySelector('.red-ui-mobile-nav');
        if (existingNav) {
            existingNav.remove();
        }
        
        // Create mobile navigation
        const nav = document.createElement('div');
        nav.className = 'red-ui-mobile-nav';
        
        // Palette button
        const paletteBtn = document.createElement('button');
        paletteBtn.className = 'red-ui-mobile-nav-button';
        paletteBtn.innerHTML = '<i class="fa fa-list"></i>';
        paletteBtn.title = 'Toggle Node Palette';
        paletteBtn.addEventListener('click', togglePalette);
        
        // Workspace button (for centering/home)
        const workspaceBtn = document.createElement('button');
        workspaceBtn.className = 'red-ui-mobile-nav-button';
        workspaceBtn.innerHTML = '<i class="fa fa-home"></i>';
        workspaceBtn.title = 'Center Workspace';
        workspaceBtn.addEventListener('click', centerWorkspace);
        
        // Sidebar button
        const sidebarBtn = document.createElement('button');
        sidebarBtn.className = 'red-ui-mobile-nav-button';
        sidebarBtn.innerHTML = '<i class="fa fa-info"></i>';
        sidebarBtn.title = 'Toggle Sidebar';
        sidebarBtn.addEventListener('click', toggleSidebar);
        
        nav.appendChild(paletteBtn);
        nav.appendChild(workspaceBtn);
        nav.appendChild(sidebarBtn);
        
        document.body.appendChild(nav);
    }
    
    function togglePalette() {
        if (sidebarOpen) {
            closeSidebar();
        }
        
        paletteOpen = !paletteOpen;
        document.body.classList.toggle('red-ui-mobile-palette-open', paletteOpen);
        
        // Update button state
        const btn = document.querySelector('.red-ui-mobile-nav-button i.fa-list');
        if (btn) {
            btn.parentElement.classList.toggle('active', paletteOpen);
        }
        
        // Auto-close after node selection on mobile
        if (paletteOpen) {
            setupPaletteAutoClose();
        }
    }
    
    function toggleSidebar() {
        if (paletteOpen) {
            closePalette();
        }
        
        sidebarOpen = !sidebarOpen;
        document.body.classList.toggle('red-ui-mobile-sidebar-open', sidebarOpen);
        
        // Update button state
        const btn = document.querySelector('.red-ui-mobile-nav-button i.fa-info');
        if (btn) {
            btn.parentElement.classList.toggle('active', sidebarOpen);
        }
    }
    
    function closePalette() {
        paletteOpen = false;
        document.body.classList.remove('red-ui-mobile-palette-open');
        const btn = document.querySelector('.red-ui-mobile-nav-button i.fa-list');
        if (btn) {
            btn.parentElement.classList.remove('active');
        }
    }
    
    function closeSidebar() {
        sidebarOpen = false;
        document.body.classList.remove('red-ui-mobile-sidebar-open');
        const btn = document.querySelector('.red-ui-mobile-nav-button i.fa-info');
        if (btn) {
            btn.parentElement.classList.remove('active');
        }
    }
    
    function centerWorkspace() {
        // Center the workspace view
        RED.view.focus();
    }
    
    function setupPaletteAutoClose() {
        // Close palette when user starts dragging a node
        const paletteNodes = document.querySelectorAll('.red-ui-palette-node');
        
        paletteNodes.forEach(node => {
            node.addEventListener('touchstart', function() {
                setTimeout(() => {
                    closePalette();
                }, 100);
            }, { once: true });
        });
    }
    
    function handleTouchEvents() {
        if (!isTouchDevice) return;
        
        // Enhanced touch handling for workspace
        const workspace = document.getElementById('red-ui-workspace-chart');
        
        if (workspace) {
            // Prevent default touch behaviors that might interfere
            workspace.addEventListener('touchstart', handleWorkspaceTouchStart, { passive: false });
            workspace.addEventListener('touchmove', handleWorkspaceTouchMove, { passive: false });
            workspace.addEventListener('touchend', handleWorkspaceTouchEnd, { passive: false });
        }
        
        // Close panels when tapping overlay
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('red-ui-mobile-sidebar-open') || 
                e.target.classList.contains('red-ui-mobile-palette-open')) {
                closeSidebar();
                closePalette();
            }
        });
    }
    
    function handleWorkspaceTouchStart(e) {
        if (e.touches.length === 1) {
            touchStartData = {
                x: e.touches[0].clientX,
                y: e.touches[0].clientY,
                time: Date.now()
            };
        } else {
            touchStartData = null;
        }
    }
    
    function handleWorkspaceTouchMove(e) {
        // Allow normal touch scrolling and panning
        if (e.touches.length === 2) {
            // Two-finger gesture - allow pinch zoom
            return;
        }
        
        if (touchStartData && e.touches.length === 1) {
            const deltaX = Math.abs(e.touches[0].clientX - touchStartData.x);
            const deltaY = Math.abs(e.touches[0].clientY - touchStartData.y);
            
            // If significant movement, this is a pan gesture
            if (deltaX > 10 || deltaY > 10) {
                touchStartData = null;
            }
        }
    }
    
    function handleWorkspaceTouchEnd(e) {
        if (touchStartData) {
            const touchEndTime = Date.now();
            const touchDuration = touchEndTime - touchStartData.time;
            
            // Short tap - ensure panels are closed for workspace interaction
            if (touchDuration < 300) {
                if (sidebarOpen || paletteOpen) {
                    closeSidebar();
                    closePalette();
                    e.preventDefault();
                    return;
                }
            }
        }
        
        touchStartData = null;
    }
    
    function setupSwipeGestures() {
        if (!isMobile) return;
        
        let swipeStartX = null;
        let swipeStartY = null;
        const swipeThreshold = 50;
        
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length === 1) {
                swipeStartX = e.touches[0].clientX;
                swipeStartY = e.touches[0].clientY;
            }
        }, { passive: true });
        
        document.addEventListener('touchend', function(e) {
            if (!swipeStartX || !swipeStartY) return;
            
            const touch = e.changedTouches[0];
            const deltaX = touch.clientX - swipeStartX;
            const deltaY = touch.clientY - swipeStartY;
            
            // Only handle horizontal swipes that are larger than vertical
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > swipeThreshold) {
                const screenEdgeThreshold = 50;
                
                // Swipe from left edge to open palette
                if (swipeStartX < screenEdgeThreshold && deltaX > 0 && !paletteOpen) {
                    togglePalette();
                    e.preventDefault();
                }
                
                // Swipe from right edge to open sidebar
                if (swipeStartX > window.innerWidth - screenEdgeThreshold && deltaX < 0 && !sidebarOpen) {
                    toggleSidebar();
                    e.preventDefault();
                }
                
                // Swipe left to close palette
                if (paletteOpen && deltaX < -swipeThreshold) {
                    closePalette();
                    e.preventDefault();
                }
                
                // Swipe right to close sidebar
                if (sidebarOpen && deltaX > swipeThreshold) {
                    closeSidebar();
                    e.preventDefault();
                }
            }
            
            swipeStartX = null;
            swipeStartY = null;
        }, { passive: false });
    }
    
    function optimizeForTouch() {
        if (!isTouchDevice) return;
        
        // Add touch-specific CSS classes
        document.body.classList.add('red-ui-touch-optimized');
        
        // Increase touch targets for small elements
        const style = document.createElement('style');
        style.textContent = `
            @media (pointer: coarse) {
                .red-ui-palette-node,
                .red-ui-sidebar-tab,
                .red-ui-button {
                    min-height: 44px;
                    min-width: 44px;
                }
                
                .red-ui-palette-node {
                    padding: 8px 12px;
                    margin: 4px 2px;
                }
                
                .red-ui-tabs li {
                    min-height: 44px;
                }
                
                .red-ui-tabs li a {
                    padding: 12px 16px;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    function handleOrientationChange() {
        detectDevice();
        
        setTimeout(() => {
            createMobileNavigation();
            
            // Adjust layout based on new orientation
            if (isMobile) {
                // Close panels on orientation change to avoid layout issues
                closeSidebar();
                closePalette();
            }
            
            // Trigger workspace resize
            if (RED.view && RED.view.redraw) {
                RED.view.redraw();
            }
        }, 100);
    }
    
    function init() {
        detectDevice();
        
        if (isMobile || isTablet || isTouchDevice) {
            createMobileNavigation();
            handleTouchEvents();
            setupSwipeGestures();
            optimizeForTouch();
            
            // Handle orientation changes
            window.addEventListener('orientationchange', handleOrientationChange);
            window.addEventListener('resize', handleOrientationChange);
        }
    }
    
    // Public API
    return {
        init: init,
        isMobile: () => isMobile,
        isTablet: () => isTablet,
        isTouchDevice: () => isTouchDevice,
        togglePalette: togglePalette,
        toggleSidebar: toggleSidebar,
        closePalette: closePalette,
        closeSidebar: closeSidebar
    };

})();