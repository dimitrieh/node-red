/**
 * Mobile and Touch Interface Handler for Node-RED
 * Provides intelligent mobile/tablet optimizations and touch interactions
 */

RED.mobile = (function() {
    
    let isMobile = false;
    let isTablet = false;
    let isTouch = false;
    let paletteExpanded = false;
    let sidebarExpanded = false;
    
    // Touch gesture tracking
    let touchStartTime = 0;
    let touchStartPos = { x: 0, y: 0 };
    let lastTouchTime = 0;
    let doubleTapThreshold = 300;
    
    function detectDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        // Detect mobile devices
        isMobile = width <= 768 || /mobile|android|iphone|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
        
        // Detect tablets
        isTablet = (width >= 768 && width <= 1024) || /tablet|ipad/i.test(userAgent);
        
        // Detect touch capability
        isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        // Add classes to body for CSS targeting
        document.body.classList.toggle('red-ui-mobile', isMobile);
        document.body.classList.toggle('red-ui-tablet', isTablet);
        document.body.classList.toggle('red-ui-touch', isTouch);
        
        console.log('RED.mobile: Device detected -', {
            mobile: isMobile,
            tablet: isTablet,
            touch: isTouch,
            viewport: { width, height }
        });
    }
    
    function initMobileInterface() {
        if (!isMobile && !isTablet) return;
        
        console.log('RED.mobile: Initializing mobile interface');
        
        // Add mobile menu button to header
        addMobileMenuButton();
        
        // Initialize mobile palette
        initMobilePalette();
        
        // Initialize mobile sidebar
        initMobileSidebar();
        
        // Setup touch interactions
        setupTouchInteractions();
        
        // Handle orientation changes
        handleOrientationChange();
        
        // Optimize workspace for mobile
        optimizeWorkspaceForMobile();
    }
    
    function addMobileMenuButton() {
        const header = document.getElementById('red-ui-header');
        if (!header) return;
        
        // Create hamburger menu button
        const menuButton = document.createElement('div');
        menuButton.className = 'red-ui-header-button red-ui-mobile-menu';
        menuButton.innerHTML = '<i class="fa fa-bars"></i>';
        menuButton.style.display = 'block';
        
        // Insert at beginning of header
        const toolbar = header.querySelector('.red-ui-header-toolbar');
        if (toolbar) {
            toolbar.insertBefore(menuButton, toolbar.firstChild);
        }
        
        // Menu button click handler
        menuButton.addEventListener('click', function(e) {
            e.preventDefault();
            toggleMobileMenu();
        });
    }
    
    function toggleMobileMenu() {
        // Toggle palette visibility
        togglePalette();
    }
    
    function initMobilePalette() {
        const palette = document.getElementById('red-ui-palette');
        if (!palette) return;
        
        // Add mobile classes
        palette.classList.add('red-ui-mobile-palette');
        
        // Add tap handler for palette toggle
        const paletteToggle = document.createElement('div');
        paletteToggle.className = 'red-ui-mobile-palette-toggle';
        paletteToggle.innerHTML = '<i class="fa fa-chevron-right"></i>';
        palette.appendChild(paletteToggle);
        
        paletteToggle.addEventListener('click', togglePalette);
        
        // Close palette when clicking outside
        document.addEventListener('click', function(e) {
            if (paletteExpanded && !palette.contains(e.target) && 
                !e.target.closest('.red-ui-mobile-menu')) {
                closePalette();
            }
        });
        
        // Make palette nodes more touch-friendly
        enhancePaletteForTouch();
    }
    
    function togglePalette() {
        const palette = document.getElementById('red-ui-palette');
        if (!palette) return;
        
        paletteExpanded = !paletteExpanded;
        palette.classList.toggle('red-ui-mobile-expanded', paletteExpanded);
        
        // Update toggle icon
        const toggle = palette.querySelector('.red-ui-mobile-palette-toggle i');
        if (toggle) {
            toggle.className = paletteExpanded ? 'fa fa-chevron-left' : 'fa fa-chevron-right';
        }
        
        console.log('RED.mobile: Palette toggled -', paletteExpanded ? 'expanded' : 'collapsed');
    }
    
    function closePalette() {
        const palette = document.getElementById('red-ui-palette');
        if (!palette || !paletteExpanded) return;
        
        paletteExpanded = false;
        palette.classList.remove('red-ui-mobile-expanded');
        
        const toggle = palette.querySelector('.red-ui-mobile-palette-toggle i');
        if (toggle) {
            toggle.className = 'fa fa-chevron-right';
        }
    }
    
    function enhancePaletteForTouch() {
        const palette = document.getElementById('red-ui-palette');
        if (!palette) return;
        
        // Add touch feedback to palette nodes
        const paletteNodes = palette.querySelectorAll('.red-ui-palette-node');
        paletteNodes.forEach(node => {
            // Add touch start/end feedback
            node.addEventListener('touchstart', function() {
                this.classList.add('red-ui-touch-active');
            }, { passive: true });
            
            node.addEventListener('touchend', function() {
                this.classList.remove('red-ui-touch-active');
            }, { passive: true });
            
            node.addEventListener('touchcancel', function() {
                this.classList.remove('red-ui-touch-active');
            }, { passive: true });
        });
        
        // Improve drag and drop for touch
        enhanceDragAndDropForTouch();
    }
    
    function enhanceDragAndDropForTouch() {
        // Override jQuery UI draggable for better touch support
        if (typeof $.fn.draggable !== 'undefined') {
            const originalDraggable = $.fn.draggable;
            $.fn.draggable = function(options) {
                if (isTouch) {
                    // Add touch-specific options
                    options = options || {};
                    options.delay = options.delay || 150;
                    options.distance = options.distance || 10;
                }
                return originalDraggable.call(this, options);
            };
        }
    }
    
    function initMobileSidebar() {
        const sidebar = document.getElementById('red-ui-sidebar');
        if (!sidebar) return;
        
        sidebar.classList.add('red-ui-mobile-sidebar');
        
        // Add swipe gestures for sidebar
        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        
        sidebar.addEventListener('touchstart', function(e) {
            if (e.target.closest('.red-ui-sidebar-content')) return; // Allow content scrolling
            
            startY = e.touches[0].clientY;
            isDragging = true;
        }, { passive: true });
        
        sidebar.addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            
            currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;
            
            // Only allow downward swipes to close
            if (deltaY > 0) {
                const progress = Math.min(deltaY / 100, 1);
                sidebar.style.transform = `translateY(${deltaY}px)`;
                sidebar.style.opacity = 1 - (progress * 0.3);
            }
        }, { passive: true });
        
        sidebar.addEventListener('touchend', function(e) {
            if (!isDragging) return;
            isDragging = false;
            
            const deltaY = currentY - startY;
            
            // Close sidebar if swiped down significantly
            if (deltaY > 80) {
                closeSidebar();
            } else {
                // Snap back to position
                sidebar.style.transform = '';
                sidebar.style.opacity = '';
            }
        }, { passive: true });
        
        // Add tap to expand/collapse
        const sidebarHeader = sidebar.querySelector('.red-ui-sidebar-header');
        if (sidebarHeader) {
            sidebarHeader.addEventListener('click', function(e) {
                // Don't toggle if clicking on actual tabs
                if (!e.target.closest('li')) {
                    toggleSidebar();
                }
            });
        }
    }
    
    function toggleSidebar() {
        const sidebar = document.getElementById('red-ui-sidebar');
        if (!sidebar) return;
        
        sidebarExpanded = !sidebarExpanded;
        sidebar.classList.toggle('red-ui-mobile-expanded', sidebarExpanded);
        
        console.log('RED.mobile: Sidebar toggled -', sidebarExpanded ? 'expanded' : 'collapsed');
    }
    
    function closeSidebar() {
        const sidebar = document.getElementById('red-ui-sidebar');
        if (!sidebar) return;
        
        sidebarExpanded = false;
        sidebar.classList.remove('red-ui-mobile-expanded');
        sidebar.style.transform = '';
        sidebar.style.opacity = '';
    }
    
    function setupTouchInteractions() {
        if (!isTouch) return;
        
        // Prevent default touch behaviors that interfere with Node-RED
        document.addEventListener('touchmove', function(e) {
            // Allow scrolling in sidebar and palette content
            if (e.target.closest('.red-ui-sidebar-content') || 
                e.target.closest('.red-ui-palette-content')) {
                return;
            }
            
            // Prevent default for workspace
            if (e.target.closest('#red-ui-workspace')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Add double-tap to zoom functionality
        document.addEventListener('touchend', function(e) {
            const currentTime = new Date().getTime();
            
            if (currentTime - lastTouchTime < doubleTapThreshold) {
                // Double tap detected
                handleDoubleTap(e);
            }
            
            lastTouchTime = currentTime;
        });
        
        // Improve button tap responsiveness
        const buttons = document.querySelectorAll('button, .red-ui-button, .red-ui-header-button');
        buttons.forEach(button => {
            button.addEventListener('touchstart', function() {
                this.classList.add('red-ui-touch-active');
            }, { passive: true });
            
            button.addEventListener('touchend', function() {
                this.classList.remove('red-ui-touch-active');
            }, { passive: true });
        });
    }
    
    function handleDoubleTap(e) {
        if (e.target.closest('#red-ui-workspace-chart')) {
            // Double tap in workspace - zoom to fit or reset zoom
            if (typeof RED.view !== 'undefined' && RED.view.zoomToFit) {
                RED.view.zoomToFit();
                console.log('RED.mobile: Double-tap zoom to fit');
            }
        }
    }
    
    function optimizeWorkspaceForMobile() {
        const workspace = document.getElementById('red-ui-workspace');
        if (!workspace) return;
        
        // Add mobile workspace class
        workspace.classList.add('red-ui-mobile-workspace');
        
        // Improve touch scrolling and panning
        const chart = workspace.querySelector('#red-ui-workspace-chart');
        if (chart) {
            chart.style.touchAction = 'pan-x pan-y';
            
            // Add momentum scrolling for iOS
            chart.style.webkitOverflowScrolling = 'touch';
        }
        
        // Adjust zoom controls for mobile
        setTimeout(() => {
            const zoomBox = document.querySelector('#red-ui-view-zoom-controls');
            if (zoomBox && (isMobile || isTablet)) {
                zoomBox.style.bottom = '80px'; // Move above mobile UI
                zoomBox.style.right = '20px';
                
                // Make zoom buttons larger
                const zoomBtns = zoomBox.querySelectorAll('a');
                zoomBtns.forEach(btn => {
                    btn.style.minWidth = '44px';
                    btn.style.minHeight = '44px';
                    btn.style.fontSize = '18px';
                });
            }
        }, 100);
    }
    
    function handleOrientationChange() {
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                detectDevice();
                
                // Close expanded panels on orientation change
                if (paletteExpanded) closePalette();
                if (sidebarExpanded) closeSidebar();
                
                // Trigger resize to recalculate layout
                if (typeof RED.view !== 'undefined' && RED.view.redraw) {
                    RED.view.redraw();
                }
                
                console.log('RED.mobile: Orientation changed');
            }, 100);
        });
        
        // Also handle resize events
        window.addEventListener('resize', function() {
            setTimeout(() => {
                detectDevice();
            }, 100);
        });
    }
    
    function addTouchStyles() {
        if (!isTouch) return;
        
        // Add touch-specific CSS
        const touchStyles = `
            .red-ui-touch-active {
                opacity: 0.7 !important;
                transform: scale(0.95) !important;
                transition: all 0.1s ease !important;
            }
            
            .red-ui-palette-node.red-ui-touch-active {
                background-color: var(--red-ui-node-selected-color) !important;
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = touchStyles;
        document.head.appendChild(styleSheet);
    }
    
    // Public API
    return {
        init: function() {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    detectDevice();
                    initMobileInterface();
                    addTouchStyles();
                });
            } else {
                detectDevice();
                initMobileInterface();
                addTouchStyles();
            }
        },
        
        isMobile: function() { return isMobile; },
        isTablet: function() { return isTablet; },
        isTouch: function() { return isTouch; },
        
        togglePalette: togglePalette,
        closePalette: closePalette,
        toggleSidebar: toggleSidebar,
        closeSidebar: closeSidebar,
        
        // Utility functions for other modules
        getTouchTargetSize: function() { return 44; },
        getDoubleTapThreshold: function() { return doubleTapThreshold; }
    };
})();

// Initialize mobile functionality when DOM is ready
RED.mobile.init();