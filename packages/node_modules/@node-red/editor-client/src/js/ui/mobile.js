/**
 * Node-RED Mobile Navigation & Touch Optimization
 * Provides mobile-friendly navigation and responsive UI management
 */

RED.mobile = (function() {
    
    let isMobile = false;
    let isTablet = false;
    let paletteVisible = false;
    let sidebarVisible = false;
    
    // Mobile breakpoints
    const MOBILE_BREAKPOINT = 450;
    const TABLET_BREAKPOINT = 768;
    
    // Touch target minimum size
    const MIN_TOUCH_TARGET = 44;
    
    // Mobile navigation elements
    let mobileMenuButton = null;
    let mobileSidebarButton = null;
    let mobileOverlay = null;
    
    function checkViewport() {
        const width = window.innerWidth;
        const wasMobile = isMobile;
        const wasTablet = isTablet;
        
        isMobile = width <= MOBILE_BREAKPOINT;
        isTablet = width > MOBILE_BREAKPOINT && width <= TABLET_BREAKPOINT;
        
        // Viewport changed - update UI
        if (wasMobile !== isMobile || wasTablet !== isTablet) {
            updateLayout();
        }
    }
    
    function updateLayout() {
        if (isMobile) {
            setupMobileLayout();
        } else {
            setupDesktopLayout();
        }
    }
    
    function setupMobileLayout() {
        // Hide panels by default on mobile
        hidePalette();
        hideSidebar();
        
        // Show mobile navigation buttons
        if (mobileMenuButton) mobileMenuButton.style.display = 'block';
        if (mobileSidebarButton) mobileSidebarButton.style.display = 'block';
        
        // Optimize touch targets
        optimizeTouchTargets();
    }
    
    function setupDesktopLayout() {
        // Show panels on desktop
        showPalette();
        showSidebar();
        
        // Hide mobile navigation buttons
        if (mobileMenuButton) mobileMenuButton.style.display = 'none';
        if (mobileSidebarButton) mobileSidebarButton.style.display = 'none';
        if (mobileOverlay) mobileOverlay.classList.remove('active');
    }
    
    function createMobileNavigation() {
        // Create mobile menu button (hamburger)
        mobileMenuButton = document.createElement('div');
        mobileMenuButton.className = 'red-ui-mobile-menu-button';
        mobileMenuButton.setAttribute('title', 'Toggle Node Palette');
        mobileMenuButton.addEventListener('click', togglePalette);
        mobileMenuButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            togglePalette();
        });
        document.body.appendChild(mobileMenuButton);
        
        // Create mobile sidebar button
        mobileSidebarButton = document.createElement('div');
        mobileSidebarButton.className = 'red-ui-mobile-sidebar-button';
        mobileSidebarButton.setAttribute('title', 'Toggle Information Panel');
        mobileSidebarButton.addEventListener('click', toggleSidebar);
        mobileSidebarButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            toggleSidebar();
        });
        document.body.appendChild(mobileSidebarButton);
        
        // Create overlay backdrop
        mobileOverlay = document.createElement('div');
        mobileOverlay.className = 'red-ui-mobile-overlay';
        mobileOverlay.addEventListener('click', hideAllPanels);
        document.body.appendChild(mobileOverlay);
    }
    
    function togglePalette() {
        if (paletteVisible) {
            hidePalette();
        } else {
            showPalette();
            hideSidebar(); // Hide sidebar when showing palette
        }
    }
    
    function toggleSidebar() {
        if (sidebarVisible) {
            hideSidebar();
        } else {
            showSidebar();
            hidePalette(); // Hide palette when showing sidebar
        }
    }
    
    function showPalette() {
        const palette = document.getElementById('red-ui-palette');
        if (palette) {
            palette.classList.add('mobile-visible');
            paletteVisible = true;
            
            if (mobileMenuButton) mobileMenuButton.classList.add('active');
            if (mobileOverlay && isMobile) mobileOverlay.classList.add('active');
        }
    }
    
    function hidePalette() {
        const palette = document.getElementById('red-ui-palette');
        if (palette) {
            palette.classList.remove('mobile-visible');
            paletteVisible = false;
            
            if (mobileMenuButton) mobileMenuButton.classList.remove('active');
            if (!sidebarVisible && mobileOverlay) mobileOverlay.classList.remove('active');
        }
    }
    
    function showSidebar() {
        const sidebar = document.getElementById('red-ui-sidebar');
        if (sidebar) {
            sidebar.classList.add('mobile-visible');
            sidebarVisible = true;
            
            if (mobileOverlay && isMobile) mobileOverlay.classList.add('active');
        }
    }
    
    function hideSidebar() {
        const sidebar = document.getElementById('red-ui-sidebar');
        if (sidebar) {
            sidebar.classList.remove('mobile-visible');
            sidebarVisible = false;
            
            if (!paletteVisible && mobileOverlay) mobileOverlay.classList.remove('active');
        }
    }
    
    function hideAllPanels() {
        hidePalette();
        hideSidebar();
    }
    
    function optimizeTouchTargets() {
        // Optimize buttons for touch
        const buttons = document.querySelectorAll('button, .red-ui-button, .red-ui-header-button');
        buttons.forEach(button => {
            const rect = button.getBoundingClientRect();
            if (rect.width < MIN_TOUCH_TARGET || rect.height < MIN_TOUCH_TARGET) {
                button.classList.add('touch-target');
            }
        });
        
        // Optimize form elements
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.type !== 'hidden' && input.style.display !== 'none') {
                const rect = input.getBoundingClientRect();
                if (rect.height < MIN_TOUCH_TARGET) {
                    input.style.minHeight = MIN_TOUCH_TARGET + 'px';
                }
            }
        });
    }
    
    function handleTouchEvents() {
        // Improve touch performance
        document.addEventListener('touchstart', function() {}, { passive: true });
        document.addEventListener('touchmove', function() {}, { passive: true });
        
        // Handle orientation changes
        window.addEventListener('orientationchange', function() {
            setTimeout(checkViewport, 100); // Delay to get accurate dimensions
        });
    }
    
    function handleKeyboardEvents() {
        // Add keyboard shortcuts for mobile navigation
        document.addEventListener('keydown', function(e) {
            if (isMobile) {
                // Escape key closes mobile panels
                if (e.key === 'Escape') {
                    hideAllPanels();
                }
                
                // Ctrl+M toggles palette on mobile
                if (e.ctrlKey && e.key === 'm') {
                    e.preventDefault();
                    togglePalette();
                }
                
                // Ctrl+I toggles sidebar on mobile
                if (e.ctrlKey && e.key === 'i') {
                    e.preventDefault();
                    toggleSidebar();
                }
            }
        });
    }
    
    function improveScrolling() {
        // Improve scrolling on mobile devices
        const scrollableElements = document.querySelectorAll('.red-ui-palette, .red-ui-sidebar, .red-ui-workspace');
        scrollableElements.forEach(element => {
            element.style.webkitOverflowScrolling = 'touch';
        });
    }
    
    function preventZoom() {
        // Prevent zoom on double-tap for workspace
        const workspace = document.getElementById('red-ui-workspace');
        if (workspace) {
            workspace.addEventListener('touchend', function(e) {
                if (e.touches.length === 0) {
                    e.preventDefault();
                }
            });
        }
    }
    
    function init() {
        // Initial viewport check
        checkViewport();
        
        // Create mobile navigation elements
        createMobileNavigation();
        
        // Set up event listeners
        window.addEventListener('resize', checkViewport);
        handleTouchEvents();
        handleKeyboardEvents();
        
        // Optimize for mobile
        improveScrolling();
        preventZoom();
        
        // Update layout
        updateLayout();
        
        // Re-optimize touch targets when DOM changes
        const observer = new MutationObserver(function(mutations) {
            if (isMobile) {
                setTimeout(optimizeTouchTargets, 100);
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
    
    // Public API
    return {
        init: init,
        isMobile: function() { return isMobile; },
        isTablet: function() { return isTablet; },
        togglePalette: togglePalette,
        toggleSidebar: toggleSidebar,
        hidePalette: hidePalette,
        hideAllPanels: hideAllPanels,
        optimizeTouchTargets: optimizeTouchTargets
    };
})();

// Auto-initialize when DOM is ready
$(document).ready(function() {
    RED.mobile.init();
});