/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/

/**
 * Mobile and touch interface enhancements for Node-RED
 */
RED.mobile = (function() {
    
    var isMobile = false;
    var isTablet = false;
    var paletteOpen = false;
    var sidebarOpen = false;
    var touchStartTime = 0;
    var lastTouchY = 0;
    
    function isTouchDevice() {
        return (('ontouchstart' in window) ||
                (navigator.maxTouchPoints > 0) ||
                (navigator.msMaxTouchPoints > 0));
    }
    
    function getScreenSize() {
        var width = window.innerWidth;
        if (width <= 480) {
            return 'mobile';
        } else if (width <= 768) {
            return 'tablet';  
        } else {
            return 'desktop';
        }
    }
    
    function updateLayout() {
        var screenSize = getScreenSize();
        isMobile = screenSize === 'mobile';
        isTablet = screenSize === 'tablet';
        
        document.body.classList.remove('red-ui-mobile', 'red-ui-tablet', 'red-ui-desktop');
        document.body.classList.add('red-ui-' + screenSize);
        
        // Update touch-friendly attributes
        if (isMobile || isTablet) {
            document.body.classList.add('red-ui-touch');
            // Enable touch-action on workspace for better scroll performance
            var workspace = document.getElementById('red-ui-workspace-chart');
            if (workspace) {
                workspace.style.touchAction = 'pan-x pan-y';
            }
        } else {
            document.body.classList.remove('red-ui-touch');
        }
        
        // Adjust layout for mobile/tablet
        if (isMobile) {
            closePalette();
            closeSidebar();
            addMobileToggleButtons();
        } else if (isTablet) {
            addMobileToggleButtons();
        } else {
            removeMobileToggleButtons();
        }
    }
    
    function addMobileToggleButtons() {
        var header = document.getElementById('red-ui-header');
        var toolbar = header.querySelector('.red-ui-header-toolbar');
        
        // Add palette toggle button
        if (!header.querySelector('.red-ui-mobile-palette-toggle')) {
            var paletteToggle = document.createElement('button');
            paletteToggle.className = 'red-ui-mobile-palette-toggle';
            paletteToggle.innerHTML = '<i class="fa fa-bars"></i>';
            paletteToggle.setAttribute('aria-label', 'Toggle palette');
            paletteToggle.onclick = togglePalette;
            header.insertBefore(paletteToggle, toolbar);
        }
        
        // Add sidebar toggle button  
        if (!header.querySelector('.red-ui-mobile-sidebar-toggle')) {
            var sidebarToggle = document.createElement('button');
            sidebarToggle.className = 'red-ui-mobile-sidebar-toggle';
            sidebarToggle.innerHTML = '<i class="fa fa-info-circle"></i>';
            sidebarToggle.setAttribute('aria-label', 'Toggle sidebar');
            sidebarToggle.onclick = toggleSidebar;
            toolbar.appendChild(sidebarToggle);
        }
    }
    
    function removeMobileToggleButtons() {
        var paletteToggle = document.querySelector('.red-ui-mobile-palette-toggle');
        var sidebarToggle = document.querySelector('.red-ui-mobile-sidebar-toggle');
        
        if (paletteToggle) {
            paletteToggle.remove();
        }
        if (sidebarToggle) {
            sidebarToggle.remove();
        }
    }
    
    function togglePalette() {
        var palette = document.getElementById('red-ui-palette');
        if (!palette) return;
        
        if (paletteOpen) {
            closePalette();
        } else {
            openPalette();
        }
    }
    
    function openPalette() {
        var palette = document.getElementById('red-ui-palette');
        if (!palette) return;
        
        palette.classList.add('red-ui-palette-open');
        paletteOpen = true;
        
        // Close sidebar if open (mobile only)
        if (isMobile && sidebarOpen) {
            closeSidebar();
        }
        
        // Add escape key handler
        document.addEventListener('keydown', handleEscapeKey);
        
        // Add backdrop click handler
        palette.addEventListener('click', handleBackdropClick);
    }
    
    function closePalette() {
        var palette = document.getElementById('red-ui-palette');
        if (!palette) return;
        
        palette.classList.remove('red-ui-palette-open');
        paletteOpen = false;
        
        // Remove event handlers
        document.removeEventListener('keydown', handleEscapeKey);
        palette.removeEventListener('click', handleBackdropClick);
    }
    
    function toggleSidebar() {
        var sidebar = document.getElementById('red-ui-sidebar');
        if (!sidebar) return;
        
        if (sidebarOpen) {
            closeSidebar();
        } else {
            openSidebar();
        }
    }
    
    function openSidebar() {
        var sidebar = document.getElementById('red-ui-sidebar');
        if (!sidebar) return;
        
        sidebar.classList.add('red-ui-sidebar-open');
        sidebarOpen = true;
        
        // Close palette if open (mobile only)
        if (isMobile && paletteOpen) {
            closePalette();
        }
        
        // Add escape key handler
        document.addEventListener('keydown', handleEscapeKey);
        
        // Add backdrop click handler
        sidebar.addEventListener('click', handleBackdropClick);
    }
    
    function closeSidebar() {
        var sidebar = document.getElementById('red-ui-sidebar');
        if (!sidebar) return;
        
        sidebar.classList.remove('red-ui-sidebar-open');
        sidebarOpen = false;
        
        // Remove event handlers
        document.removeEventListener('keydown', handleEscapeKey);
        sidebar.removeEventListener('click', handleBackdropClick);
    }
    
    function handleEscapeKey(e) {
        if (e.key === 'Escape') {
            if (paletteOpen) {
                closePalette();
            }
            if (sidebarOpen) {
                closeSidebar();
            }
        }
    }
    
    function handleBackdropClick(e) {
        // Only close if clicking on the backdrop (::before pseudo-element area)
        if (e.target === e.currentTarget) {
            if (paletteOpen) {
                closePalette();
            }
            if (sidebarOpen) {
                closeSidebar();
            }
        }
    }
    
    function optimizeTouch() {
        // Improve touch scrolling performance
        var workspace = document.getElementById('red-ui-workspace-chart');
        if (workspace && isTouchDevice()) {
            workspace.style.webkitOverflowScrolling = 'touch';
            workspace.style.touchAction = 'pan-x pan-y pinch-zoom';
        }
        
        // Optimize palette scrolling
        var paletteContainer = document.querySelector('.red-ui-palette-scroll');
        if (paletteContainer && isTouchDevice()) {
            paletteContainer.style.webkitOverflowScrolling = 'touch';
        }
        
        // Optimize sidebar scrolling
        var sidebarContent = document.getElementById('red-ui-sidebar-content');
        if (sidebarContent && isTouchDevice()) {
            sidebarContent.style.webkitOverflowScrolling = 'touch';
        }
    }
    
    function handleTouchNavigation() {
        // Prevent pull-to-refresh on mobile browsers
        document.body.addEventListener('touchstart', function(e) {
            touchStartTime = Date.now();
            lastTouchY = e.touches[0].clientY;
        }, { passive: true });
        
        document.body.addEventListener('touchmove', function(e) {
            var currentY = e.touches[0].clientY;
            var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            
            // Prevent pull-to-refresh when at top of page
            if (scrollTop === 0 && currentY > lastTouchY) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Handle double-tap to zoom prevention on specific elements
        var workspace = document.getElementById('red-ui-workspace-chart');
        if (workspace) {
            workspace.addEventListener('touchend', function(e) {
                var touchTime = Date.now() - touchStartTime;
                if (touchTime < 200) { // Quick tap
                    e.preventDefault();
                }
            });
        }
    }
    
    function init() {
        // Initial layout update
        updateLayout();
        
        // Optimize touch interactions
        if (isTouchDevice()) {
            optimizeTouch();
            handleTouchNavigation();
        }
        
        // Listen for window resize
        window.addEventListener('resize', function() {
            setTimeout(updateLayout, 100); // Debounce
        });
        
        // Listen for orientation change
        window.addEventListener('orientationchange', function() {
            setTimeout(updateLayout, 300); // Allow time for orientation change
        });
    }
    
    return {
        init: init,
        isMobile: function() { return isMobile; },
        isTablet: function() { return isTablet; },
        isTouchDevice: isTouchDevice,
        togglePalette: togglePalette,
        toggleSidebar: toggleSidebar,
        closePalette: closePalette,
        closeSidebar: closeSidebar
    };
})();