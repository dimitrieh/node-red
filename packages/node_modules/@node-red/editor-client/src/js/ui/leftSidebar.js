/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
RED.leftSidebar = (function() {
    
    var tabs;
    var paletteTab;
    var outlinerTab;
    var currentTab = 'palette';
    
    function init() {
        // Create tab container at the top of the palette area
        var tabContainer = $('<div id="red-ui-left-sidebar-tabs" class="red-ui-left-sidebar-tabs"></div>');
        var tabBar = $('<ul class="red-ui-tabs"></ul>').appendTo(tabContainer);
        
        // Create tabs for switching between palette and outliner
        var paletteTabButton = $('<li class="red-ui-tab active"><a href="#red-ui-left-sidebar-palette-tab" data-tab="palette">Palette</a></li>').appendTo(tabBar);
        var outlinerTabButton = $('<li class="red-ui-tab"><a href="#red-ui-left-sidebar-outliner-tab" data-tab="outliner">Outline</a></li>').appendTo(tabBar);
        
        // Create content containers
        var contentContainer = $('<div id="red-ui-left-sidebar-content" class="red-ui-left-sidebar-content"></div>');
        
        // Create palette container
        paletteTab = $('<div id="red-ui-left-sidebar-palette-tab" class="red-ui-left-sidebar-tab-content"></div>').appendTo(contentContainer);
        
        // Create outliner container
        outlinerTab = $('<div id="red-ui-left-sidebar-outliner-tab" class="red-ui-left-sidebar-tab-content" style="display:none;"></div>').appendTo(contentContainer);
        
        // Insert the new tab structure into the palette div
        $("#red-ui-palette").empty();
        $("#red-ui-palette").append(tabContainer);
        $("#red-ui-palette").append(contentContainer);
        
        // Initialize palette content in the palette tab
        initPaletteContent();
        
        // Initialize outliner content in the outliner tab
        initOutlinerContent();
        
        // Handle tab switching
        tabBar.on('click', 'a', function(e) {
            e.preventDefault();
            var tab = $(this).data('tab');
            switchTab(tab);
        });
        
        // Store the current tab in localStorage
        var lastTab = localStorage.getItem('red-ui-left-sidebar-tab');
        if (lastTab && (lastTab === 'palette' || lastTab === 'outliner')) {
            switchTab(lastTab);
        } else {
            // Set initial width for palette
            setPaletteWidth(180);
        }
    }
    
    function initPaletteContent() {
        // Move palette content into the palette tab
        $('<img src="red/images/spin.svg" class="red-ui-palette-spinner hide"/>').appendTo(paletteTab);
        $('<div id="red-ui-palette-search" class="red-ui-palette-search hide"><input type="text" data-i18n="[placeholder]palette.filter"></input></div>').appendTo(paletteTab);
        $('<div id="red-ui-palette-container" class="red-ui-palette-scroll hide"></div>').appendTo(paletteTab);
        $('<div class="red-ui-component-footer"></div>').appendTo(paletteTab);
        $('<div id="red-ui-palette-shade" class="hide"></div>').appendTo(paletteTab);
    }
    
    function initOutlinerContent() {
        // Create outliner content structure - the outliner builds its own search box
        var outlinerContainer = $('<div class="red-ui-sidebar-info-outline"></div>').appendTo(outlinerTab);
        outlinerContainer.css({
            "height": "100%"
        });
        
        // Build the outliner - it has its own search built in
        setTimeout(function() {
            if (RED.sidebar && RED.sidebar.info && RED.sidebar.info.outliner) {
                RED.sidebar.info.outliner.build().appendTo(outlinerContainer);
            }
        }, 100);
    }
    
    function switchTab(tab) {
        if (tab === currentTab) return;
        
        // Update tab buttons
        $("#red-ui-left-sidebar-tabs .red-ui-tab").removeClass('active');
        $("#red-ui-left-sidebar-tabs a[data-tab='"+tab+"']").parent().addClass('active');
        
        // Show/hide content and adjust width
        if (tab === 'palette') {
            paletteTab.show();
            outlinerTab.hide();
            // Set standard width for palette
            setPaletteWidth(180);
        } else if (tab === 'outliner') {
            paletteTab.hide();
            outlinerTab.show();
            // Set wider width for outliner
            setPaletteWidth(280);
        }
        
        currentTab = tab;
        localStorage.setItem('red-ui-left-sidebar-tab', tab);
        
        // Emit event for other components
        RED.events.emit('left-sidebar:tab-change', tab);
    }
    
    function setPaletteWidth(width) {
        $("#red-ui-palette").css("width", width + "px");
        $("#red-ui-workspace").css("left", (width + 1) + "px");
        $("#red-ui-editor-stack").css("left", (width + 1) + "px");
        
        // Trigger resize event for view to recalculate
        setTimeout(function() { 
            $(window).trigger("resize"); 
        }, 0);
    }
    
    function getCurrentTab() {
        return currentTab;
    }
    
    function showPalette() {
        switchTab('palette');
    }
    
    function showOutliner() {
        switchTab('outliner');
    }
    
    return {
        init: init,
        getCurrentTab: getCurrentTab,
        showPalette: showPalette,
        showOutliner: showOutliner
    };
})();