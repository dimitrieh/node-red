/**
 * Mobile and Tablet Touch Enhancements for Node-RED
 * Intelligent touch interactions and responsive behavior
 */

(function() {
    'use strict';

    let mobileState = {
        isInitialized: false,
        activePanel: null,
        touchDevice: false,
        screenSize: 'desktop',
        orientation: 'portrait',
        gestureHandler: null
    };

    // Device and screen detection
    function detectDevice() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        mobileState.touchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        mobileState.orientation = width > height ? 'landscape' : 'portrait';
        
        if (width <= 767) {
            mobileState.screenSize = 'mobile';
        } else if (width <= 1024) {
            mobileState.screenSize = 'tablet';
        } else {
            mobileState.screenSize = 'desktop';
        }
        
        // Update CSS classes
        document.body.className = document.body.className.replace(/red-ui-(mobile|tablet|desktop|touch|portrait|landscape)/g, '');
        document.body.classList.add(`red-ui-${mobileState.screenSize}`);
        
        if (mobileState.touchDevice) {
            document.body.classList.add('red-ui-touch');
        }
        
        document.body.classList.add(`red-ui-${mobileState.orientation}`);
        
        return mobileState.screenSize;
    }

    // Initialize mobile enhancements
    function initializeMobile() {
        if (mobileState.isInitialized) return;
        
        const deviceType = detectDevice();
        
        if (deviceType === 'mobile') {
            setupMobileLayout();
            createMobileNavigation();
            setupMobileGestures();
        } else if (deviceType === 'tablet') {
            setupTabletLayout();
            setupTabletInteractions();
        }
        
        if (mobileState.touchDevice) {
            enhanceTouchInteractions();
        }
        
        // Setup responsive event listeners
        setupEventListeners();
        
        mobileState.isInitialized = true;
        console.log('Node-RED Mobile Touch initialized for:', deviceType);
    }

    // Mobile layout setup
    function setupMobileLayout() {
        // Hide panels initially
        const palette = document.getElementById('red-ui-palette');
        const sidebar = document.getElementById('red-ui-sidebar');
        
        if (palette) {
            palette.classList.remove('mobile-visible');
            palette.style.transform = 'translateX(-100%)';
        }
        
        if (sidebar) {
            sidebar.classList.remove('mobile-visible');
            sidebar.style.transform = 'translateX(100%)';
        }
        
        // Ensure workspace uses full area
        const workspace = document.getElementById('red-ui-workspace');
        if (workspace) {
            workspace.style.left = '0px';
            workspace.style.right = '0px';
        }
    }

    // Create mobile navigation bar
    function createMobileNavigation() {
        // Remove existing nav
        const existing = document.querySelector('.red-ui-mobile-nav');
        if (existing) existing.remove();
        
        const nav = document.createElement('div');
        nav.className = 'red-ui-mobile-nav';
        
        // Palette button
        const paletteBtn = createNavButton('ðŸ“¦', 'Toggle Palette', () => toggleMobilePanel('palette'));
        paletteBtn.setAttribute('data-panel', 'palette');
        
        // Center/Home button
        const homeBtn = createNavButton('ðŸ ', 'Center View', centerWorkspaceView);
        
        // Deploy button
        const deployBtn = createNavButton('ðŸš€', 'Deploy', () => {
            if (window.RED && RED.deploy) {
                RED.deploy.trigger();
            }
        });
        deployBtn.classList.add('deploy-button');
        
        // Info/Sidebar button
        const infoBtn = createNavButton('â„¹ï¸', 'Toggle Info', () => toggleMobilePanel('sidebar'));
        infoBtn.setAttribute('data-panel', 'sidebar');
        
        // Settings button
        const settingsBtn = createNavButton('âš™ï¸', 'Settings', () => {
            if (window.RED && RED.userSettings) {
                RED.userSettings.toggle();
            }
        });
        
        [paletteBtn, homeBtn, deployBtn, infoBtn, settingsBtn].forEach(btn => nav.appendChild(btn));
        
        document.body.appendChild(nav);
    }

    // Create navigation button
    function createNavButton(icon, title, onClick) {
        const button = document.createElement('button');
        button.className = 'nav-button';
        button.textContent = icon;
        button.title = title;
        button.setAttribute('aria-label', title);
        
        // Add touch feedback
        button.addEventListener('touchstart', (e) => {
            e.preventDefault();
            button.style.transform = 'scale(0.9)';
        });
        
        button.addEventListener('touchend', (e) => {
            e.preventDefault();
            button.style.transform = '';
            onClick();
        });
        
        button.addEventListener('click', (e) => {
            if (!mobileState.touchDevice) {
                onClick();
            }
        });
        
        return button;
    }

    // Toggle mobile panel visibility
    function toggleMobilePanel(panelType) {
        const panelId = panelType === 'palette' ? 'red-ui-palette' : 'red-ui-sidebar';
        const panel = document.getElementById(panelId);
        const button = document.querySelector(`[data-panel="${panelType}"]`);
        
        if (!panel) return;
        
        const isVisible = panel.classList.contains('mobile-visible');
        
        // Hide all other panels first
        hideAllMobilePanels();
        
        if (!isVisible) {
            // Show this panel
            panel.classList.add('mobile-visible');
            panel.style.transform = 'translateX(0)';
            
            if (button) {
                button.classList.add('active');
            }
            
            mobileState.activePanel = panelType;
            showMobileOverlay();
        } else {
            mobileState.activePanel = null;
            hideMobileOverlay();
        }
    }

    // Hide all mobile panels
    function hideAllMobilePanels() {
        const panels = ['red-ui-palette', 'red-ui-sidebar'];
        const buttons = document.querySelectorAll('.nav-button[data-panel]');
        
        panels.forEach(id => {
            const panel = document.getElementById(id);
            if (panel) {
                panel.classList.remove('mobile-visible');
                if (id === 'red-ui-palette') {
                    panel.style.transform = 'translateX(-100%)';
                } else {
                    panel.style.transform = 'translateX(100%)';
                }
            }
        });
        
        buttons.forEach(btn => btn.classList.remove('active'));
        
        mobileState.activePanel = null;
        hideMobileOverlay();
    }

    // Show/hide mobile overlay
    function showMobileOverlay() {
        let overlay = document.querySelector('.red-ui-mobile-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'red-ui-mobile-overlay';
            document.body.appendChild(overlay);
        }
        
        overlay.addEventListener('click', hideAllMobilePanels);
        overlay.addEventListener('touchstart', hideAllMobilePanels);
    }

    function hideMobileOverlay() {
        const overlay = document.querySelector('.red-ui-mobile-overlay');
        if (overlay) {
            overlay.remove();
        }
    }

    // Tablet layout and interactions
    function setupTabletLayout() {
        const palette = document.getElementById('red-ui-palette');
        const sidebar = document.getElementById('red-ui-sidebar');
        
        if (palette) {
            addMinimizeButton(palette, 'palette');
        }
        
        if (sidebar) {
            addMinimizeButton(sidebar, 'sidebar');
        }
    }

    function addMinimizeButton(panel, type) {
        // Check if minimize button already exists
        if (panel.querySelector('.tablet-minimize-btn')) return;
        
        const header = panel.querySelector('.red-ui-palette-header, .red-ui-sidebar-header') || panel;
        const btn = document.createElement('button');
        btn.className = 'tablet-minimize-btn';
        btn.innerHTML = 'â¬‡ï¸';
        btn.title = `Minimize ${type}`;
        btn.style.cssText = `
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            cursor: pointer;
            z-index: 10;
        `;
        
        btn.addEventListener('click', () => {
            panel.classList.toggle('tablet-minimized');
            btn.innerHTML = panel.classList.contains('tablet-minimized') ? 'â¬†ï¸' : 'â¬‡ï¸';
        });
        
        header.style.position = 'relative';
        header.appendChild(btn);
    }

    function setupTabletInteractions() {
        // Make panels draggable on tablet
        const panels = ['red-ui-palette', 'red-ui-sidebar'];
        
        panels.forEach(id => {
            const panel = document.getElementById(id);
            if (panel && window.jQuery && jQuery.ui) {
                $(panel).draggable({
                    handle: '.red-ui-palette-header, .red-ui-sidebar-header',
                    containment: 'window',
                    scroll: false,
                    start: function() {
                        $(this).css('transform', 'none');
                    }
                });
            }
        });
    }

    // Enhanced touch interactions
    function enhanceTouchInteractions() {
        // Long press gestures for nodes
        let longPressTimer = null;
        let longPressTarget = null;
        
        document.addEventListener('touchstart', (e) => {
            const target = e.target.closest('.red-ui-palette-node, .red_ui_flow_node');
            if (target) {
                longPressTarget = target;
                longPressTimer = setTimeout(() => {
                    handleLongPress(target, e);
                }, 500);
            }
        });
        
        document.addEventListener('touchmove', () => {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });
        
        document.addEventListener('touchend', () => {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        });
        
        // Enhanced scrolling for workspace
        setupWorkspaceScrolling();
        
        // Add haptic feedback if available
        if ('vibrate' in navigator) {
            setupHapticFeedback();
        }
    }

    function handleLongPress(target, originalEvent) {
        // Add visual feedback
        target.style.transform = 'scale(1.05)';
        target.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
        
        // Vibrate if available
        if ('vibrate' in navigator) {
            navigator.vibrate(50);
        }
        
        // Show context menu or info
        if (target.classList.contains('red_ui_flow_node') && window.RED) {
            // For flow nodes, show info or context menu
            setTimeout(() => {
                target.style.transform = '';
                target.style.boxShadow = '';
            }, 200);
        }
    }

    function setupWorkspaceScrolling() {
        const chart = document.getElementById('red-ui-workspace-chart');
        if (!chart) return;
        
        let isScrolling = false;
        let touchStartX, touchStartY;
        
        chart.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isScrolling = false;
        });
        
        chart.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1) {
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                const deltaX = touchX - touchStartX;
                const deltaY = touchY - touchStartY;
                
                if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                    isScrolling = true;
                }
            }
        });
    }

    function setupHapticFeedback() {
        // Add subtle haptic feedback for interactions
        document.addEventListener('touchstart', (e) => {
            const target = e.target;
            if (target.matches('.red-ui-button, .red-ui-palette-node, .nav-button')) {
                navigator.vibrate(10);
            }
        });
    }

    function centerWorkspaceView() {
        if (window.RED && RED.view) {
            RED.view.focus();
        }
    }

    // Setup event listeners for responsive behavior
    function setupEventListeners() {
        let resizeTimeout;
        
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const oldScreenSize = mobileState.screenSize;
                const newScreenSize = detectDevice();
                
                if (oldScreenSize !== newScreenSize) {
                    // Screen size changed, reinitialize
                    mobileState.isInitialized = false;
                    initializeMobile();
                }
            }, 100);
        });
        
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                detectDevice();
                if (mobileState.screenSize === 'mobile') {
                    hideAllMobilePanels();
                }
            }, 100);
        });
        
        // Handle visibility changes (app backgrounding)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && mobileState.screenSize === 'mobile') {
                hideAllMobilePanels();
            }
        });
    }

    // Initialize when DOM is ready
    function initialize() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeMobile);
        } else {
            initializeMobile();
        }
    }

    // Public API
    window.RED = window.RED || {};
    window.RED.mobileTouch = {
        init: initialize,
        togglePanel: toggleMobilePanel,
        hideAllPanels: hideAllMobilePanels,
        getState: () => ({ ...mobileState })
    };

    // Auto-initialize
    initialize();

})();