/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
RED.bottomPanel = (function() {

    var panel_tabs;
    var knownPanels = {};

    // Store the current bottom panel tab id in localStorage
    var lastSessionSelectedPanel = null;
    
    // Create and manage debug tab in sidebar
    function ensureDebugTabInSidebar() {
        const sidebarTabs = $('#red-ui-sidebar-tabs');
        let debugTabInSidebar = $('#red-ui-sidebar-tabs #red-ui-tab-debug');
        
        // Remove any existing debug tab from bottom panel
        $('#red-ui-bottom-panel-tabs #red-ui-tab-debug').remove();
        
        // Create debug tab in sidebar if it doesn't exist there
        if (!debugTabInSidebar.length && sidebarTabs.length) {
            debugTabInSidebar = $('<li>')
                .attr('id', 'red-ui-tab-debug')
                .attr('class', 'red-ui-tab red-ui-tab-pinned')
                .attr('style', 'width: 133px;')
                .html('<a href="#debug" class="red-ui-tab-label"><i class="red-ui-tab-icon fa fa-bug"></i><span class="red-ui-text-bidi-aware" dir="">debug</span></a><span class="red-ui-tabs-fade"></span><span class="red-ui-tabs-badges"></span>')
                .appendTo(sidebarTabs);
        }
        
        // Add debug button to tab-link-buttons as the third button
        const tabLinkButtons = $('.red-ui-tab-link-buttons');
        let debugLinkButton = $('#red-ui-tab-debug-link-button');
        
        if (!debugLinkButton.length && tabLinkButtons.length) {
            // Create debug link button
            debugLinkButton = $('<a href="#debug" class="red-ui-tab-link-button red-ui-tab-link-button-pinned" id="red-ui-tab-debug-link-button">')
                .html('<i class="fa fa-bug"></i>');
            
            // Insert as third button (after info and help, before config)
            const configButton = $('#red-ui-tab-config-link-button');
            if (configButton.length) {
                debugLinkButton.insertBefore(configButton);
            } else {
                debugLinkButton.appendTo(tabLinkButtons);
            }
            
            // Add click handler to toggle debug panel
            debugLinkButton.on("click", function(evt) {
                evt.preventDefault();
                RED.bottomPanel.togglePanel('debug');
            });
            
            // Add tooltip
            RED.popover.tooltip(debugLinkButton, "Debug messages", "core:show-debug-tab");
        }
        
        // Hide bottom panel tabs but keep the debug panel content visible
        $('#red-ui-bottom-panel-tabs').hide();
        
        // Add debug title to bottom panel header
        const bottomPanel = $('#red-ui-bottom-panel');
        let debugHeader = bottomPanel.find('.red-ui-debug-panel-header');
        if (!debugHeader.length) {
            debugHeader = $('<div class="red-ui-debug-panel-header">')
                .html('<i class="fa fa-bug"></i> Debug')
                .prependTo(bottomPanel);
        }
    }

    function addPanel(title, content, closeable, visible) {
        var options;
        if (typeof title === "string") {
            options = {
                id: content.id,
                label: title,
                name: title,
                content: content,
                closeable: closeable,
                visible: visible
            }
        } else if (typeof title === "object") {
            options = title;
        }

        delete options.closeable;

        options.wrapper = $('<div>',{style:"height:100%"}).appendTo("#red-ui-bottom-panel-content");
        options.wrapper.append(options.content);
        options.wrapper.hide();

        if (!options.enableOnEdit) {
            options.shade = $('<div>',{class:"red-ui-bottom-panel-shade hide"}).appendTo(options.wrapper);
        }

        if (options.toolbar) {
            $("#red-ui-bottom-panel-footer").append(options.toolbar);
            $(options.toolbar).hide();
        }
        var id = options.id;
        
        RED.menu.addItem("menu-item-view-menu",{
            id:"menu-item-view-menu-bottom-"+options.id,
            label:options.name,
            onselect:function() {
                showPanel(options.id);
            },
            group: "bottom-panel-tabs"
        });

        options.iconClass = options.iconClass || "fa fa-square-o";

        knownPanels[options.id] = options;

        // Special handling for debug panel
        if (id === 'debug') {
            // Create debug tab in sidebar instead of bottom panel
            ensureDebugTabInSidebar();
            // Still add debug panel to panel_tabs so content can be displayed
            panel_tabs.addTab(knownPanels[options.id]);
        } else if (options.visible !== false) {
            panel_tabs.addTab(knownPanels[options.id]);
        }
    }

    function removePanel(id) {
        panel_tabs.removeTab(id);
        $(knownPanels[id].wrapper).remove();
        if (knownPanels[id].footer) {
            knownPanels[id].footer.remove();
        }
        delete knownPanels[id];
        RED.menu.removeItem("menu-item-view-menu-bottom-"+id);
    }

    var panelSeparator = {};
    panelSeparator.dragging = false;

    function setupPanelSeparator() {
        $("#red-ui-bottom-panel-separator").draggable({
                axis: "y",
                start:function(event,ui) {
                    panelSeparator.closing = false;
                    panelSeparator.opening = false;
                    var winHeight = $("#red-ui-editor").height();
                    panelSeparator.start = ui.position.top;
                    panelSeparator.workspaceHeight = $("#red-ui-workspace").height();
                    panelSeparator.workspaceBottom = winHeight-$("#red-ui-workspace").height()-$("#red-ui-workspace").offset().top-2;
                    panelSeparator.dragging = true;

                    if (!RED.menu.isSelected("menu-item-bottom-panel")) {
                        panelSeparator.opening = true;
                        var newWorkspaceBottom = 7;
                        $("#red-ui-bottom-panel").addClass("closing");
                        $("#red-ui-workspace").css("bottom",newWorkspaceBottom);
                        $("#red-ui-editor-stack").css("bottom",newWorkspaceBottom+1);
                        $("#red-ui-bottom-panel").height(0);
                        RED.menu.setSelected("menu-item-bottom-panel",true);
                        RED.events.emit("bottomPanel:resize");
                    }
                    panelSeparator.height = $("#red-ui-bottom-panel").height();
                },
                drag: function(event,ui) {
                    var d = panelSeparator.start - ui.position.top;
                    var newPanelHeight = panelSeparator.height + d;
                    if (panelSeparator.opening) {
                        newPanelHeight -= 3;
                    }

                    var winHeight = $("#red-ui-editor").height();
                    var maxPanelHeight = Math.max(150, winHeight - 300); // Leave at least 300px for workspace and sidebar content

                    if (newPanelHeight > maxPanelHeight) {
                        newPanelHeight = maxPanelHeight;
                        ui.position.top = panelSeparator.start - (maxPanelHeight - panelSeparator.height);
                        d = panelSeparator.start - ui.position.top;
                    }

                    if (newPanelHeight > 150) {
                        if (panelSeparator.workspaceHeight - d < 200) {
                            ui.position.top = panelSeparator.start - (panelSeparator.workspaceHeight - 200);
                            d = panelSeparator.start - ui.position.top;
                            newPanelHeight = panelSeparator.height + d;
                        }
                    }

                    if (newPanelHeight < 150) {
                        if (!panelSeparator.closing) {
                            $("#red-ui-bottom-panel").addClass("closing");
                            panelSeparator.closing = true;
                        }
                        if (!panelSeparator.opening) {
                            newPanelHeight = 150;
                            ui.position.top = panelSeparator.start - (150 - panelSeparator.height);
                            d = panelSeparator.start - ui.position.top;
                        }
                    } else if (newPanelHeight > 150 && (panelSeparator.closing || panelSeparator.opening)) {
                        panelSeparator.closing = false;
                        $("#red-ui-bottom-panel").removeClass("closing");
                    }

                    var newWorkspaceBottom = panelSeparator.workspaceBottom + d;
                    $("#red-ui-workspace").css("bottom",newWorkspaceBottom);
                    $("#red-ui-editor-stack").css("bottom",newWorkspaceBottom+1);
                    $("#red-ui-bottom-panel").height(newPanelHeight);
                    
                    // Dynamically adjust sidebar bottom to match debug panel height
                    var sidebarBottom = newPanelHeight + 7;
                    $("#red-ui-sidebar").css("bottom", sidebarBottom + "px");
                    $("#red-ui-sidebar-separator").css("bottom", sidebarBottom + "px");

                    panel_tabs.resize();
                    if (RED.sidebar && RED.sidebar.resize) {
                        RED.sidebar.resize();
                    }
                    RED.events.emit("bottomPanel:resize");
                },
                stop:function(event,ui) {
                    panelSeparator.dragging = false;
                    if (panelSeparator.closing) {
                        $("#red-ui-bottom-panel").removeClass("closing");
                        RED.menu.setSelected("menu-item-bottom-panel",false);
                        if ($("#red-ui-bottom-panel").height() < 180) {
                            $("#red-ui-bottom-panel").height(180);
                            $("#red-ui-workspace").css("bottom",187);
                            $("#red-ui-editor-stack").css("bottom",188);
                        }
                    }
                    $("#red-ui-bottom-panel-separator").css("top","auto");
                    $("#red-ui-bottom-panel-separator").css("bottom",($("#red-ui-bottom-panel").height()+2)+"px");
                    
                    // Adjust sidebar position when drag stops
                    var panelHeight = $("#red-ui-bottom-panel").height();
                    if (panelHeight > 0 && RED.menu.isSelected("menu-item-bottom-panel")) {
                        $("#red-ui-sidebar").css("bottom", (panelHeight + 7) + "px");
                        $("#red-ui-sidebar-separator").css("bottom", (panelHeight + 7) + "px");
                    } else {
                        $("#red-ui-sidebar").css("bottom", "7px");
                        $("#red-ui-sidebar-separator").css("bottom", "7px");
                    }
                    
                    RED.events.emit("bottomPanel:resize");
                }
        });

        var panelControls = $('<div class="red-ui-bottom-panel-control-up"><i class="fa fa-chevron-up"></i></div>').appendTo($("#red-ui-bottom-panel-separator"));
        panelControls.on("click", function() {
            panelControls.hide();
            RED.menu.toggleSelected("menu-item-bottom-panel");
        })
        $("#red-ui-bottom-panel-separator").on("mouseenter", function() {
            if (!panelSeparator.dragging) {
                if (RED.menu.isSelected("menu-item-bottom-panel")) {
                    panelControls.find("i").addClass("fa-chevron-down").removeClass("fa-chevron-up");
                } else {
                    panelControls.find("i").removeClass("fa-chevron-down").addClass("fa-chevron-up");
                }
                panelControls.show();
            }
        })
        $("#red-ui-bottom-panel-separator").on("mouseleave", function() {
            if (!panelSeparator.dragging) {
                panelControls.stop(false,true);
                // Only hide if panel is open - if closed, keep button visible
                if (RED.menu.isSelected("menu-item-bottom-panel")) {
                    panelControls.hide();
                }
            }
        });
    }

    function togglePanel(state) {
        if (!state) {
            $("#red-ui-main-container").addClass("red-ui-bottom-panel-closed");
            // When panel is closed, show button with up arrow (to open)
            if (panel_tabs && $("#red-ui-bottom-panel-separator .red-ui-bottom-panel-control-up").length > 0) {
                $("#red-ui-bottom-panel-separator .red-ui-bottom-panel-control-up i")
                    .removeClass("fa-chevron-down").addClass("fa-chevron-up");
                $("#red-ui-bottom-panel-separator .red-ui-bottom-panel-control-up").show();
            }
            // Reset sidebar position when panel is closed
            $("#red-ui-sidebar").css("bottom", "7px");
            $("#red-ui-sidebar-separator").css("bottom", "7px");
        } else {
            $("#red-ui-main-container").removeClass("red-ui-bottom-panel-closed");
            panel_tabs.resize();
            // When panel is open, show button with down arrow (to close) but only on hover
            if (panel_tabs && $("#red-ui-bottom-panel-separator .red-ui-bottom-panel-control-up").length > 0) {
                $("#red-ui-bottom-panel-separator .red-ui-bottom-panel-control-up i")
                    .removeClass("fa-chevron-up").addClass("fa-chevron-down");
            }
            // Adjust sidebar position when panel is opened
            var panelHeight = $("#red-ui-bottom-panel").height();
            if (panelHeight > 0) {
                $("#red-ui-sidebar").css("bottom", (panelHeight + 7) + "px");
                $("#red-ui-sidebar-separator").css("bottom", (panelHeight + 7) + "px");
            }
        }
        if (RED.sidebar && RED.sidebar.resize) {
            RED.sidebar.resize();
        }
        RED.events.emit("bottomPanel:resize");
    }

    function showPanel(id, skipShowPanel) {
        if (id === ":first") {
            id = lastSessionSelectedPanel || RED.settings.get("editor.bottomPanel.order",["debug"])[0]
        }
        if (id) {
            if (!containsPanel(id) && knownPanels[id]) {
                panel_tabs.addTab(knownPanels[id]);
            }
            panel_tabs.activateTab(id);
            if (!skipShowPanel && !RED.menu.isSelected("menu-item-bottom-panel")) {
                RED.menu.setSelected("menu-item-bottom-panel",true);
            }
        }
    }

    function containsPanel(id) {
        return panel_tabs.contains(id);
    }

    function init() {
        setupPanelSeparator();
        panel_tabs = RED.tabs.create({
            element: $('<ul id="red-ui-bottom-panel-tabs"></ul>').appendTo("#red-ui-bottom-panel"),
            onchange:function(tab) {
                $("#red-ui-bottom-panel-content").children().hide();
                $("#red-ui-bottom-panel-footer").children().hide();
                if (tab.onchange) {
                    tab.onchange.call(tab);
                }
                $(tab.wrapper).show();
                if (tab.toolbar) {
                    $(tab.toolbar).show();
                }
                RED.settings.setLocal("last-bottom-panel-tab", tab.id)
            },
            onremove: function(tab) {
                $(tab.wrapper).hide();
                if (tab.onremove) {
                    tab.onremove.call(tab);
                }
            },
            collapsible: true,
            onreorder: function(order) {
                RED.settings.set("editor.bottomPanel.order",order);
            },
            order: RED.settings.get("editor.bottomPanel.order",["debug"])
        });

        $('<div id="red-ui-bottom-panel-content"></div>').appendTo("#red-ui-bottom-panel");
        $('<div id="red-ui-bottom-panel-footer" class="red-ui-component-footer"></div>').appendTo("#red-ui-bottom-panel");
        $('<div id="red-ui-bottom-panel-shade" class="hide"></div>').appendTo("#red-ui-bottom-panel");

        RED.actions.add("core:toggle-bottom-panel",function(state){
            if (state === undefined) {
                RED.menu.toggleSelected("menu-item-bottom-panel");
            } else {
                togglePanel(state);
            }
        });
        
        // Listen for menu state changes to call togglePanel
        RED.events.on("menu:change", function(data) {
            if (data.id === "menu-item-bottom-panel") {
                togglePanel(data.selected);
            }
        });
        RED.popover.tooltip($("#red-ui-bottom-panel-separator").find(".red-ui-bottom-panel-control-up"),RED._("keyboard.toggleBottomPanel"),"core:toggle-bottom-panel");


        // Handle debug tab clicks to open/switch to debug panel
        $(document).on('click', '#red-ui-tab-debug a', function(e) {
            e.preventDefault();
            const isBottomPanelOpen = RED.menu.isSelected("menu-item-bottom-panel");
            if (!isBottomPanelOpen) {
                // If panel is closed, open it first then show debug tab
                RED.menu.setSelected("menu-item-bottom-panel", true);
                setTimeout(() => {
                    showPanel("debug");
                }, 100);
            } else {
                // If panel is already open, just switch to debug tab
                showPanel("debug");
            }
        });

        // Ensure proper sidebar layout when debug panel is resized
        function adjustSidebarForDebugPanel() {
            ensureDebugTabInSidebar();
            
            const isBottomPanelOpen = RED.menu.isSelected("menu-item-bottom-panel");
            const debugPanelHeight = $("#red-ui-bottom-panel").height();
            const sidebar = $('.red-ui-sidebar');
            
            if (isBottomPanelOpen && debugPanelHeight > 0) {
                // When debug panel is open, adjust sidebar to not overlap
                const newSidebarBottom = debugPanelHeight + 7; // Account for separator
                sidebar.css('bottom', newSidebarBottom + 'px');
            } else {
                // When debug panel is closed, reset sidebar to default
                sidebar.css('bottom', '7px');
            }
        }

        // Listen for bottom panel toggle and resize events
        RED.events.on("bottomPanel:resize", adjustSidebarForDebugPanel);
        
        // Initial setup
        setTimeout(ensureDebugTabInSidebar, 100);

        lastSessionSelectedPanel = RED.settings.getLocal("last-bottom-panel-tab");
    }

    return {
        init: init,
        addPanel: addPanel,
        removePanel: removePanel,
        show: showPanel,
        containsPanel: containsPanel,
        togglePanel: togglePanel,
    }

})();