name: Deploy to GitHub Pages

on:
  push:
    branches:
      - gh-pages

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write # Write for PR comments
  issues: write # Write for issue comments

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."
          # The action automatically excludes .git and other hidden directories

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Post screenshot comparisons after successful deployment
  post-comparison:
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Find new screenshot directories and post comparisons
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { promisify } = require('util');
            const readdir = promisify(fs.readdir);
            const readFile = promisify(fs.readFile);
            const writeFile = promisify(fs.writeFile);
            const stat = promisify(fs.stat);
            
            // Find all metadata.json files in ISSUE_ID/COMMIT_HASH/ structure
            async function findMetadataFiles() {
              const metadataFiles = [];
              
              try {
                const items = await readdir('.');
                
                for (const item of items) {
                  try {
                    const itemStat = await stat(item);
                    if (itemStat.isDirectory() && /^\d+$/.test(item)) { // Check if directory name is numeric (issue ID)
                      const issueDir = item;
                      const issueDirItems = await readdir(issueDir);
                      
                      for (const subItem of issueDirItems) {
                        const subPath = path.join(issueDir, subItem);
                        const subStat = await stat(subPath);
                        
                        if (subStat.isDirectory()) { // This should be the commit hash directory
                          const metadataPath = path.join(subPath, 'metadata.json');
                          try {
                            await stat(metadataPath);
                            metadataFiles.push(metadataPath);
                          } catch (err) {
                            // metadata.json doesn't exist in this directory, skip
                          }
                        }
                      }
                    }
                  } catch (err) {
                    console.log(`Skipping item ${item}: ${err.message}`);
                  }
                }
              } catch (err) {
                console.log(`Error reading directory: ${err.message}`);
              }
              
              return metadataFiles;
            }
            
            // Process each metadata file
            const metadataFiles = await findMetadataFiles();
            console.log(`Found ${metadataFiles.length} metadata files to process`);
            
            for (const metadataPath of metadataFiles) {
              console.log(`Processing: ${metadataPath}`);
              
              try {
                // Read and parse metadata
                const metadataContent = await readFile(metadataPath, 'utf8');
                const metadata = JSON.parse(metadataContent);
                
                // Validate essential data
                if (!metadata.issue_number || !metadata.commit_hash) {
                  console.log(`Skipping ${metadataPath} - missing essential data`);
                  continue;
                }
                
                const issueNumber = parseInt(metadata.issue_number);
                const commitHash = metadata.commit_hash;
                const repoOwner = metadata.repository_owner;
                const repoName = metadata.repository_name;
                
                // Build image base URL
                const imageBaseUrl = `https://${repoOwner}.github.io/${repoName}/${issueNumber}/${commitHash}`;
                
                // Check for before/after screenshot pairs
                const screenshotDir = path.dirname(metadataPath);
                let commentBody = '## ðŸ“¸ Visual Comparison\n\n| Before | After |\n|--------|-------|\n';
                let screenshotsFound = false;
                
                for (let i = 1; i <= 5; i++) {
                  const beforeFile = path.join(screenshotDir, `before-${i}.png`);
                  const afterFile = path.join(screenshotDir, `after-${i}.png`);
                  
                  try {
                    await stat(beforeFile);
                    await stat(afterFile);
                    commentBody += `| ![Before ${i}](${imageBaseUrl}/before-${i}.png) | ![After ${i}](${imageBaseUrl}/after-${i}.png) |\n`;
                    screenshotsFound = true;
                  } catch (err) {
                    // Screenshot pair doesn't exist, skip
                  }
                }
                
                // Post comment if screenshots were found
                if (screenshotsFound) {
                  console.log(`Posting comparison for issue #${issueNumber}`);
                  
                  await github.rest.issues.createComment({
                    issue_number: issueNumber,
                    owner: repoOwner,
                    repo: repoName,
                    body: commentBody
                  });
                  
                  console.log(`Successfully posted comment for issue #${issueNumber}`);
                } else {
                  console.log(`No screenshot pairs found in ${screenshotDir}`);
                }
                
              } catch (err) {
                console.log(`Error processing ${metadataPath}: ${err.message}`);
              }
            }
