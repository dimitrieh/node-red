name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    outputs:
      issue-id: ${{ steps.detect-branch.outputs.issue_id }}
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            .gitattributes
            .github/
            .gitignore
            .jshintrc
            API.md
            CHANGELOG.md
            CITATION.cff
            CODE_OF_CONDUCT.md
            CONTRIBUTING.md
            Gruntfile.js
            jsdoc.json
            LICENSE
            nodemon.json
            package.json
            packages/
            README.md
            scripts/
            SECURITY.md
            test/
          sparse-checkout-cone-mode: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers and dependencies
        run: npx playwright install --with-deps chromium

      - name: Build Node-RED
        run: npm run build

      - name: Start Node-RED in background
        run: |
          npm start &
          echo $! > node-red.pid
          # Wait for Node-RED to start
          sleep 10
          curl -f http://localhost:1880 || (echo "Node-RED failed to start" && exit 1)

      - name: Ensure Playwright MCP directory exists
        run: mkdir -p .playwright-mcp

      # Create a persistent plan file for state sharing between steps
      - name: Initialize plan file
        run: echo "# Implementation Plan" > plan.md

      # Step 1: Analysis only - explicitly prevent changes
      - name: Step 1 - Analyze Request and Plan
        id: analyze-and-plan
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --system-prompt "You are an expert Node-RED developer with strong UI/UX design knowledge.
            ## CRITICAL INSTRUCTION: ANALYSIS ONLY - NO CHANGES
            Your ONLY task is to understand the request and create a detailed plan. You MUST NOT make any code changes, file modifications, or implementations in this step.
            ## Step 1: Understand and Create Plan
            1. Read the GitHub issue/comment that triggered this workflow
            2. Explore the Node-RED codebase to understand current implementation
            3. Create a specific implementation plan and SAVE IT TO plan.md:
               - Which specific UI areas/components will be affected
               - What files need to be modified  
               - What the expected visual changes will be (numbered list)
               - Step-by-step implementation approach
               - UX considerations: visual hierarchy, color consistency, sufficient contrast, intuitive interactions, accessibility, touch-friendly sizing. Adherence to existing design patterns takes priority unless requested differently. Do not extend scope unnecessarily.
            4. Navigate to and take comprehensive initial screenshots of ALL areas that will be modified using playwright:
               - Identify all distinct UI areas/components that will be affected by the requested changes
               - For EACH identified area, capture screenshots using this numbering system:
                 * Area 1: Main editor/workspace - before-1-[resolution].png  
                 * Area 2: Node palette - before-2-[resolution].png
                 * Area 3: Sidebar - before-3-[resolution].png
                 * Continue numbering for additional areas (before-4-, before-5-, etc.)
               - CRITICAL: Use EXACT filenames - NO other naming patterns will work
               - Use mcp__playwright__browser_resize to set each resolution before capturing
               - Use mcp__playwright__browser_take_screenshot with filename parameter
               - Capture 4 resolutions for EACH area with these EXACT filenames:
                 * Desktop (1920x1080) ‚Üí before-1-desktop.png, before-2-desktop.png, etc.
                 * Laptop (1440x900) ‚Üí before-1-laptop.png, before-2-laptop.png, etc.
                 * Tablet (768x1024) ‚Üí before-1-tablet.png, before-2-tablet.png, etc.
                 * Mobile (375x667) ‚Üí before-1-mobile.png, before-2-mobile.png, etc.
               - Example: For Area 1 Main Editor you MUST create exactly these 4 files:
                 * before-1-desktop.png, before-1-laptop.png, before-1-tablet.png, before-1-mobile.png
               - Navigate to different UI states/views if needed to capture all relevant areas
            ## Environment
            Node-RED is running on http://localhost:1880
            SAVE YOUR COMPLETE PLAN TO plan.md - this will be read by subsequent steps.
            REMINDER: Do NOT implement anything - only analyze and plan."
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}' 
            --allowedTools mcp__playwright__browser_navigate,mcp__playwright__browser_snapshot,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_resize,mcp__playwright__browser_wait_for,mcp__playwright__browser_click,mcp__playwright__browser_evaluate,Write,Read

      # Validate Step 1 screenshots were created with correct naming
      - name: Validate Step 1 Screenshots
        run: |
          echo "=== Step 1 Screenshot Validation ==="
          if [ -d ".playwright-mcp" ]; then
            echo "üìÅ .playwright-mcp directory exists"
            
            # Count screenshots by pattern
            BEFORE_COUNT=$(ls -1 .playwright-mcp/before-*-*.png 2>/dev/null | wc -l)
            DESCRIPTIVE_COUNT=$(ls -1 .playwright-mcp/*.png 2>/dev/null | grep -v -E '^.playwright-mcp/(before|after)-[0-9]+-' | wc -l)
            
            echo "üìä Screenshots found:"
            echo "  - Correct pattern (before-N-resolution.png): $BEFORE_COUNT"
            echo "  - Other/descriptive names: $DESCRIPTIVE_COUNT"
            
            if [ $BEFORE_COUNT -gt 0 ]; then
              echo "‚úÖ Step 1 created screenshots with correct naming pattern"
              echo "üìã Before screenshots found:"
              ls -1 .playwright-mcp/before-*-*.png 2>/dev/null || true
            else
              echo "‚ö†Ô∏è  No screenshots found with correct naming pattern"
              echo "üìã All PNG files in directory:"
              ls -1 .playwright-mcp/*.png 2>/dev/null | head -10 || echo "No PNG files found"
            fi
          else
            echo "‚ùå .playwright-mcp directory not found"
            exit 1
          fi

      # Ensure Node-RED is running before Step 2
      - name: Verify Node-RED Status Before Step 2
        run: |
          echo "üîç Checking Node-RED status..."
          if ! curl -f http://localhost:1880 >/dev/null 2>&1; then
            echo "‚ùå Node-RED not responding, rebuilding and restarting..."
            kill $(cat node-red.pid) 2>/dev/null || true
            npm run build
            npm start &
            echo $! > node-red.pid
            
            # Enhanced readiness check with UI validation
            for i in {1..30}; do
              if curl -f http://localhost:1880 >/dev/null 2>&1; then
                # Check if UI assets are loaded (not just server responding)
                if curl -f http://localhost:1880/red/red.min.js >/dev/null 2>&1; then
                  echo "‚úÖ Node-RED UI fully ready (attempt $i)"
                  break
                fi
              fi
              echo "‚è≥ Waiting for Node-RED UI... attempt $i/30"
              sleep 2
            done
            
            # Final validation
            curl -f http://localhost:1880 || (echo "‚ùå Node-RED failed to start properly" && exit 1)
          else
            echo "‚úÖ Node-RED is running properly"
          fi

      # Create CLAUDE.md with step 2 instructions
      - name: Create CLAUDE.md for Step 2
        run: |
          cat > CLAUDE.md << 'EOF'
          You are an expert Node-RED developer with strong UI/UX design knowledge.
          ## CRITICAL INSTRUCTION: IMPLEMENT CHANGES THROUGH ITERATIVELY TESTING CHANGES AND REFINING BASED ON PLAYWRIGHT FEEDBACK
          You are continuing the work from Step 1 by implementing changes for GitHub issue #${{ github.event.issue.number || github.event.pull_request.number }}
          ## Context from Step 1:
          - Implementation plan is saved in plan.md - READ THIS FIRST
          - Node-RED server should be running on http://localhost:1880 (verify with curl) otherwise restart it
          ## Step 2: Implement and iteratively adjust based on Playwright testing until completion of plan
          You are working on the implementation phase with iterative testing and refinement. Follow this process:
          ### MANDATORY Implementation Loop Process
          1. READ the detailed plan from plan.md - this contains the complete implementation strategy created in Step 1
          2. Make SMALL incremental changes (not the entire implementation at once)
          3. For frontend changes: run npm run build to rebuild assets
          4. For backend/core changes: restart Node-RED if needed using:
          kill $(cat node-red.pid) && npm start & && echo $! > node-red.pid && sleep 10
          5. **MANDATORY: Navigate to http://localhost:1880 and test with Playwright**
          6. **MANDATORY: Take screenshot and analyze what you see vs what was expected**
          7. **If testing reveals issues: make additional changes and repeat from step 3**
          8. **Repeat steps 2-7 until each small change is verified working**
          9. **ONLY consider complete when Playwright confirms all functionality works correctly**
          ## CRITICAL: You MUST test each change with Playwright before proceeding
          - Do NOT implement multiple features without testing each one
          - Do NOT assume your code works - verify with browser automation
          - Use Playwright to see the actual visual result after every change
          ## Playwright-Driven Iterative Development
          - ALWAYS use Playwright for all browser testing and feedback
          - Use Playwright to discover what needs adjustment: UI layout, functionality, user experience
          - Let Playwright testing guide your implementation decisions
          - After each code change, immediately test with Playwright browser automation
          - Use Playwright findings to refine and improve the implementation
          - Continue the implement ‚Üí test ‚Üí refine cycle until Playwright confirms success
          ## ABSOLUTE REQUIREMENT: Let Playwright Drive Improvements
          - NEVER implement code without immediately testing it with Playwright
          - Don't just implement the plan - let Playwright testing show you what actually works
          - Use browser automation to discover edge cases and usability issues
          - Make iterative improvements based on what you observe through Playwright
          - The plan is your starting point, but Playwright testing should guide refinements
          - If you complete Step 2 without using Playwright extensively, you have FAILED
          ## Implementation Guidelines
          - Apply UI/UX best practices based on what Playwright testing reveals: visual hierarchy, color consistency, sufficient contrast, intuitive interactions, accessibility, touch-friendly sizing. Adherence to existing design patterns takes priority unless requested differently. Do not extend scope unnecessarily.
          - Maintain consistency with existing interface patterns
          - Focus on what the plan specifies, but improve based on testing feedback
          - Don't stop at good enough - iterate until Playwright confirms functional and visual excellence
          ## Environment
          - Node-RED is running on http://localhost:1880
          - You are working on branch: ${{ env.CLAUDE_BRANCH }}
          - The plan file contains your starting strategy - use it with Playwright feedback
          Begin iterative implementation now.
          EOF

      # Step 2: Implementation based on saved plan
      - name: Step 2 - Implement and Test Changes
        id: implement-changes
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}' 
            --allowedTools mcp__playwright__browser_close,mcp__playwright__browser_resize,mcp__playwright__browser_console_messages,mcp__playwright__browser_handle_dialog,mcp__playwright__browser_evaluate,mcp__playwright__browser_file_upload,mcp__playwright__browser_fill_form,mcp__playwright__browser_install,mcp__playwright__browser_press_key,mcp__playwright__browser_type,mcp__playwright__browser_navigate,mcp__playwright__browser_navigate_back,mcp__playwright__browser_network_requests,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_snapshot,mcp__playwright__browser_click,mcp__playwright__browser_drag,mcp__playwright__browser_hover,mcp__playwright__browser_select_option,mcp__playwright__browser_tabs,mcp__playwright__browser_wait_for,Read,Write,Edit,MultiEdit,Bash

      # Remove CLAUDE.md after Step 2
      - name: Remove CLAUDE.md after Step 2
        run: rm -f CLAUDE.md

      # Ensure Node-RED is running before Step 3
      - name: Verify Node-RED Status Before Step 3
        run: |
          echo "üîç Checking Node-RED status before Step 3..."
          if ! curl -f http://localhost:1880 >/dev/null 2>&1; then
            echo "‚ùå Node-RED not responding, rebuilding and restarting..."
            kill $(cat node-red.pid) 2>/dev/null || true
            npm run build
            npm start &
            echo $! > node-red.pid
            
            # Enhanced readiness check with UI validation
            for i in {1..30}; do
              if curl -f http://localhost:1880 >/dev/null 2>&1; then
                # Check if UI assets are loaded
                if curl -f http://localhost:1880/red/red.min.js >/dev/null 2>&1; then
                  echo "‚úÖ Node-RED UI fully ready for Step 3 (attempt $i)"
                  break
                fi
              fi
              echo "‚è≥ Waiting for Node-RED UI... attempt $i/30"
              sleep 2
            done
            
            # Final validation
            curl -f http://localhost:1880 || (echo "‚ùå Node-RED failed to start properly" && exit 1)
          else
            echo "‚úÖ Node-RED is running properly for Step 3"
          fi

      - name: Extract Issue Information and Detect Branch
        id: detect-branch
        run: |
          BRANCH=$(git branch --show-current)
          echo "Step 1 created/used branch: $BRANCH"
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "CLAUDE_BRANCH=$BRANCH" >> $GITHUB_ENV

          # Extract issue/PR number for folder structure
          ISSUE_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "ISSUE_ID=$ISSUE_NUMBER" >> $GITHUB_ENV
          echo "issue_id=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "Issue/PR Number: $ISSUE_NUMBER"

      # Step 3: Screenshot documentation
      - name: Step 3 - Take After Screenshots
        id: post-comparison
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --system-prompt "You are a screenshot automation tool for Step 3.
            ## CRITICAL INSTRUCTION: SCREENSHOTS ONLY - NO CODE MODIFICATIONS
            You are in the FINAL SCREENSHOT phase. Your ONLY permitted actions are:
            - TAKE SCREENSHOTS using Playwright (mcp__playwright__browser_take_screenshot)
            - SAVE screenshots to .playwright-mcp/ directory with exact filenames
            - Navigate and resize browser as needed
            YOU MUST NOT:
            - Modify any source code files (.js, .html, .css, .json, etc.)
            - Make additional implementations or improvements
            - Change Node-RED functionality in any way
            - Edit existing implementation files
            ## Step 3: Take Screenshots
            You are taking final screenshots on branch: ${{ env.CLAUDE_BRANCH }}
            ## Your Screenshot Tasks (Mirror Step 1 approach):
            1. Identify which UI areas were modified by checking existing before-*.png files in .playwright-mcp/
            2. Navigate to http://localhost:1880 using mcp__playwright__browser_navigate
            3. For EACH area that has before screenshots, take matching after screenshots:
               - CRITICAL: Use EXACT filename pattern - after-[NUMBER]-[RESOLUTION].png
               - Use mcp__playwright__browser_resize to set each resolution before capturing
               - Use mcp__playwright__browser_take_screenshot with filename parameter
               - Capture 4 resolutions for EACH area with these EXACT filenames:
                 * Desktop (1920x1080) ‚Üí after-1-desktop.png, after-2-desktop.png, etc.
                 * Laptop (1440x900) ‚Üí after-1-laptop.png, after-2-laptop.png, etc. 
                 * Tablet (768x1024) ‚Üí after-1-tablet.png, after-2-tablet.png, etc.
                 * Mobile (375x667) ‚Üí after-1-mobile.png, after-2-mobile.png, etc.
               - Example: If Step 1 created before-1-desktop.png, you MUST create after-1-desktop.png
               - NO descriptive names like 'dashboard-after.png' - only numbered pattern works
               - Navigate to different UI states/views as needed to capture the same areas as Step 1
            ## Critical Requirements:
            - Use mcp__playwright__browser_resize BEFORE each screenshot
            - Use mcp__playwright__browser_take_screenshot with filename parameter
            - Save ALL screenshots to .playwright-mcp/ directory
            - Do NOT try to read/verify screenshot files - just take them and move on
            - Complete ALL 4 resolutions for each area before moving to next area
            - If a screenshot fails, continue with the next one
            ## Environment
            - Node-RED is running on http://localhost:1880 (verified)
            - You are working on branch: ${{ env.CLAUDE_BRANCH }}
            - Screenshots will be automatically archived after this step
            ## Error Handling
            - If Node-RED is not accessible, report the issue but don't fail
            - If a screenshot fails, log it but continue with remaining screenshots
            - Focus on completing as many screenshots as possible
            Begin taking after screenshots now. Do NOT read files - just take screenshots."
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}'
            --allowedTools mcp__playwright__browser_navigate,mcp__playwright__browser_snapshot,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_resize,mcp__playwright__browser_wait_for,mcp__playwright__browser_click,mcp__playwright__browser_evaluate,Write,Read

      # Validate Step 3 screenshots were created
      - name: Validate Step 3 Screenshots
        if: always() && steps.post-comparison.conclusion != 'skipped'
        run: |
          echo "=== Step 3 Screenshot Validation ==="
          if [ -d ".playwright-mcp" ]; then
            # Count before and after screenshots
            BEFORE_COUNT=$(ls -1 .playwright-mcp/before-*-*.png 2>/dev/null | wc -l)
            AFTER_COUNT=$(ls -1 .playwright-mcp/after-*-*.png 2>/dev/null | wc -l)
            
            echo "üìä Final screenshot count:"
            echo "  - Before screenshots (before-N-resolution.png): $BEFORE_COUNT"
            echo "  - After screenshots (after-N-resolution.png): $AFTER_COUNT"
            
            if [ $BEFORE_COUNT -gt 0 ] && [ $AFTER_COUNT -gt 0 ]; then
              echo "‚úÖ Both before and after screenshots found"
              
              # Check for matching pairs
              echo "üîç Checking for screenshot pairs:"
              for before_file in .playwright-mcp/before-*-*.png; do
                if [ -f "$before_file" ]; then
                  after_file=$(echo "$before_file" | sed 's/before-/after-/')
                  if [ -f "$after_file" ]; then
                    echo "  ‚úÖ Pair: $(basename "$before_file") ‚Üî $(basename "$after_file")"
                  else
                    echo "  ‚ö†Ô∏è  Missing after: $(basename "$before_file") ‚Üî $(basename "$after_file")"
                  fi
                fi
              done
            else
              echo "‚ö†Ô∏è  Incomplete screenshot set - before: $BEFORE_COUNT, after: $AFTER_COUNT"
            fi
          else
            echo "‚ùå .playwright-mcp directory not found"
          fi

      # Archive screenshots with issue and run ID
      - name: Archive Screenshots to Issue/Run Folder
        if: always() && steps.post-comparison.conclusion != 'skipped'
        run: |
          # Use GitHub Actions run ID for consistent identification
          RUN_ID="${{ github.run_id }}"
          SCREENSHOT_DIR="${{ env.ISSUE_ID }}/${RUN_ID}"

          # Create directory with issue/commit structure
          mkdir -p "$SCREENSHOT_DIR"

          # Debug: List all files in .playwright-mcp directory
          echo "üìÅ Contents of .playwright-mcp directory:"
          if [ -d ".playwright-mcp" ]; then
            ls -la .playwright-mcp/ || echo "Directory exists but ls failed"
          else
            echo "‚ùå .playwright-mcp directory does not exist"
          fi

          # Copy screenshots with primary and fallback patterns
          if [ -d ".playwright-mcp" ]; then
            echo "üì∏ Copying screenshot files to $SCREENSHOT_DIR/"
            # Use bash arrays to safely handle files that may or may not exist
            shopt -s nullglob  # Make glob patterns expand to nothing if no matches
            COPIED_COUNT=0
            
            # Primary pattern: strict naming (before-N-resolution.png, after-N-resolution.png)
            echo "üéØ Trying primary pattern: before-*.png and after-*.png"
            for file in .playwright-mcp/before-*.png .playwright-mcp/after-*.png; do
              if [ -f "$file" ]; then
                # Use cross-platform stat command (Linux first, then macOS fallback)
                FILE_SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "unknown size")
                echo "  ‚úÖ Copying: $file ($FILE_SIZE bytes)"
                cp "$file" "$SCREENSHOT_DIR/"
                COPIED_COUNT=$((COPIED_COUNT + 1))
              fi
            done
            
            # Fallback pattern: any PNG files if primary pattern found nothing
            if [ $COPIED_COUNT -eq 0 ]; then
              echo "‚ö†Ô∏è  No files found with primary pattern, trying fallback: any *.png files"
              for file in .playwright-mcp/*.png; do
                if [ -f "$file" ]; then
                  # Use cross-platform stat command
                  FILE_SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "unknown size")
                  echo "  üìÑ Fallback copying: $file ($FILE_SIZE bytes)"
                  cp "$file" "$SCREENSHOT_DIR/"
                  COPIED_COUNT=$((COPIED_COUNT + 1))
                fi
              done
              
              if [ $COPIED_COUNT -gt 0 ]; then
                echo "‚ö†Ô∏è  Used fallback pattern - comment generation may be affected"
              fi
            fi
            
            shopt -u nullglob  # Reset nullglob
            echo "üìä Total files copied: $COPIED_COUNT"
          else
            echo "‚ùå .playwright-mcp directory not found, no screenshots to copy"
          fi

          # Create metadata file for GitHub Pages workflow
          cat > "$SCREENSHOT_DIR/metadata.json" << EOF
          {
            "issue_number": "${{ env.ISSUE_ID }}",
            "run_id": "$RUN_ID",
            "repository_owner": "${{ github.repository_owner }}",
            "repository_name": "${{ github.event.repository.name }}",
            "event_type": "${{ github.event_name }}",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      # Upload screenshots as artifact for deployment job
      - name: Upload Screenshots Artifact
        if: always() && steps.post-comparison.conclusion != 'skipped'
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ env.ISSUE_ID }}-${{ github.run_id }}
          path: ${{ env.ISSUE_ID }}/
          retention-days: 1

  # Separate job to deploy screenshots to gh-pages with write permissions
  deploy-screenshots:
    needs: claude
    runs-on: ubuntu-latest
    if: always() && (needs.claude.result == 'success' || needs.claude.result == 'failure') && needs.claude.outputs.issue-id
    permissions:
      contents: write # Required to push to gh-pages branch
      issues: write # Required to post comments on issues
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Screenshots Artifact
        uses: actions/download-artifact@v4
        with:
          name: screenshots-${{ needs.claude.outputs.issue-id }}-${{ github.run_id }}
          path: ./screenshots/${{ needs.claude.outputs.issue-id }}

      - name: Deploy Screenshots to gh-pages
        id: deploy
        run: |
          # Set up git config for commits
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Create a worktree for gh-pages branch
          git fetch origin gh-pages:gh-pages || git checkout --orphan gh-pages
          git worktree add ../gh-pages-deploy gh-pages || {
            # If worktree already exists, remove and recreate
            git worktree remove ../gh-pages-deploy --force 2>/dev/null || true
            git worktree add ../gh-pages-deploy gh-pages
          }

          # Switch to worktree 
          cd ../gh-pages-deploy

          # Copy screenshots with run ID structure (no restructuring needed)
          if [ -d "../node-red/screenshots" ]; then
            cp -r ../node-red/screenshots/. . 2>/dev/null || true
            
            # Check if there are any changes to commit
            if [ -n "$(git status --porcelain)" ]; then
              git add .
              git commit -m "Add screenshots from workflow run ${{ github.run_id }}

              Event: ${{ github.event_name }}
              Repository: ${{ github.repository }}
              Run ID: ${{ github.run_id }}"
              
              git push origin gh-pages
              echo "Screenshots deployed to gh-pages"
              echo "deploy_success=true" >> $GITHUB_OUTPUT
              echo "run_id=${{ github.run_id }}" >> $GITHUB_OUTPUT
            else
              echo "No screenshots to deploy"
              echo "deploy_success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No screenshots directory found"
            echo "deploy_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Comparison Comment
        if: steps.deploy.outputs.deploy_success == 'true'
        run: |
          # Get variables for comment generation
          ISSUE_NUMBER="${{ needs.claude.outputs.issue-id }}"
          RUN_ID="${{ steps.deploy.outputs.run_id }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          IMAGE_BASE_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}/${ISSUE_NUMBER}/${RUN_ID}"

          echo "Generating comparison comment for issue #${ISSUE_NUMBER}"
          echo "Using run ID: ${RUN_ID}"
          echo "Base URL: ${IMAGE_BASE_URL}"

          # Build comparison comment
          COMMENT_BODY="## üì∏ Visual Comparison\n\n"

          # Check for screenshot pairs across different numbering and resolution patterns
          SCREENSHOTS_FOUND=false
          cd ../gh-pages-deploy

          # Verify the directory structure exists
          if [ -d "${ISSUE_NUMBER}/${RUN_ID}" ]; then
            echo "Found screenshot directory: ${ISSUE_NUMBER}/${RUN_ID}"
            ls -la "${ISSUE_NUMBER}/${RUN_ID}/"
          else
            echo "Screenshot directory not found: ${ISSUE_NUMBER}/${RUN_ID}"
          fi

          for i in {1..5}; do
            SECTION_FOUND=false
            SECTION_BODY=""
            
            # Check each resolution for this screenshot number
            for RESOLUTION in "desktop:Desktop (1920x1080)" "laptop:Laptop (1440x900)" "tablet:Tablet (768x1024)" "mobile:Mobile (375x667)"; do
              RES_SUFFIX=$(echo $RESOLUTION | cut -d: -f1)
              RES_NAME=$(echo $RESOLUTION | cut -d: -f2)
              
              BEFORE_FILE="${ISSUE_NUMBER}/${RUN_ID}/before-${i}-${RES_SUFFIX}.png"
              AFTER_FILE="${ISSUE_NUMBER}/${RUN_ID}/after-${i}-${RES_SUFFIX}.png"
              
              if [ -f "$BEFORE_FILE" ] && [ -f "$AFTER_FILE" ]; then
                if [ "$SECTION_FOUND" = false ]; then
                  SECTION_BODY="### Screenshot ${i}\n\n| Resolution | Before | After |\n|------------|--------|-------|\n"
                  SECTION_FOUND=true
                fi
                
                SECTION_BODY="${SECTION_BODY}| ${RES_NAME} | ![Before ${i} ${RES_SUFFIX}](${IMAGE_BASE_URL}/before-${i}-${RES_SUFFIX}.png) | ![After ${i} ${RES_SUFFIX}](${IMAGE_BASE_URL}/after-${i}-${RES_SUFFIX}.png) |\n"
                SCREENSHOTS_FOUND=true
                echo "Found screenshot pair: ${i}-${RES_SUFFIX}"
              fi
            done
            
            if [ "$SECTION_FOUND" = true ]; then
              COMMENT_BODY="${COMMENT_BODY}${SECTION_BODY}\n"
            fi
          done

          # Post comment if screenshots were found
          if [ "$SCREENSHOTS_FOUND" = true ]; then
            echo "‚úÖ Posting comparison comment to issue #${ISSUE_NUMBER}"
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments" \
              -d "{\"body\":\"${COMMENT_BODY}\"}"
            
            echo "‚úÖ Successfully posted comparison comment"
          else
            echo "‚ö†Ô∏è  No screenshot pairs found for comparison"
            ls -la "${ISSUE_NUMBER}/${RUN_ID}/" || echo "Screenshot directory not found"
            
            # Post fallback comment indicating implementation completion
            FALLBACK_COMMENT="## üîß Implementation Complete\\n\\nChanges have been implemented for this issue.\\n\\n‚ö†Ô∏è Screenshots were not generated in the expected format, but the implementation has been completed. You can check the [workflow run](https://github.com/${REPO_OWNER}/${REPO_NAME}/actions/runs/${{ github.run_id }}) for implementation details.\\n\\n### Available Files\\n"
            
            # List any files that were deployed
            if [ -d "${ISSUE_NUMBER}/${RUN_ID}" ]; then
              FALLBACK_COMMENT="${FALLBACK_COMMENT}\\nFiles found in deployment:\\n"
              for file in "${ISSUE_NUMBER}/${RUN_ID}"/*.png; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  FALLBACK_COMMENT="${FALLBACK_COMMENT}- ![${filename}](${IMAGE_BASE_URL}/${filename})\\n"
                fi
              done
            fi
            
            echo "üìù Posting fallback comment about implementation completion"
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments" \
              -d "{\"body\":\"${FALLBACK_COMMENT}\"}"
              
            echo "‚úÖ Posted fallback implementation comment"
          fi
