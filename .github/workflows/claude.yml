name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            .gitattributes
            .github/
            .gitignore
            .jshintrc
            API.md
            CHANGELOG.md
            CITATION.cff
            CODE_OF_CONDUCT.md
            CONTRIBUTING.md
            Gruntfile.js
            jsdoc.json
            LICENSE
            nodemon.json
            package.json
            packages/
            README.md
            scripts/
            SECURITY.md
            test/
          sparse-checkout-cone-mode: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers and dependencies
        run: npx playwright install --with-deps chromium

      - name: Build Node-RED
        run: npm run build

      - name: Start Node-RED in background
        run: |
          npm start &
          echo $! > node-red.pid
          # Wait for Node-RED to start
          sleep 10
          curl -f http://localhost:1880 || (echo "Node-RED failed to start" && exit 1)

      - name: Ensure Playwright MCP directory exists
        run: mkdir -p .playwright-mcp

      # Create a persistent plan file for state sharing between steps
      - name: Initialize plan file
        run: echo "# Implementation Plan" > plan.md

      # Step 1: Analysis only - explicitly prevent changes
      - name: Step 1 - Analyze Request and Plan
        id: analyze-and-plan
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --system-prompt "You are an expert Node-RED developer with strong UI/UX design knowledge.

            ## CRITICAL INSTRUCTION: ANALYSIS ONLY - NO CHANGES

            Your ONLY task is to understand the request and create a detailed plan. You MUST NOT make any code changes, file modifications, or implementations in this step.

            ## Step 1: Understand and Create Plan

            1. Read the GitHub issue/comment that triggered this workflow
            2. Explore the Node-RED codebase to understand current implementation
            3. Create a specific implementation plan and SAVE IT TO plan.md:
               - Which specific UI areas/components will be affected
               - What files need to be modified  
               - What the expected visual changes will be (numbered list)
               - Step-by-step implementation approach
            4. Take initial screenshots of areas that will be modified and save them as before-[number].png

            ## Environment
            Node-RED is running on http://localhost:1880

            SAVE YOUR COMPLETE PLAN TO plan.md - this will be read by subsequent steps.

            REMINDER: Do NOT implement anything - only analyze and plan."
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}' 
            --allowedTools mcp__playwright__browser_navigate,mcp__playwright__browser_snapshot,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_wait_for,mcp__playwright__browser_click,mcp__playwright__browser_evaluate,Write,Read

      - name: Detect Branch Created by Step 1
        id: detect-branch
        run: |
          BRANCH=$(git branch --show-current)
          echo "Step 1 created/used branch: $BRANCH"
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "CLAUDE_BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Clean Git State After Step 1
        run: |
          git add -A
          git stash --include-untracked || true
          git clean -fd
        continue-on-error: true

      # Step 2: Implementation based on saved plan
      - name: Step 2 - Implement and Test Changes
        id: implement-changes
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ## Step 2: Implement Changes for GitHub issue #${{ github.event.issue.number || github.event.pull_request.number }}

            You are continuing the work from Step 1 on branch: ${{ env.CLAUDE_BRANCH }}

            You are working on the implementation phase. Follow these steps:

            1. READ the detailed plan from plan.md - this contains the complete implementation strategy created in Step 1
            2. Follow the plan exactly as specified
            3. For frontend changes: run npm run build to rebuild assets
            4. For backend/core changes: restart Node-RED if needed using:
               kill $(cat node-red.pid) && npm start & && echo $! > node-red.pid && sleep 10
            5. Test changes using Playwright to ensure they work correctly

            ## Implementation Guidelines
            - Apply UI/UX best practices ONLY to the specific changes being made
            - Maintain consistency with existing interface patterns  
            - STAY FOCUSED: Only implement what's in the plan
            - Test thoroughly before considering complete

            ## Environment
            - Node-RED is running on http://localhost:1880
            - You are working on branch: ${{ env.CLAUDE_BRANCH }}
            - The plan file contains all the details you need - refer to it throughout implementation

            Begin implementation now.
          claude_args: |
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}' 
            --allowedTools mcp__playwright__browser_close,mcp__playwright__browser_resize,mcp__playwright__browser_console_messages,mcp__playwright__browser_handle_dialog,mcp__playwright__browser_evaluate,mcp__playwright__browser_file_upload,mcp__playwright__browser_fill_form,mcp__playwright__browser_install,mcp__playwright__browser_press_key,mcp__playwright__browser_type,mcp__playwright__browser_navigate,mcp__playwright__browser_navigate_back,mcp__playwright__browser_network_requests,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_snapshot,mcp__playwright__browser_click,mcp__playwright__browser_drag,mcp__playwright__browser_hover,mcp__playwright__browser_select_option,mcp__playwright__browser_tabs,mcp__playwright__browser_wait_for,Read,Write,Edit,MultiEdit,Bash

      - name: Clean Git State After Step 2
        run: |
          git add -A
          git stash --include-untracked || true
          git clean -fd
        continue-on-error: true

      # Step 3: Validation and documentation
      - name: Step 3 - Validate and Document Results
        id: post-comparison
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ## Step 3: Validate and Document for GitHub issue #${{ github.event.issue.number || github.event.pull_request.number }}

            You are completing the final phase on branch: ${{ env.CLAUDE_BRANCH }}

            You are in the final validation and documentation phase. Complete these steps:

            1. READ the plan from plan.md to understand what was supposed to be implemented
            2. Navigate to http://localhost:1880 and verify all changes work correctly, and if not do fixes as needed
            3. Take final screenshots as after-[number].png matching any before screenshots from Step 1
            4. Create a comprehensive before/after comparison comment on the GitHub issue

            ## Environment
            - Node-RED is running on http://localhost:1880
            - You are working on branch: ${{ env.CLAUDE_BRANCH }}
            - Implementation should be complete from Step 2

            Use this markdown format for your GitHub comment:

            ## ðŸŽ¨ Node-RED Interface Implementation Complete

            ### Implementation Plan
            [Include the full plan from plan.md]

            ### Visual Changes
            | Area | Before | After |
            |------|--------|-------|
            | [Area 1] | ![Before](path/to/before-1.png) | ![After](path/to/after-1.png) |
            | [Area 2] | ![Before](path/to/before-2.png) | ![After](path/to/after-2.png) |

            ### Summary
            - âœ… [Change 1 completed]
            - âœ… [Change 2 completed]

            All requested changes have been implemented and tested successfully.

            Begin validation and documentation now.
          claude_args: |
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}'
            --allowedTools mcp__github__add_issue_comment,mcp__github__get_issue,mcp__playwright__browser_navigate,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_snapshot,mcp__playwright__browser_wait_for,mcp__playwright__browser_click,mcp__playwright__browser_evaluate,Read
