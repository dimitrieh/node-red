name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers and dependencies
        run: npx playwright install --with-deps chromium

      - name: Build Node-RED
        run: npm run build

      - name: Start Node-RED in background
        run: |
          npm start &
          echo $! > node-red.pid
          # Wait for Node-RED to start
          sleep 10
          curl -f http://localhost:1880 || (echo "Node-RED failed to start" && exit 1)

      - name: Ensure Playwright MCP directory exists
        run: mkdir -p .playwright-mcp

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Custom prompt for Node-RED development workflow
          prompt: |
            You are an expert Node-RED developer with strong UI/UX design knowledge.

            ## Environment
            Node-RED is already built and running on http://localhost:1880 in this GitHub Actions environment.

            ## Development Workflow
            1. Use Playwright (if possible in subagents) to inspect the running Node-RED instance
            2. Make ONLY the requested changes - do not extend beyond the user's scope
            3. Apply UI/UX best practices ONLY to the specific changes being made while adhering to the existing interface.
            4. Test the specific changes with Playwright and Playwright screenshots
            5. Iterate until requirements are met

            ## Making Changes
            - For frontend changes: run `npm run build` to rebuild assets
            - For backend/core changes: you may need to restart Node-RED entirely
            - ALWAYS take screenshots with Playwright (saved to `.playwright-mcp/` directory automatically)
            - Include final before/after screenshots in your GitHub issue response showing the changes
            - IMPORTANT: Do not extend scope beyond what was requested

            ## UI/UX Principles (Apply only to requested changes)
            When making the specific changes requested, consider: visual hierarchy, color consistency, sufficient contrast, intuitive interactions, accessibility, touch-friendly sizing, performance impact, and adhering to existing design patterns.

            CRITICAL: Stay focused on the user's specific request. Do not redesign or improve other areas of Node-RED unless it is part of the scope that the user asked to change.

          # Configure MCP servers and allowed tools via claude_args
          claude_args: |
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}' 
            --allowed-tools mcp__playwright__browser_close,mcp__playwright__browser_resize,mcp__playwright__browser_console_messages,mcp__playwright__browser_handle_dialog,mcp__playwright__browser_evaluate,mcp__playwright__browser_file_upload,mcp__playwright__browser_fill_form,mcp__playwright__browser_install,mcp__playwright__browser_press_key,mcp__playwright__browser_type,mcp__playwright__browser_navigate,mcp__playwright__browser_navigate_back,mcp__playwright__browser_network_requests,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_snapshot,mcp__playwright__browser_click,mcp__playwright__browser_drag,mcp__playwright__browser_hover,mcp__playwright__browser_select_option,mcp__playwright__browser_tabs,mcp__playwright__browser_wait_for
