name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          sparse-checkout: |
            .gitattributes
            .github/
            .gitignore
            .jshintrc
            API.md
            CHANGELOG.md
            CITATION.cff
            CODE_OF_CONDUCT.md
            CONTRIBUTING.md
            Gruntfile.js
            jsdoc.json
            LICENSE
            nodemon.json
            package.json
            packages/
            README.md
            scripts/
            SECURITY.md
            test/
          sparse-checkout-cone-mode: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers and dependencies
        run: npx playwright install --with-deps chromium

      - name: Build Node-RED
        run: npm run build

      - name: Start Node-RED in background
        run: |
          npm start &
          echo $! > node-red.pid
          # Wait for Node-RED to start
          sleep 10
          curl -f http://localhost:1880 || (echo "Node-RED failed to start" && exit 1)

      - name: Ensure Playwright MCP directory exists
        run: mkdir -p .playwright-mcp

      # Create a persistent plan file for state sharing between steps
      - name: Initialize plan file
        run: echo "# Implementation Plan" > plan.md

      # Step 1: Analysis only - explicitly prevent changes
      - name: Step 1 - Analyze Request and Plan
        id: analyze-and-plan
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --system-prompt "You are an expert Node-RED developer with strong UI/UX design knowledge.

            ## CRITICAL INSTRUCTION: ANALYSIS ONLY - NO CHANGES

            Your ONLY task is to understand the request and create a detailed plan. You MUST NOT make any code changes, file modifications, or implementations in this step.

            ## Step 1: Understand and Create Plan

            1. Read the GitHub issue/comment that triggered this workflow
            2. Explore the Node-RED codebase to understand current implementation
            3. Create a specific implementation plan and SAVE IT TO plan.md:
               - Which specific UI areas/components will be affected
               - What files need to be modified  
               - What the expected visual changes will be (numbered list)
               - Step-by-step implementation approach
            4. Based on the plan, take screenshots of areas that will be modified and save them as before-[number].png

            ## Playwright Analysis Instructions
            - ALWAYS use Playwright in subagents for all browser interactions
            - Navigate to http://localhost:1880 and systematically explore the interface
            - Take before-[number].png screenshots using Playwright's screenshot capability
            - Use Playwright for both functional testing (clicks, interactions) and visual documentation
            - Screenshots automatically save to .playwright-mcp/ directory
            - Test current functionality through browser automation, not just visual inspection

            ## Environment
            Node-RED is running on http://localhost:1880

            SAVE YOUR COMPLETE PLAN TO plan.md - this will be read by subsequent steps.

            REMINDER: Do NOT implement anything - only analyze and plan."
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}' 
            --allowedTools mcp__playwright__browser_close,mcp__playwright__browser_resize,mcp__playwright__browser_console_messages,mcp__playwright__browser_handle_dialog,mcp__playwright__browser_evaluate,mcp__playwright__browser_file_upload,mcp__playwright__browser_fill_form,mcp__playwright__browser_install,mcp__playwright__browser_press_key,mcp__playwright__browser_type,mcp__playwright__browser_navigate,mcp__playwright__browser_navigate_back,mcp__playwright__browser_network_requests,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_snapshot,mcp__playwright__browser_click,mcp__playwright__browser_drag,mcp__playwright__browser_hover,mcp__playwright__browser_select_option,mcp__playwright__browser_tabs,mcp__playwright__browser_wait_for,Write,Read

      - name: Extract Issue Information and Detect Branch
        id: detect-branch
        run: |
          BRANCH=$(git branch --show-current)
          echo "Step 1 created/used branch: $BRANCH"
          echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
          echo "CLAUDE_BRANCH=$BRANCH" >> $GITHUB_ENV
          
          # Extract issue/PR number for folder structure
          ISSUE_NUMBER="${{ github.event.issue.number || github.event.pull_request.number }}"
          echo "ISSUE_ID=$ISSUE_NUMBER" >> $GITHUB_ENV
          echo "Issue/PR Number: $ISSUE_NUMBER"

      - name: Clean Git State After Step 1
        run: |
          git add -A
          git stash --include-untracked || true
          git clean -fd
        continue-on-error: true

      # Step 2: Implementation based on saved plan
      - name: Step 2 - Implement and Test Changes
        id: implement-changes
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ## Step 2: Implement Changes for GitHub issue #${{ github.event.issue.number || github.event.pull_request.number }}

            You are continuing the work from Step 1 on branch: ${{ env.CLAUDE_BRANCH }}

            You are working on the implementation phase with iterative testing and refinement. Follow this process:

            ## Implementation Loop Process
            1. READ the detailed plan from plan.md - this contains the complete implementation strategy created in Step 1
            2. Implement changes based on the plan
            3. For frontend changes: run npm run build to rebuild assets
            4. For backend/core changes: restart Node-RED if needed using:
               kill $(cat node-red.pid) && npm start & && echo $! > node-red.pid && sleep 10
            5. **Test with Playwright and analyze results**
            6. **If testing reveals issues or improvements needed, make additional changes**
            7. **Repeat steps 3-6 until the implementation meets requirements**
            8. Only consider complete when Playwright testing confirms all functionality works correctly

            ## Playwright-Driven Iterative Development
            - ALWAYS use Playwright in subagents for all browser testing and feedback
            - Use Playwright to discover what needs adjustment: UI layout, functionality, user experience
            - Let Playwright testing guide your implementation decisions
            - After each code change, immediately test with Playwright browser automation
            - Use Playwright findings to refine and improve the implementation
            - Take progress screenshots using Playwright's screenshot capability
            - Continue the implement â†’ test â†’ refine cycle until Playwright confirms success
            - Screenshots automatically save to .playwright-mcp/ directory

            ## Key Philosophy: Let Playwright Drive Improvements
            - Don't just implement the plan - let Playwright testing show you what actually works
            - Use browser automation to discover edge cases and usability issues
            - Make iterative improvements based on what you observe through Playwright
            - The plan is your starting point, but Playwright testing should guide refinements

            ## Implementation Guidelines
            - Apply UI/UX best practices based on what Playwright testing reveals
            - Maintain consistency with existing interface patterns  
            - Focus on what the plan specifies, but improve based on testing feedback
            - Don't stop at "good enough" - iterate until Playwright confirms excellence

            ## Environment
            - Node-RED is running on http://localhost:1880
            - You are working on branch: ${{ env.CLAUDE_BRANCH }}
            - The plan file contains your starting strategy - use it with Playwright feedback

            Begin iterative implementation now.
          claude_args: |
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}' 
            --allowedTools mcp__playwright__browser_close,mcp__playwright__browser_resize,mcp__playwright__browser_console_messages,mcp__playwright__browser_handle_dialog,mcp__playwright__browser_evaluate,mcp__playwright__browser_file_upload,mcp__playwright__browser_fill_form,mcp__playwright__browser_install,mcp__playwright__browser_press_key,mcp__playwright__browser_type,mcp__playwright__browser_navigate,mcp__playwright__browser_navigate_back,mcp__playwright__browser_network_requests,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_snapshot,mcp__playwright__browser_click,mcp__playwright__browser_drag,mcp__playwright__browser_hover,mcp__playwright__browser_select_option,mcp__playwright__browser_tabs,mcp__playwright__browser_wait_for,Read,Write,Edit,MultiEdit,Bash

      - name: Clean Git State After Step 2
        run: |
          git add -A
          git stash --include-untracked || true
          git clean -fd
        continue-on-error: true

      # Step 3: Validation and documentation
      - name: Step 3 - Validate and Document Results
        id: post-comparison
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ## Step 3: Validate and Document for GitHub issue #${{ github.event.issue.number || github.event.pull_request.number }}

            You are completing the final phase on branch: ${{ env.CLAUDE_BRANCH }}

            You are in the final validation and documentation phase. Complete these steps:

            1. READ the plan from plan.md to understand what was supposed to be implemented
            2. Understand changes made for plan
            3. Take final screenshots as after-[number].png matching any before screenshots from Step 1

            ## Playwright Validation Protocol
            - ALWAYS use Playwright in subagents for comprehensive testing
            - Use Playwright for comprehensive functional testing of all changes
            - Take after-[number].png screenshots using Playwright's screenshot capability
            - Test all modified functionality through Playwright browser automation
            - Navigate systematically through every changed UI area
            - Verify both visual appearance and functional behavior with Playwright
            - Include before/after Playwright screenshots in GitHub issue response
            - Verify screenshots are properly saved to .playwright-mcp/ directory

            ## Environment
            - Node-RED is running on http://localhost:1880
            - You are working on branch: ${{ env.CLAUDE_BRANCH }}
            - Implementation should be complete from Step 2

            Use this markdown format for your GitHub comment:

            ## ðŸŽ¨ Node-RED Interface Implementation Complete

            ### Implementation Plan
            [Include the full plan from plan.md]

            ### Visual Changes
            | Area | Before | After |
            |------|--------|-------|
            | [Area 1] | ![Before](path/to/before-1.png) | ![After](path/to/after-1.png) |
            | [Area 2] | ![Before](path/to/before-2.png) | ![After](path/to/after-2.png) |

            ### Summary
            - âœ… [Change 1 completed]
            - âœ… [Change 2 completed]

            All requested changes have been implemented and tested successfully.

            Begin validation now.
          claude_args: |
            --mcp-config '{"mcpServers":{"playwright":{"command":"npx","args":["@playwright/mcp@latest","--headless"]}}}'
            --allowedTools mcp__playwright__browser_close,mcp__playwright__browser_resize,mcp__playwright__browser_console_messages,mcp__playwright__browser_handle_dialog,mcp__playwright__browser_evaluate,mcp__playwright__browser_file_upload,mcp__playwright__browser_fill_form,mcp__playwright__browser_install,mcp__playwright__browser_press_key,mcp__playwright__browser_type,mcp__playwright__browser_navigate,mcp__playwright__browser_navigate_back,mcp__playwright__browser_network_requests,mcp__playwright__browser_take_screenshot,mcp__playwright__browser_snapshot,mcp__playwright__browser_click,mcp__playwright__browser_drag,mcp__playwright__browser_hover,mcp__playwright__browser_select_option,mcp__playwright__browser_tabs,mcp__playwright__browser_wait_for,Read,Write

      # Archive screenshots with issue and commit hash
      - name: Archive Screenshots to Issue/Commit Folder
        if: always() && steps.post-comparison.conclusion != 'skipped'
        run: |
          # Get the last commit hash
          COMMIT_HASH=$(git rev-parse HEAD)
          SCREENSHOT_DIR="${{ env.ISSUE_ID }}/${COMMIT_HASH}"
          
          # Create directory with issue/commit structure
          mkdir -p "$SCREENSHOT_DIR"
          
          # Copy only before-*.png and after-*.png screenshots to commit folder
          if [ -d ".playwright-mcp" ]; then
            # Use bash arrays to safely handle files that may or may not exist
            shopt -s nullglob  # Make glob patterns expand to nothing if no matches
            for file in .playwright-mcp/before-*.png; do
              [ -f "$file" ] && cp "$file" "$SCREENSHOT_DIR/"
            done
            for file in .playwright-mcp/after-*.png; do
              [ -f "$file" ] && cp "$file" "$SCREENSHOT_DIR/"
            done
            shopt -u nullglob  # Reset nullglob
          fi
          
          # Create metadata file for GitHub Pages workflow
          cat > "$SCREENSHOT_DIR/metadata.json" << EOF
{
  "issue_number": "${{ env.ISSUE_ID }}",
  "commit_hash": "$COMMIT_HASH",
  "repository_owner": "${{ github.repository_owner }}",
  "repository_name": "${{ github.event.repository.name }}",
  "event_type": "${{ github.event_name }}",
  "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
EOF
          
          # Save paths for later use
          echo "$COMMIT_HASH" > current_commit.txt
          echo "$SCREENSHOT_DIR" > screenshot_dir.txt
          
          # Stash the screenshot directory
          git add "$SCREENSHOT_DIR"
          git stash push -m "Screenshots for issue #${{ env.ISSUE_ID }}, commit $COMMIT_HASH" -- "$SCREENSHOT_DIR"

      # Push screenshots to gh-pages branch
      - name: Deploy Screenshots to gh-pages
        if: always() && steps.post-comparison.conclusion != 'skipped'
        run: |
          # Fetch and checkout gh-pages branch
          git fetch origin gh-pages:gh-pages || git checkout --orphan gh-pages
          git checkout gh-pages
          
          # Apply the stashed screenshots
          git stash pop || true
          
          # Commit and push with metadata
          COMMIT_HASH=$(cat current_commit.txt 2>/dev/null || echo "unknown")
          git add .
          git commit -m "Add screenshots for issue #${{ env.ISSUE_ID }}, commit ${COMMIT_HASH:0:7}

Metadata:
- Issue/PR: #${{ env.ISSUE_ID }}
- Commit: $COMMIT_HASH
- Event: ${{ github.event_name }}
- Folder: ${{ env.ISSUE_ID }}/$COMMIT_HASH" || true
          git push origin gh-pages
          
          # Go back to original branch
          git checkout "${{ env.CLAUDE_BRANCH }}"

